@{
    ViewData["Title"] = "Login";
    Layout = "_LoginLayout";
}

<div class="login-card">
    <div class="login-card-header">
        <h2 class="login-card-title">Welcome Back</h2>
        <p class="login-card-subtitle">Sign in to continue to ChatApp</p>
    </div>

    <div class="login-card-body">
        <form id="loginForm" novalidate>
            <div class="login-form-group">
                <label class="login-label" for="loginEmail">Email</label>
                <div class="login-input-wrapper">
                    <span class="login-input-icon">
                        <span class="material-icons" style="font-size:18px;">person</span>
                    </span>
                    <input type="text"
                           id="loginEmail"
                           class="login-input"
                           placeholder="Enter your email address"
                           autocomplete="email"
                           required />
                </div>
                <div class="login-validation-message" id="emailError"></div>
            </div>

            <div class="login-form-group">
                <label class="login-label" for="loginPassword">Password</label>
                <div class="login-input-wrapper">
                    <span class="login-input-icon">
                        <span class="material-icons" style="font-size:18px;">lock</span>
                    </span>
                    <input type="password"
                           id="loginPassword"
                           class="login-input"
                           placeholder="Enter your password"
                           autocomplete="current-password"
                           required />
                    <button type="button" class="login-input-toggle" id="togglePassword" tabindex="-1">
                        <span class="material-icons" style="font-size:18px;">visibility</span>
                    </button>
                </div>
                <div class="login-validation-message" id="passwordError"></div>
            </div>

            <div class="login-form-options">
                <label class="login-checkbox">
                    <input type="checkbox" id="rememberMe" />
                    <span>Remember me</span>
                </label>
            </div>

            <div class="login-error" id="loginError" style="display:none;">
                <span class="material-icons" style="font-size:18px;">error</span>
                <span id="loginErrorText"></span>
            </div>

            <button type="submit" class="login-button" id="loginButton">
                <span id="loginBtnText">Sign In</span>
                <span class="login-button-spinner" id="loginSpinner" style="display:none;"></span>
                <span id="loginBtnLoadingText" style="display:none;">Signing in...</span>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('loginForm');
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const rememberMe = document.getElementById('rememberMe');
            const togglePassword = document.getElementById('togglePassword');
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            const loginErrorText = document.getElementById('loginErrorText');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginBtnLoadingText = document.getElementById('loginBtnLoadingText');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');

            // Load remembered email
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMe.checked = true;
            }

            // Toggle password visibility
            togglePassword.addEventListener('click', function () {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                togglePassword.querySelector('.material-icons').textContent =
                    isPassword ? 'visibility_off' : 'visibility';
            });

            // Clear errors on input
            emailInput.addEventListener('input', clearErrors);
            passwordInput.addEventListener('input', clearErrors);

            function clearErrors() {
                loginError.style.display = 'none';
                emailError.textContent = '';
                passwordError.textContent = '';
            }

            function setLoading(loading) {
                loginButton.disabled = loading;
                loginBtnText.style.display = loading ? 'none' : '';
                loginSpinner.style.display = loading ? '' : 'none';
                loginBtnLoadingText.style.display = loading ? '' : 'none';
            }

            function validate() {
                let valid = true;
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                // Email validation
                if (!email) {
                    emailError.textContent = 'Email is required';
                    valid = false;
                } else if (!/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email)) {
                    emailError.textContent = 'Please enter a valid email address';
                    valid = false;
                }

                // Password validation (matches Blazor LoginRequest: 8+ chars, 1 upper, 1 lower, 1 digit, 1 special)
                if (!password) {
                    passwordError.textContent = 'Password is required';
                    valid = false;
                } else if (password.length < 8) {
                    passwordError.textContent = 'Password must be at least 8 characters';
                    valid = false;
                } else if (!/[A-Z]/.test(password)) {
                    passwordError.textContent = 'Password must contain at least one uppercase letter';
                    valid = false;
                } else if (!/[a-z]/.test(password)) {
                    passwordError.textContent = 'Password must contain at least one lowercase letter';
                    valid = false;
                } else if (!/\d/.test(password)) {
                    passwordError.textContent = 'Password must contain at least one digit';
                    valid = false;
                } else if (!/[^A-Za-z0-9]/.test(password)) {
                    passwordError.textContent = 'Password must contain at least one special character';
                    valid = false;
                }

                return valid;
            }

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                clearErrors();
                if (!validate()) return;

                setLoading(true);
                try {
                    const response = await fetch(ChatApp.apiBase + '/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            email: emailInput.value.trim(),
                            password: passwordInput.value,
                            rememberMe: rememberMe.checked
                        })
                    });

                    if (response.ok) {
                        // Save or clear remembered email
                        if (rememberMe.checked) {
                            localStorage.setItem('rememberedEmail', emailInput.value.trim());
                        } else {
                            localStorage.removeItem('rememberedEmail');
                        }
                        window.location.href = '/';
                    } else {
                        let errorMsg = 'Invalid email or password. Please try again.';
                        try {
                            const data = await response.json();
                            if (data.error) errorMsg = data.error;
                            else if (data.message) errorMsg = data.message;
                        } catch { }
                        loginErrorText.textContent = errorMsg;
                        loginError.style.display = '';
                    }
                } catch {
                    loginErrorText.textContent = 'An error occurred during login. Please try again.';
                    loginError.style.display = '';
                } finally {
                    setLoading(false);
                }
            });
        })();
    </script>
}