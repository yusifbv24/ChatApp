@{
    ViewData["Title"] = "Messages";
}

<div class="messages-page" id="messagesPage">
    <!-- ===== CONVERSATION LIST (Left Panel) ===== -->
    <div class="conversation-list-panel" id="conversationListPanel">
        <!-- Toolbar -->
        <div class="message-toolbar">
            <div class="message-toolbar-left">
                <h2 class="message-toolbar-title">Messages</h2>
            </div>
            <div class="message-toolbar-right">
                <button class="toolbar-icon-btn" id="searchToggleBtn" title="Search">
                    <span class="material-icons">search</span>
                </button>
                <div class="filter-dropdown-wrapper">
                    <button class="toolbar-icon-btn" id="filterBtn" title="Filter">
                        <span class="material-icons">filter_list</span>
                    </button>
                    <div class="filter-dropdown-menu" id="filterMenu" style="display:none;">
                        <button class="filter-item active" data-filter="all">
                            <span class="material-icons" style="font-size:18px;">forum</span>
                            <span>All</span>
                        </button>
                        <button class="filter-item" data-filter="unread">
                            <span class="material-icons" style="font-size:18px;">mark_email_unread</span>
                            <span>Unread</span>
                        </button>
                        <button class="filter-item" data-filter="pinned">
                            <span class="material-icons" style="font-size:18px;">push_pin</span>
                            <span>Pinned</span>
                        </button>
                        <button class="filter-item" data-filter="muted">
                            <span class="material-icons" style="font-size:18px;">volume_off</span>
                            <span>Muted</span>
                        </button>
                        <button class="filter-item" data-filter="readLater">
                            <span class="material-icons" style="font-size:18px;">schedule</span>
                            <span>Read Later</span>
                        </button>
                    </div>
                </div>
                <button class="toolbar-icon-btn" id="newChannelBtn" title="New Channel">
                    <span class="material-icons">group_add</span>
                </button>
            </div>
        </div>

        <!-- Search mode input -->
        <div class="conv-search-container" id="convSearchContainer" style="display:none;">
            <div class="conv-search-input-wrapper">
                <span class="material-icons conv-search-icon">search</span>
                <input type="text" class="conv-search-input" id="convSearchInput"
                       placeholder="Search users and channels..." autocomplete="off" />
                <button class="conv-search-close" id="convSearchClose">
                    <span class="material-icons" style="font-size:18px;">close</span>
                </button>
            </div>
        </div>

        <!-- Conversation list -->
        <div class="conversation-list" id="conversationList">
            <div class="conversation-list-loading" id="convListLoading">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
            <!-- Conversations will be rendered here by JS -->
        </div>
    </div>

    <!-- ===== CHAT AREA (Center) ===== -->
    <div class="chat-area-panel" id="chatAreaPanel">
        <!-- No conversation selected state -->
        <div class="chat-empty-state" id="chatEmptyState">
            <span class="material-icons-outlined" style="font-size:80px; color:rgba(0,0,0,0.1);">chat</span>
            <h3>Select a conversation</h3>
            <p>Choose a conversation from the list to start messaging</p>
        </div>

        <!-- Create Group Panel (replaces chat area when active) -->
        <div class="create-group-panel" id="createGroupPanel" style="display:none;">
            <div class="create-group-content">
                <!-- Header Section: Avatar + Name -->
                <div class="create-group-header-section">
                    <label class="create-group-avatar" id="groupAvatarLabel" for="groupAvatarInput">
                        <span class="material-icons" id="groupAvatarIcon">camera_alt</span>
                        <img class="group-avatar-preview" id="groupAvatarPreview" style="display:none;" />
                        <div class="avatar-overlay" id="groupAvatarOverlay" style="display:none;">
                            <span class="material-icons" style="font-size:16px;">camera_alt</span>
                        </div>
                    </label>
                    <input type="file" id="groupAvatarInput" accept="image/*" style="display:none;" />
                    <div class="create-group-name-input">
                        <input type="text" class="group-name-field" id="groupNameInput" placeholder="Enter chat name" maxlength="100" />
                        <span class="char-counter" id="groupNameCounter">0/100</span>
                    </div>
                </div>

                <!-- Members Section -->
                <div class="create-group-members-section">
                    <label class="members-label">
                        <span class="members-title">Members</span>
                        <span class="members-hint">(add a person or a department)</span>
                    </label>
                    <div class="members-input-container" id="membersInputContainer">
                        <!-- Creator chip (non-removable) -->
                        <div class="selected-member-chip creator-chip" id="creatorChip">
                            <div class="chip-avatar-placeholder" id="creatorChipAvatar">
                                <span class="material-icons creator-icon" style="font-size:14px;">person</span>
                            </div>
                            <span class="chip-name" id="creatorChipName"></span>
                        </div>
                        <!-- Selected member chips will be inserted here -->
                        <div id="memberChipsContainer"></div>
                        <!-- Add button / search input -->
                        <button class="add-member-trigger" id="addMemberTrigger">+ Add</button>
                        <input type="text" class="inline-member-search" id="inlineMemberSearch" style="display:none;" placeholder="Search..." />
                    </div>

                    <!-- Member picker dropdown -->
                    <div class="member-picker-dropdown" id="memberPickerDropdown" style="display:none;">
                        <div class="picker-header">
                            <div class="picker-tabs">
                                <button class="picker-tab active" id="pickerTabRecent" data-tab="recent">
                                    <span class="material-icons" style="font-size:16px;">search</span> Recent
                                </button>
                                <button class="picker-tab" id="pickerTabDepts" data-tab="departments">
                                    <span class="material-icons" style="font-size:16px;">business</span> Departments
                                </button>
                            </div>
                            <button class="picker-close-btn" id="pickerCloseBtn">
                                <span class="material-icons" style="font-size:16px;">close</span>
                            </button>
                        </div>
                        <div class="picker-content" id="pickerContent">
                            <div class="picker-hint">Type to search users...</div>
                        </div>
                    </div>
                </div>

                <!-- Chat Settings Section (Collapsible) -->
                <div class="create-group-settings-section">
                    <div class="settings-header" id="settingsToggle">
                        <span class="material-icons" style="font-size:18px;">settings</span>
                        <span class="settings-title">Chat settings</span>
                        <span class="material-icons settings-expand-icon" id="settingsExpandIcon">expand_more</span>
                    </div>
                    <div class="settings-content" id="settingsContent" style="display:none;">
                        <div class="settings-group">
                            <label class="settings-label">Chat type</label>
                            <div class="chat-type-options">
                                <label class="chat-type-option">
                                    <input type="radio" name="chatType" value="1" checked />
                                    <div class="option-content">
                                        <span class="option-title">Private</span>
                                        <span class="option-description">This chat will not be visible in the chat list. Chat members can only be added manually.</span>
                                    </div>
                                </label>
                                <label class="chat-type-option">
                                    <input type="radio" name="chatType" value="0" />
                                    <div class="option-content">
                                        <span class="option-title">Public</span>
                                        <span class="option-description">This chat is visible to everyone. Anyone can join.</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="settings-label-row">
                                <label class="settings-label">Description</label>
                                <span class="char-counter" id="groupDescCounter">0/500</span>
                            </div>
                            <textarea class="description-textarea" id="groupDescInput" placeholder="Enter chat description" maxlength="500" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixed Footer -->
            <div class="create-group-footer">
                <button class="btn-create-chat" id="createGroupSubmit" disabled>CREATE CHAT</button>
                <button class="btn-cancel-chat" id="createGroupCancel">CANCEL</button>
            </div>
        </div>

        <!-- Chat content (hidden until conversation selected) -->
        <div class="chat-content" id="chatContent" style="display:none;">
            <!-- Chat Header -->
            <div class="chat-header" id="chatHeader">
                <button class="chat-back-btn" id="chatBackBtn" title="Back" style="display:none;">
                    <span class="material-icons">arrow_back</span>
                </button>
                <div class="chat-header-info" id="chatHeaderInfo">
                    <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
                    <div class="chat-header-details">
                        <div class="chat-header-name" id="chatHeaderName"></div>
                        <div class="chat-header-status" id="chatHeaderStatus"></div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="toolbar-icon-btn" id="chatSearchBtn" title="Search in conversation">
                        <span class="material-icons">search</span>
                    </button>
                    <button class="toolbar-icon-btn" id="chatSidebarBtn" title="Conversation info">
                        <span class="material-icons">info_outline</span>
                    </button>
                </div>
            </div>

            <!-- Pinned messages bar -->
            <div class="pinned-messages-bar" id="pinnedBar" style="display:none;">
                <span class="material-icons" style="font-size:18px;">push_pin</span>
                <span id="pinnedBarText">Pinned messages</span>
                <button class="pinned-bar-toggle" id="pinnedBarToggle">
                    <span class="material-icons" style="font-size:18px;">expand_more</span>
                </button>
                <div class="pinned-messages-dropdown" id="pinnedDropdown" style="display:none;">
                    <!-- Pinned messages rendered by JS -->
                </div>
            </div>

            <!-- Messages container -->
            <div class="messages-container" id="messagesContainer">
                <div class="messages-loading" id="messagesLoading" style="display:none;">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                </div>
                <div class="messages-list" id="messagesList">
                    <!-- Messages will be rendered here by JS -->
                </div>
                <div class="new-messages-indicator" id="newMsgIndicator" style="display:none;">
                    <button id="newMsgIndicatorBtn">
                        <span class="material-icons" style="font-size:16px;">keyboard_arrow_down</span>
                        <span>New messages</span>
                    </button>
                </div>
            </div>

            <!-- Join channel banner -->
            <div class="join-channel-banner" id="joinChannelBanner" style="display:none;">
                <span>You need to join this channel to send messages</span>
                <button class="btn btn-sm btn-primary" id="joinChannelBtn">Join Channel</button>
            </div>

            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator" style="display:none;">
                <span class="typing-name" id="typingName"></span>
                <span class="typing-dots">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </span>
            </div>

            <!-- Selection toolbar -->
            <div class="selection-toolbar" id="selectionToolbar" style="display:none;">
                <div class="selection-info">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="selection-actions">
                    <button class="selection-btn" id="selForwardBtn" title="Forward">
                        <span class="material-icons">forward</span>
                    </button>
                    <button class="selection-btn" id="selDeleteBtn" title="Delete">
                        <span class="material-icons">delete</span>
                    </button>
                    <button class="selection-btn" id="selCancelBtn" title="Cancel">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container" id="messageInputContainer">
                <!-- Reply/Edit preview -->
                <div class="input-reply-preview" id="inputReplyPreview" style="display:none;">
                    <div class="reply-preview-content">
                        <span class="material-icons reply-preview-icon" id="replyPreviewIcon">reply</span>
                        <div class="reply-preview-info">
                            <div class="reply-preview-name" id="replyPreviewName"></div>
                            <div class="reply-preview-text" id="replyPreviewText"></div>
                        </div>
                    </div>
                    <button class="reply-preview-close" id="replyPreviewClose">
                        <span class="material-icons" style="font-size:18px;">close</span>
                    </button>
                </div>

                <!-- File selection panel -->
                <div class="file-selection-panel" id="fileSelectionPanel" style="display:none;">
                    <div class="file-selection-header">
                        <span>Selected files</span>
                        <button class="file-selection-close" id="fileSelectionClose">
                            <span class="material-icons" style="font-size:18px;">close</span>
                        </button>
                    </div>
                    <div class="file-validation-error" id="fileValidationError" style="display:none;"></div>
                    <div class="file-selection-list" id="fileSelectionList">
                        <!-- File items rendered by JS -->
                    </div>
                    <div class="file-selection-footer">
                        <textarea class="file-message-input" id="fileMessageInput"
                                  placeholder="Add a message..." rows="1"></textarea>
                        <button class="btn btn-primary btn-sm" id="fileSendBtn">
                            <span class="material-icons" style="font-size:18px;">send</span>
                            Send
                        </button>
                    </div>
                </div>

                <!-- Input row -->
                <div class="input-row">
                    <button class="input-action-btn" id="attachBtn" title="Attach file">
                        <span class="material-icons">attach_file</span>
                    </button>
                    <input type="file" id="fileInput" multiple style="display:none;" />
                    <div class="input-textarea-wrapper">
                        <textarea class="message-textarea" id="messageTextarea"
                                  placeholder="Write a message..." rows="1" maxlength="4000"></textarea>
                        <div class="message-char-counter" id="charCounter" style="display:none;">
                            <span id="charCountText">0/4000</span>
                        </div>
                        <!-- Mention panel -->
                        <div class="mention-panel" id="mentionPanel" style="display:none;">
                            <div class="mention-list" id="mentionList">
                                <!-- Mention items rendered by JS -->
                            </div>
                        </div>
                    </div>
                    <button class="input-action-btn emoji-btn" id="emojiBtn" title="Emoji">
                        <span class="material-icons">sentiment_satisfied_alt</span>
                    </button>
                    <button class="input-send-btn" id="sendBtn" title="Send">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== RIGHT PANEL (Sidebar / Search) ===== -->
    <div class="right-panel" id="rightPanel" style="display:none;">
        <!-- Sidebar tab content -->
        <div class="sidebar-panel" id="sidebarPanel" style="display:none;">
            <div class="sidebar-header">
                <span class="sidebar-title" id="sidebarTitle">Info</span>
                <button class="toolbar-icon-btn" id="sidebarCloseBtn">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <!-- Sidebar content rendered by JS -->
            </div>
        </div>

        <!-- Search panel -->
        <div class="search-panel" id="searchPanel" style="display:none;">
            <div class="search-panel-header">
                <span class="sidebar-title">Search Messages</span>
                <button class="toolbar-icon-btn" id="searchPanelCloseBtn">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="search-panel-input-wrapper">
                <span class="material-icons search-panel-icon">search</span>
                <input type="text" class="search-panel-input" id="searchPanelInput"
                       placeholder="Search in conversation..." autocomplete="off" />
            </div>
            <div class="search-panel-results" id="searchPanelResults">
                <!-- Search results rendered by JS -->
            </div>
        </div>
    </div>
</div>

<!-- ===== Message bubble template (cloned by JS) ===== -->
<template id="messageBubbleTemplate">
    <div class="message-bubble-wrapper">
        <div class="message-selection-checkbox" style="display:none;">
            <input type="checkbox" class="msg-checkbox" />
        </div>
        <div class="message-avatar-col"></div>
        <div class="message-content-col">
            <div class="message-sender-row">
                <span class="message-sender-name"></span>
                <span class="message-time"></span>
            </div>
            <div class="message-reply-preview" style="display:none;"></div>
            <div class="message-bubble">
                <div class="message-text"></div>
                <div class="message-files" style="display:none;"></div>
                <div class="message-link-previews" style="display:none;"></div>
                <div class="message-status-row">
                    <span class="message-edited-label" style="display:none;">edited</span>
                    <span class="message-status-icon"></span>
                </div>
            </div>
            <div class="message-reactions" style="display:none;"></div>
        </div>
        <div class="message-actions-col">
            <div class="chevron-menu" style="display:none;">
                <button class="chevron-btn">
                    <span class="material-icons" style="font-size:18px;">more_vert</span>
                </button>
                <div class="chevron-dropdown" style="display:none;">
                    <button class="chevron-item" data-action="reply">
                        <span class="material-icons">reply</span> Reply
                    </button>
                    <button class="chevron-item" data-action="forward">
                        <span class="material-icons">forward</span> Forward
                    </button>
                    <button class="chevron-item" data-action="edit">
                        <span class="material-icons">edit</span> Edit
                    </button>
                    <button class="chevron-item" data-action="pin">
                        <span class="material-icons">push_pin</span> Pin
                    </button>
                    <button class="chevron-item" data-action="favorite">
                        <span class="material-icons">star_outline</span> Favorite
                    </button>
                    <button class="chevron-item" data-action="later">
                        <span class="material-icons">schedule</span> Read Later
                    </button>
                    <button class="chevron-item" data-action="select">
                        <span class="material-icons">check_box</span> Select
                    </button>
                    <div class="chevron-divider"></div>
                    <button class="chevron-item danger" data-action="delete">
                        <span class="material-icons">delete</span> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- ===== Forward dialog ===== -->
<div class="modal fade" id="forwardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Forward Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control form-control-sm mb-2" id="forwardSearch"
                       placeholder="Search conversations..." />
                <div class="forward-list" id="forwardList">
                    <!-- Forward targets rendered by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== Add Member Modal ===== -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="addMemberSearch" placeholder="Search users...">
                <div id="addMemberResults" style="max-height:300px;overflow-y:auto;"></div>
                <div class="mt-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="addMemberRole">
                        <option value="member">Member</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addMemberConfirmBtn">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Emoji Picker ===== -->
<div class="emoji-picker-panel" id="emojiPicker" style="display:none;">
    <div class="emoji-search-wrapper">
        <input type="text" class="emoji-search-input" id="emojiSearchInput" placeholder="Search emoji..." />
    </div>
    <div class="emoji-tabs" id="emojiTabs">
        <button class="emoji-tab active" data-category="smileys" title="Smileys">üòÄ</button>
        <button class="emoji-tab" data-category="people" title="People">üëã</button>
        <button class="emoji-tab" data-category="nature" title="Nature">üåø</button>
        <button class="emoji-tab" data-category="food" title="Food">üçï</button>
        <button class="emoji-tab" data-category="activities" title="Activities">‚öΩ</button>
        <button class="emoji-tab" data-category="objects" title="Objects">üí°</button>
    </div>
    <div class="emoji-grid" id="emojiGrid">
        <!-- Emoji items rendered by JS -->
    </div>
</div>

<!-- ===== Image Lightbox ===== -->
<div class="image-lightbox-overlay" id="imageLightbox" style="display:none;">
    <div class="lightbox-header">
        <span class="lightbox-filename" id="lightboxFilename"></span>
        <div class="lightbox-actions">
            <button class="lightbox-btn" id="lightboxDownload" title="Download">
                <span class="material-icons">download</span>
            </button>
            <button class="lightbox-btn" id="lightboxClose" title="Close">
                <span class="material-icons">close</span>
            </button>
        </div>
    </div>
    <div class="lightbox-body">
        <img id="lightboxImage" />
    </div>
</div>

@section Scripts {
    <!-- Feature JS -->
    <script src="~/js/features/create-group.js" asp-append-version="true"></script>
    <script src="~/js/features/conversation-list.js" asp-append-version="true"></script>
    <script src="~/js/features/chat-area.js" asp-append-version="true"></script>
    <script src="~/js/features/messages.js" asp-append-version="true"></script>
    <script src="~/js/features/message-input.js" asp-append-version="true"></script>
    <script src="~/js/features/mention.js" asp-append-version="true"></script>
    <script src="~/js/features/file-upload.js" asp-append-version="true"></script>
    <script src="~/js/features/search.js" asp-append-version="true"></script>
    <script src="~/js/features/sidebar.js" asp-append-version="true"></script>
    <script src="~/js/features/forwarding.js" asp-append-version="true"></script>
    <script src="~/js/features/selection.js" asp-append-version="true"></script>
}