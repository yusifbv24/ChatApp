/**
 * Chat Area â€” replaces ChatArea.razor + scroll management from app.js
 * Handles message display, scroll management, pagination, date separators
 */
(function () {
    'use strict';

    const chatContent = document.getElementById('chatContent');
    const chatEmptyState = document.getElementById('chatEmptyState');
    const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
    const chatHeaderName = document.getElementById('chatHeaderName');
    const chatHeaderStatus = document.getElementById('chatHeaderStatus');
    const messagesContainer = document.getElementById('messagesContainer');
    const messagesList = document.getElementById('messagesList');
    const messagesLoading = document.getElementById('messagesLoading');
    const newMsgIndicator = document.getElementById('newMsgIndicator');
    const newMsgIndicatorBtn = document.getElementById('newMsgIndicatorBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingName = document.getElementById('typingName');
    const pinnedBar = document.getElementById('pinnedBar');
    const pinnedBarText = document.getElementById('pinnedBarText');
    const pinnedBarToggle = document.getElementById('pinnedBarToggle');
    const pinnedDropdown = document.getElementById('pinnedDropdown');
    const joinChannelBanner = document.getElementById('joinChannelBanner');
    const joinChannelBtn = document.getElementById('joinChannelBtn');
    const chatSearchBtn = document.getElementById('chatSearchBtn');
    const chatSidebarBtn = document.getElementById('chatSidebarBtn');
    const chatBackBtn = document.getElementById('chatBackBtn');
    const template = document.getElementById('messageBubbleTemplate');

    if (!messagesList) return;

    let _messages = [];
    let _currentConvId = null;
    let _currentConvType = null;
    let _currentConv = null;
    let _isLoading = false;
    let _hasOlderMessages = true;
    let _hasNewerMessages = false;
    let _oldestPage = 1;
    let _pageSize = 40;
    let _isNearBottom = true;
    let _savedScrollHeight = 0;
    let _typingUsers = {};
    let _typingTimer = null;
    let _pinnedMessages = [];
    let _isMember = true;
    let _myChannelRole = null;
    let _newMsgCount = 0;
    let _pendingMessageIds = new Set();
    let _processedMessageIds = new Set();
    let _scrollPositions = {};

    // --- Listen for conversation selection ---
    ChatApp.state.on('conversationSelected', function (data) {
        openConversation(data.id, data.type, data.conv);
    });

    async function openConversation(convId, type, conv) {
        if (_currentConvId === convId) return;

        // Save scroll position for current conversation
        if (_currentConvId && messagesContainer) {
            _scrollPositions[_currentConvId] = messagesContainer.scrollTop;
        }

        // Leave previous groups
        if (_currentConvId) {
            if (_currentConvType === 'channel') {
                ChatApp.signalR.leaveChannel(_currentConvId);
            } else {
                ChatApp.signalR.leaveConversation(_currentConvId);
            }
        }

        _currentConvId = convId;
        _currentConvType = type;
        _currentConv = conv;
        _messages = [];
        _hasOlderMessages = true;
        _hasNewerMessages = false;
        _oldestPage = 1;
        _pinnedMessages = [];
        _typingUsers = {};
        _myChannelRole = null;
        _newMsgCount = 0;

        // Show chat area
        chatEmptyState.style.display = 'none';
        chatContent.style.display = '';

        // Update header
        updateHeader(conv);

        // Clear messages
        messagesList.innerHTML = '';
        showMessagesLoading();

        // Join SignalR group
        if (type === 'channel') {
            await ChatApp.signalR.joinChannel(convId);
        } else {
            await ChatApp.signalR.joinConversation(convId);
        }

        // Load messages
        await loadMessages();

        // Load pinned messages
        await loadPinnedMessages();

        // Check membership (channel only)
        if (type === 'channel') {
            await checkMembership();
        } else {
            _isMember = true;
            joinChannelBanner.style.display = 'none';
        }

        // Restore saved scroll position or scroll to bottom
        if (_scrollPositions[convId] !== undefined) {
            requestAnimationFrame(function () {
                messagesContainer.scrollTop = _scrollPositions[convId];
            });
        } else {
            scrollToBottom(false);
        }

        // Mark as read
        markAsRead();
    }

    function updateHeader(conv) {
        if (!conv) return;
        const isChannel = _currentConvType === 'channel';
        const currentUserId = ChatApp.state.currentUser ? ChatApp.state.currentUser.id : null;
        const isNotes = !isChannel && conv.otherUserId && conv.otherUserId === currentUserId;
        const name = isNotes ? 'Notes' : (isChannel ? (conv.name || conv.channelName || '') : (conv.otherUserFullName || conv.displayName || ''));
        const avatarId = isChannel ? conv.id : (conv.otherUserId || conv.id);

        if (isNotes) {
            // Notes (self-chat) â€” show bookmark icon
            chatHeaderAvatar.innerHTML = '<div class="conv-channel-icon" style="background-color:' +
                ChatApp.utils.getAvatarColor(avatarId) + ';width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">' +
                '<span class="material-icons" style="font-size:18px;color:#fff;">bookmark</span></div>';
        } else if (isChannel) {
            chatHeaderAvatar.innerHTML = '<div class="conv-channel-icon" style="background-color:' +
                ChatApp.utils.getAvatarColor(avatarId) + ';width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">' +
                '<span class="material-icons" style="font-size:18px;color:#fff;">' +
                (conv.channelType === 1 ? 'lock' : 'tag') + '</span></div>';
        } else {
            chatHeaderAvatar.innerHTML = ChatApp.utils.renderAvatar(
                { id: avatarId, avatarUrl: conv.otherUserAvatarUrl, fullName: name }, 'chat-header-avatar-img');
        }

        chatHeaderName.textContent = name;

        // Mute icon
        if (conv.isMuted) {
            chatHeaderName.innerHTML += ' <span class="material-icons" style="font-size:14px;color:var(--text-secondary);vertical-align:middle;">volume_off</span>';
        }

        if (isNotes) {
            // Notes: hide online status and typing indicator
            chatHeaderStatus.textContent = '';
            chatHeaderStatus.className = 'chat-header-status';
            if (typingIndicator) typingIndicator.style.display = 'none';
        } else if (isChannel) {
            chatHeaderStatus.textContent = (conv.memberCount || 0) + ' members';
        } else if (conv.otherUserId && ChatApp.state.isUserOnline(conv.otherUserId)) {
            chatHeaderStatus.textContent = 'Online';
            chatHeaderStatus.className = 'chat-header-status online';
        } else {
            chatHeaderStatus.textContent = conv.otherUserLastSeen
                ? 'Last seen ' + ChatApp.utils.formatRelativeTime(conv.otherUserLastSeen) : 'Offline';
            chatHeaderStatus.className = 'chat-header-status';
        }
    }

    // --- Admin controls for channel header (inline edit + add member button) ---
    function updateHeaderAdminControls() {
        if (_currentConvType !== 'channel') return;

        // Remove previous add member button if exists
        var existingAddBtn = document.getElementById('chatHeaderAddMemberBtn');
        if (existingAddBtn) existingAddBtn.remove();

        if (!isChannelAdmin()) return;

        // Make channel name editable on click
        chatHeaderName.style.cursor = 'pointer';
        chatHeaderName.title = 'Click to edit channel name';
        chatHeaderName.onclick = function () {
            var currentName = chatHeaderName.textContent;
            var input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'chat-header-name-input';
            input.style.cssText = 'font-size:inherit;font-weight:inherit;border:1px solid #ccc;border-radius:4px;padding:2px 6px;outline:none;width:200px;';
            chatHeaderName.textContent = '';
            chatHeaderName.appendChild(input);
            input.focus();
            input.select();

            var save = async function () {
                var newName = input.value.trim();
                if (newName && newName !== currentName) {
                    var result = await ChatApp.api.put('/api/channels/' + _currentConvId, { name: newName });
                    if (result.isSuccess) {
                        chatHeaderName.textContent = newName;
                        if (_currentConv) {
                            _currentConv.name = newName;
                            _currentConv.channelName = newName;
                        }
                    } else {
                        chatHeaderName.textContent = currentName;
                    }
                } else {
                    chatHeaderName.textContent = currentName;
                }
            };

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') { e.preventDefault(); save(); }
                if (e.key === 'Escape') { chatHeaderName.textContent = currentName; }
            });
            input.addEventListener('blur', save);
        };

        // Add "Add Member" button in header actions
        var headerActions = document.querySelector('.chat-header-actions');
        if (headerActions) {
            var addBtn = document.createElement('button');
            addBtn.className = 'toolbar-icon-btn';
            addBtn.id = 'chatHeaderAddMemberBtn';
            addBtn.title = 'Add member';
            addBtn.innerHTML = '<span class="material-icons">person_add</span>';
            addBtn.addEventListener('click', function () {
                showAddMemberDialog();
            });
            headerActions.insertBefore(addBtn, headerActions.firstChild);
        }
    }

    // --- Add Member Dialog ---
    function showAddMemberDialog() {
        // Remove existing dialog if any
        var existing = document.getElementById('addMemberDialog');
        if (existing) existing.remove();

        var overlay = document.createElement('div');
        overlay.id = 'addMemberDialog';
        overlay.className = 'add-member-dialog-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:1050;display:flex;align-items:center;justify-content:center;';

        var dialog = document.createElement('div');
        dialog.className = 'add-member-dialog';
        dialog.style.cssText = 'background:#fff;border-radius:12px;width:400px;max-height:500px;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.2);';

        dialog.innerHTML =
            '<div style="padding:16px 20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;">' +
            '<h4 style="margin:0;font-size:16px;">Add Member</h4>' +
            '<button id="addMemberCloseBtn" style="border:none;background:none;cursor:pointer;"><span class="material-icons">close</span></button>' +
            '</div>' +
            '<div style="padding:12px 20px;">' +
            '<input type="text" id="addMemberSearchInput" placeholder="Search users..." style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;outline:none;font-size:14px;" autocomplete="off" />' +
            '</div>' +
            '<div style="padding:0 20px 8px;">' +
            '<label style="font-size:13px;color:#666;">Role: </label>' +
            '<select id="addMemberRoleSelect" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">' +
            '<option value="Member">Member</option>' +
            '<option value="Admin">Admin</option>' +
            '</select>' +
            '</div>' +
            '<div id="addMemberResults" style="flex:1;overflow-y:auto;padding:0 12px 12px;max-height:300px;"></div>';

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Close handlers
        overlay.addEventListener('click', function (e) { if (e.target === overlay) overlay.remove(); });
        document.getElementById('addMemberCloseBtn').addEventListener('click', function () { overlay.remove(); });

        var searchInput = document.getElementById('addMemberSearchInput');
        var resultsDiv = document.getElementById('addMemberResults');
        var roleSelect = document.getElementById('addMemberRoleSelect');
        var searchTimer = null;

        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimer);
            var query = searchInput.value.trim();
            if (query.length < 2) { resultsDiv.innerHTML = '<div style="padding:12px;color:#999;font-size:13px;">Type at least 2 characters to search...</div>'; return; }
            searchTimer = setTimeout(async function () {
                var result = await ChatApp.api.get('/api/identity/users/search?query=' + encodeURIComponent(query));
                if (!result.isSuccess) return;
                var users = result.value || [];
                if (users.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding:12px;color:#999;font-size:13px;">No users found</div>';
                    return;
                }
                resultsDiv.innerHTML = '';
                users.forEach(function (user) {
                    var item = document.createElement('div');
                    item.style.cssText = 'display:flex;align-items:center;padding:8px 12px;border-radius:8px;cursor:pointer;gap:10px;';
                    item.innerHTML = ChatApp.utils.renderAvatar({ id: user.id, avatarUrl: user.avatarUrl, fullName: user.fullName }, 'add-member-avatar') +
                        '<div style="flex:1;"><div style="font-size:14px;font-weight:500;">' + ChatApp.utils.escapeHtml(user.fullName || '') + '</div>' +
                        '<div style="font-size:12px;color:#999;">' + ChatApp.utils.escapeHtml(user.email || user.userName || '') + '</div></div>' +
                        '<button class="add-member-add-btn" style="border:none;background:#25D366;color:#fff;padding:4px 12px;border-radius:6px;font-size:13px;cursor:pointer;">Add</button>';
                    item.addEventListener('mouseenter', function () { item.style.background = '#f5f5f5'; });
                    item.addEventListener('mouseleave', function () { item.style.background = ''; });
                    var addBtn = item.querySelector('.add-member-add-btn');
                    addBtn.addEventListener('click', async function () {
                        var role = roleSelect.value;
                        var body = { userId: user.id, role: role };
                        var addResult = await ChatApp.api.post('/api/channels/' + _currentConvId + '/members', body);
                        if (addResult.isSuccess) {
                            addBtn.textContent = 'Added';
                            addBtn.disabled = true;
                            addBtn.style.background = '#ccc';
                        } else {
                            addBtn.textContent = 'Failed';
                            addBtn.style.background = '#e53935';
                            setTimeout(function () { addBtn.textContent = 'Add'; addBtn.style.background = '#25D366'; }, 2000);
                        }
                    });
                    resultsDiv.appendChild(item);
                });
            }, 300);
        });

        searchInput.focus();
    }

    // --- Load messages ---
    async function loadMessages(direction) {
        if (_isLoading) return;
        _isLoading = true;

        const isChannel = _currentConvType === 'channel';
        let endpoint;

        if (isChannel) {
            endpoint = '/api/channels/' + _currentConvId + '/messages?page=' + _oldestPage + '&pageSize=' + _pageSize;
        } else {
            endpoint = '/api/conversations/' + _currentConvId + '/messages?page=' + _oldestPage + '&pageSize=' + _pageSize;
        }

        const result = await ChatApp.api.get(endpoint);
        _isLoading = false;
        hideMessagesLoading();

        if (result.isSuccess && result.value) {
            const items = result.value.items || result.value || [];
            _hasOlderMessages = items.length >= _pageSize;

            if (direction === 'older') {
                _savedScrollHeight = messagesContainer.scrollHeight;
                _messages = items.concat(_messages);
                renderMessages();
                // Restore scroll position
                requestAnimationFrame(function () {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight - _savedScrollHeight;
                });
            } else {
                _messages = items;
                renderMessages();

                // Auto-scroll to unread separator if present
                setTimeout(function () {
                    var unreadSep = messagesContainer.querySelector('.unread-separator');
                    if (unreadSep) {
                        unreadSep.scrollIntoView({ block: 'center' });
                    }
                }, 150);
            }
        }
    }

    async function loadOlderMessages() {
        _oldestPage++;
        await loadMessages('older');
    }

    async function loadNewerMessages() {
        if (_isLoading || !_hasNewerMessages) return;
        _isLoading = true;

        var lastMsg = _messages[_messages.length - 1];
        if (!lastMsg) { _isLoading = false; return; }

        var afterTimestamp = lastMsg.createdAt || lastMsg.sentAt;
        var isChannel = _currentConvType === 'channel';
        var endpoint = isChannel
            ? '/api/channels/' + _currentConvId + '/messages?after=' + encodeURIComponent(afterTimestamp) + '&pageSize=' + _pageSize
            : '/api/conversations/' + _currentConvId + '/messages?after=' + encodeURIComponent(afterTimestamp) + '&pageSize=' + _pageSize;

        var result = await ChatApp.api.get(endpoint);
        _isLoading = false;

        if (result.isSuccess && result.value) {
            var items = result.value.items || result.value || [];
            _hasNewerMessages = items.length >= _pageSize;

            if (items.length > 0) {
                _messages = _messages.concat(items);
                renderMessages();
                // Keep scroll position stable
                requestAnimationFrame(function () {
                    var lastEl = messagesList.querySelector('[data-message-id="' + lastMsg.id + '"]');
                    if (lastEl) lastEl.scrollIntoView({ block: 'start' });
                });
            } else {
                _hasNewerMessages = false;
            }
        }
    }

    // --- Render all messages ---
    function renderMessages() {
        // Show empty state if no messages
        if (_messages.length === 0) {
            messagesList.innerHTML = '<div class="no-messages-state">' +
                '<span class="material-icons" style="font-size:48px;color:var(--text-secondary);">chat_bubble_outline</span>' +
                '<p>No messages yet</p>' +
                '<p class="text-muted">Send a message to start the conversation</p>' +
                '</div>';
            return;
        }

        const fragment = document.createDocumentFragment();
        let lastDate = null;
        let lastSenderId = null;
        let lastTime = null;

        _messages.forEach(function (msg, index) {
            const msgDate = new Date(msg.createdAt || msg.sentAt);
            const dateStr = msgDate.toDateString();

            // Date separator
            if (dateStr !== lastDate) {
                lastDate = dateStr;
                const separator = document.createElement('div');
                separator.className = 'message-date-separator';
                separator.innerHTML = '<span>' + ChatApp.utils.formatMessageDate(msg.createdAt || msg.sentAt) + '</span>';
                fragment.appendChild(separator);
                lastSenderId = null;
            }

            // Unread separator
            if (msg._isUnreadSeparator) {
                const unreadSep = document.createElement('div');
                unreadSep.className = 'unread-separator';
                unreadSep.innerHTML = '<span>Unread messages</span>';
                fragment.appendChild(unreadSep);
            }

            // Read Later separator
            if (_currentConv && _currentConv.lastReadLaterMessageId && msg.id === _currentConv.lastReadLaterMessageId) {
                const laterSep = document.createElement('div');
                laterSep.className = 'unread-separator read-later-separator';
                laterSep.innerHTML = '<span>Read Later</span>';
                fragment.appendChild(laterSep);
            }

            // Group messages from same sender within 3 minutes
            const senderId = msg.senderId || msg.senderUserId;
            const msgTime = msgDate.getTime();
            const isGrouped = senderId === lastSenderId && lastTime && (msgTime - lastTime) < 180000;
            lastSenderId = senderId;
            lastTime = msgTime;

            fragment.appendChild(createMessageElement(msg, isGrouped));
        });

        messagesList.innerHTML = '';
        messagesList.appendChild(fragment);
    }

    // --- Create message element ---
    function createMessageElement(msg, isGrouped) {
        const currentUserId = ChatApp.state.currentUser ? ChatApp.state.currentUser.id : null;
        const senderId = msg.senderId || msg.senderUserId;
        const isOwn = senderId === currentUserId;

        const wrapper = document.createElement('div');
        wrapper.className = 'message-bubble-wrapper' + (isOwn ? ' own' : '') + (isGrouped ? ' grouped grouped-message' : '');
        wrapper.dataset.messageId = msg.id;
        wrapper.dataset.senderId = senderId;

        // Avatar column (hidden for grouped/own messages)
        if (!isGrouped && !isOwn) {
            const avatarCol = document.createElement('div');
            avatarCol.className = 'message-avatar-col';
            avatarCol.innerHTML = ChatApp.utils.renderAvatar(
                { id: senderId, avatarUrl: msg.senderAvatarUrl, fullName: msg.senderFullName || msg.senderName },
                'msg-avatar');
            avatarCol.style.cursor = 'pointer';
            avatarCol.addEventListener('click', function () {
                if (ChatApp.profilePanel) ChatApp.profilePanel.open(senderId);
            });
            wrapper.appendChild(avatarCol);
        }

        // Content column
        const contentCol = document.createElement('div');
        contentCol.className = 'message-content-col';

        // Sender name & time (for first in group, not own)
        if (!isGrouped) {
            const senderRow = document.createElement('div');
            senderRow.className = 'message-sender-row';
            if (!isOwn) {
                const nameSpan = document.createElement('span');
                nameSpan.className = 'message-sender-name';
                nameSpan.textContent = msg.senderFullName || msg.senderName || '';
                nameSpan.style.cursor = 'pointer';
                nameSpan.addEventListener('click', function () {
                    if (ChatApp.profilePanel) ChatApp.profilePanel.open(senderId);
                });
                senderRow.appendChild(nameSpan);
            }
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = ChatApp.utils.formatMessageTime(msg.createdAt || msg.sentAt);
            senderRow.appendChild(timeSpan);
            contentCol.appendChild(senderRow);
        }

        // Reply preview
        if (msg.replyToMessage || msg.repliedMessage) {
            const reply = msg.replyToMessage || msg.repliedMessage;
            const replyDiv = document.createElement('div');
            replyDiv.className = 'message-reply-preview';
            replyDiv.innerHTML = '<span class="material-icons" style="font-size:14px;">reply</span>' +
                '<span class="reply-name">' + ChatApp.utils.escapeHtml(reply.senderFullName || reply.senderName || '') + '</span>' +
                '<span class="reply-text">' + ChatApp.utils.escapeHtml(ChatApp.utils.truncateText(reply.content || '', 80)) + '</span>';
            replyDiv.addEventListener('click', function () {
                scrollToMessage(reply.id);
            });
            contentCol.appendChild(replyDiv);
        }

        // Bubble
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        // Forwarded message badge
        if (msg.forwardedFromMessageId || (msg.content && msg.content.indexOf('\u27a1\ufe0f Forwarded') === 0)) {
            const fwdDiv = document.createElement('div');
            fwdDiv.className = 'forwarded-label';
            fwdDiv.innerHTML = '<span class="material-icons" style="font-size:14px;">forward</span> Forwarded';
            bubble.appendChild(fwdDiv);
        }

        // Text content
        if (msg.content) {
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = formatMessageContent(msg.content, msg.mentions);
            bubble.appendChild(textDiv);
        }

        // Link preview cards
        if (msg.linkPreviews && msg.linkPreviews.length > 0) {
            msg.linkPreviews.forEach(function (lp) {
                const card = document.createElement('div');
                card.className = 'link-preview-card';
                var cardHtml = '';
                if (lp.imageUrl) {
                    cardHtml += '<img src="' + ChatApp.utils.escapeHtml(lp.imageUrl) + '" class="link-preview-image" loading="lazy" alt="" />';
                }
                cardHtml += '<div class="link-preview-content">';
                if (lp.domain || lp.url) {
                    var domain = lp.domain || (function () { try { return new URL(lp.url).hostname; } catch (e) { return ''; } })();
                    cardHtml += '<span class="link-preview-domain">' + ChatApp.utils.escapeHtml(domain) + '</span>';
                }
                if (lp.title) {
                    cardHtml += '<span class="link-preview-title">' + ChatApp.utils.escapeHtml(lp.title) + '</span>';
                }
                if (lp.description) {
                    cardHtml += '<span class="link-preview-description">' + ChatApp.utils.escapeHtml(lp.description) + '</span>';
                }
                cardHtml += '</div>';
                card.innerHTML = cardHtml;
                card.addEventListener('click', function () {
                    window.open(lp.url, '_blank', 'noopener');
                });
                bubble.appendChild(card);
            });
        }

        // File attachments
        if (msg.files && msg.files.length > 0) {
            const filesDiv = document.createElement('div');
            filesDiv.className = 'message-files';
            msg.files.forEach(function (file) {
                filesDiv.appendChild(createFileAttachment(file));
            });
            bubble.appendChild(filesDiv);
        }

        // Status row
        const statusRow = document.createElement('div');
        statusRow.className = 'message-status-row';
        if (msg.isEdited) {
            const edited = document.createElement('span');
            edited.className = 'message-edited-label';
            edited.textContent = 'edited';
            statusRow.appendChild(edited);
        }
        if (isOwn && msg.status) {
            const statusIcon = document.createElement('span');
            statusIcon.className = 'message-status-icon';
            statusIcon.innerHTML = msg.status === 'Read' || msg.status === 2
                ? '<span class="material-icons" style="font-size:14px;color:#4fc3f7;">done_all</span>'
                : msg.status === 'Delivered' || msg.status === 1
                    ? '<span class="material-icons" style="font-size:14px;">done_all</span>'
                    : '<span class="material-icons" style="font-size:14px;">done</span>';
            statusRow.appendChild(statusIcon);
        }
        bubble.appendChild(statusRow);

        // ReadByCount for channels
        if (msg.readByCount !== undefined && msg.readByCount !== null && _currentConvType === 'channel') {
            const readByDiv = document.createElement('div');
            readByDiv.className = 'message-read-by';
            readByDiv.textContent = 'Read by ' + msg.readByCount;
            bubble.appendChild(readByDiv);
        }

        contentCol.appendChild(bubble);

        // Fetch link previews from API if not already provided by server
        if (msg.content && (!msg.linkPreviews || msg.linkPreviews.length === 0)) {
            renderLinkPreviews(wrapper, msg.content);
        }

        // Reactions
        if (msg.reactions && msg.reactions.length > 0) {
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'message-reactions';
            msg.reactions.forEach(function (r) {
                const btn = document.createElement('button');
                btn.className = 'reaction-btn' + (r.hasReacted ? ' active' : '');
                btn.style.position = 'relative';
                btn.innerHTML = r.emoji + ' <span class="reaction-count">' + r.count + '</span>';
                btn.addEventListener('click', function () {
                    ChatApp.messages.toggleReaction(msg.id, r.emoji);
                });

                // Reaction user tooltip on hover
                if (r.users && r.users.length > 0) {
                    var tooltip = document.createElement('div');
                    tooltip.className = 'reaction-tooltip';
                    tooltip.textContent = r.users.map(function (u) { return u.fullName || u.userName || ''; }).join(', ');
                    btn.appendChild(tooltip);
                    btn.addEventListener('mouseenter', function () { tooltip.style.display = ''; });
                    btn.addEventListener('mouseleave', function () { tooltip.style.display = 'none'; });
                    tooltip.style.display = 'none';
                }

                reactionsDiv.appendChild(btn);
            });
            contentCol.appendChild(reactionsDiv);
        }

        wrapper.appendChild(contentCol);

        // Actions column (hover menu)
        const actionsCol = document.createElement('div');
        actionsCol.className = 'message-actions-col';
        const chevronMenu = document.createElement('div');
        chevronMenu.className = 'chevron-menu';
        const chevronBtn = document.createElement('button');
        chevronBtn.className = 'chevron-btn';
        chevronBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">more_vert</span>';
        chevronBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            showMessageContextMenu(e, msg, chevronMenu);
        });
        chevronMenu.appendChild(chevronBtn);
        actionsCol.appendChild(chevronMenu);

        // Quick reaction buttons
        const quickReactions = document.createElement('div');
        quickReactions.className = 'quick-reactions';
        ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®'].forEach(function (emoji) {
            const btn = document.createElement('button');
            btn.className = 'quick-reaction-btn';
            btn.textContent = emoji;
            btn.addEventListener('click', function () {
                ChatApp.messages.toggleReaction(msg.id, emoji);
            });
            quickReactions.appendChild(btn);
        });
        actionsCol.appendChild(quickReactions);

        wrapper.appendChild(actionsCol);

        // Show actions on hover
        wrapper.addEventListener('mouseenter', function () {
            chevronMenu.style.display = '';
            quickReactions.style.display = '';
        });
        wrapper.addEventListener('mouseleave', function () {
            chevronMenu.style.display = 'none';
            quickReactions.style.display = 'none';
        });
        chevronMenu.style.display = 'none';
        quickReactions.style.display = 'none';

        return wrapper;
    }

    // --- Format message content (mentions, links) ---
    function formatMessageContent(content, mentions) {
        if (!content) return '';
        let html = ChatApp.utils.escapeHtml(content);

        // Code blocks (``` ... ```) - must come before inline code
        html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

        // Inline code (` ... `)
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Bold (**text**)
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Italic (*text*)
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

        // Convert @mentions to clickable spans
        if (mentions && mentions.length > 0) {
            mentions.forEach(function (m) {
                const mentionText = '@' + (m.fullName || m.userName || '');
                const escapedMention = ChatApp.utils.escapeHtml(mentionText);
                const replacement = '<span class="mention-tag" data-user-id="' + m.userId + '">' +
                    escapedMention + '</span>';
                html = html.replace(new RegExp(escapedMention.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacement);
            });
        }

        // Highlight @Name patterns not already wrapped in mention-tag
        html = html.replace(/@([A-Za-z\u00C0-\u024F][\w\u00C0-\u024F]*(?:\s[A-Za-z\u00C0-\u024F][\w\u00C0-\u024F]*)*)/g, function (match, name, offset, str) {
            // Check if already inside a mention-tag span by looking backwards for unclosed tag
            var before = str.substring(0, offset);
            if (before.lastIndexOf('<span class="mention-tag"') > before.lastIndexOf('</span>')) return match;
            return '<span class="mention-highlight">' + match + '</span>';
        });

        // Convert URLs to links
        html = html.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');

        // Convert newlines
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    // --- File attachment ---
    // --- File type icon mapping ---
    function getFileIcon(fileName) {
        if (!fileName) return { icon: 'description', color: '' };
        const ext = fileName.split('.').pop().toLowerCase();
        if (ext === 'pdf') return { icon: 'picture_as_pdf', color: 'color:#e53935;' };
        if (ext === 'doc' || ext === 'docx') return { icon: 'article', color: 'color:#1565c0;' };
        if (ext === 'xls' || ext === 'xlsx') return { icon: 'table_chart', color: 'color:#2e7d32;' };
        if (ext === 'ppt' || ext === 'pptx') return { icon: 'slideshow', color: 'color:#ef6c00;' };
        if (ext === 'zip' || ext === 'rar' || ext === '7z') return { icon: 'folder_zip', color: 'color:#757575;' };
        return { icon: 'description', color: '' };
    }

    function createFileAttachment(file) {
        const el = document.createElement('div');
        el.className = 'message-file-item';

        const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(file.fileName || '');
        if (isImage && (file.thumbnailUrl || file.downloadUrl)) {
            el.innerHTML = '<img src="' + ChatApp.utils.escapeHtml(file.thumbnailUrl || file.downloadUrl) +
                '" alt="' + ChatApp.utils.escapeHtml(file.fileName) + '" class="message-file-image" loading="lazy" />';
            el.style.cursor = 'pointer';
            el.addEventListener('click', function () {
                openLightbox(file.downloadUrl, file.fileName);
            });
        } else {
            const fi = getFileIcon(file.fileName);
            el.innerHTML = '<div class="message-file-doc">' +
                '<span class="material-icons" style="font-size:22px;' + fi.color + '">' + fi.icon + '</span>' +
                '<div class="file-doc-info">' +
                '<span class="file-doc-name">' + ChatApp.utils.escapeHtml(file.fileName || 'file') + '</span>' +
                '<span class="file-doc-size">' + ChatApp.utils.formatFileSize(file.fileSizeInBytes) + '</span>' +
                '</div>' +
                '<button class="file-download-btn" title="Download">' +
                '<span class="material-icons" style="font-size:18px;">download</span></button></div>';
            el.querySelector('.file-download-btn').addEventListener('click', function (e) {
                e.stopPropagation();
                ChatApp.api.download(file.downloadUrl, file.fileName);
            });
        }
        return el;
    }

    // --- Image Lightbox ---
    function openLightbox(imageUrl, fileName) {
        var overlay = document.getElementById('imageLightbox');
        var img = document.getElementById('lightboxImage');
        var filenameEl = document.getElementById('lightboxFilename');
        var downloadBtn = document.getElementById('lightboxDownload');
        var closeBtn = document.getElementById('lightboxClose');

        if (!overlay || !img) return;

        var fullUrl = (imageUrl.startsWith('http') ? imageUrl : ChatApp.apiBase + imageUrl);
        img.src = fullUrl;
        if (filenameEl) filenameEl.textContent = fileName || '';
        overlay.style.display = '';

        // Download handler
        if (downloadBtn) {
            downloadBtn.onclick = function () {
                ChatApp.api.download(imageUrl, fileName);
            };
        }

        // Close handlers
        var closeFn = function () {
            overlay.style.display = 'none';
            img.src = '';
        };

        if (closeBtn) closeBtn.onclick = closeFn;
        overlay.onclick = function (e) {
            if (e.target === overlay || e.target.closest('.lightbox-body') === e.target) {
                closeFn();
            }
        };

        // Close on Escape
        var escHandler = function (e) {
            if (e.key === 'Escape') {
                closeFn();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    function closeLightbox() {
        var overlay = document.getElementById('imageLightbox');
        var img = document.getElementById('lightboxImage');
        if (overlay) overlay.style.display = 'none';
        if (img) img.src = '';
    }

    // --- Link Preview fetching for URLs in content ---
    function renderLinkPreviews(msgEl, content) {
        if (!content) return;
        var urlRegex = /https?:\/\/[^\s<]+/g;
        var urls = content.match(urlRegex);
        if (!urls || urls.length === 0) return;

        var bubble = msgEl.querySelector('.message-bubble');
        if (!bubble) return;

        var seen = new Set();
        urls.forEach(function (url) {
            if (seen.has(url)) return;
            seen.add(url);

            ChatApp.api.get('/api/search/link-preview?url=' + encodeURIComponent(url))
                .then(function (result) {
                    if (!result.isSuccess || !result.value) return;
                    var lp = result.value;
                    var card = document.createElement('div');
                    card.className = 'link-preview-card';
                    var cardHtml = '';
                    if (lp.imageUrl) {
                        cardHtml += '<img src="' + ChatApp.utils.escapeHtml(lp.imageUrl) + '" class="link-preview-image" loading="lazy" alt="" />';
                    }
                    cardHtml += '<div class="link-preview-content">';
                    var domain = lp.domain || (function () { try { return new URL(url).hostname; } catch (e) { return ''; } })();
                    if (domain) {
                        cardHtml += '<span class="link-preview-domain">' + ChatApp.utils.escapeHtml(domain) + '</span>';
                    }
                    if (lp.title) {
                        cardHtml += '<span class="link-preview-title">' + ChatApp.utils.escapeHtml(lp.title) + '</span>';
                    }
                    if (lp.description) {
                        cardHtml += '<span class="link-preview-description">' + ChatApp.utils.escapeHtml(lp.description) + '</span>';
                    }
                    cardHtml += '</div>';
                    card.innerHTML = cardHtml;
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', function () {
                        window.open(url, '_blank', 'noopener');
                    });
                    bubble.appendChild(card);
                });
        });
    }

    // --- Message context menu ---
    function showMessageContextMenu(e, msg, chevronMenu) {
        // Close any existing dropdown
        document.querySelectorAll('.msg-context-active').forEach(function (el) {
            el.classList.remove('msg-context-active');
        });

        const dropdown = document.createElement('div');
        dropdown.className = 'chevron-dropdown msg-context-dropdown';
        dropdown.style.display = '';

        const currentUserId = ChatApp.state.currentUser ? ChatApp.state.currentUser.id : null;
        const isOwn = (msg.senderId || msg.senderUserId) === currentUserId;

        const actions = [
            { action: 'reply', icon: 'reply', text: 'Reply' },
            { action: 'forward', icon: 'forward', text: 'Forward' },
            { action: 'copy', icon: 'content_copy', text: 'Copy' }
        ];

        if (isOwn && !msg.forwardedFromMessageId) actions.push({ action: 'edit', icon: 'edit', text: 'Edit' });
        if (msg.files && msg.files.length > 0) {
            actions.push({ action: 'download', icon: 'download', text: 'Download' });
        }
        actions.push({ action: 'pin', icon: 'push_pin', text: msg.isPinned ? 'Unpin' : 'Pin' });
        actions.push({ action: 'favorite', icon: msg.isFavorite ? 'star' : 'star_outline', text: msg.isFavorite ? 'Unfavorite' : 'Favorite' });
        actions.push({ action: 'later', icon: 'schedule', text: 'Read Later' });
        actions.push({ action: 'select', icon: 'check_box', text: 'Select' });
        if (isOwn || ChatApp.state.isAdmin) {
            actions.push({ divider: true });
            actions.push({ action: 'delete', icon: 'delete', text: 'Delete', danger: true });
        }

        actions.forEach(function (a) {
            if (a.divider) {
                dropdown.appendChild(document.createElement('hr'));
                return;
            }
            const btn = document.createElement('button');
            btn.className = 'chevron-item' + (a.danger ? ' danger' : '');
            btn.innerHTML = '<span class="material-icons" style="font-size:16px;">' + a.icon + '</span> ' + a.text;
            btn.addEventListener('click', function () {
                dropdown.remove();
                handleMessageAction(a.action, msg);
            });
            dropdown.appendChild(btn);
        });

        chevronMenu.appendChild(dropdown);

        // Menu position: check if overflows viewport bottom
        requestAnimationFrame(function () {
            var rect = dropdown.getBoundingClientRect();
            if (rect.bottom > window.innerHeight) {
                dropdown.style.bottom = '100%';
                dropdown.style.top = 'auto';
            }
        });

        // Close on outside click
        setTimeout(function () {
            document.addEventListener('click', function closeDropdown() {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }, { once: true });
        }, 0);
    }

    function handleMessageAction(action, msg) {
        switch (action) {
            case 'reply': ChatApp.messageInput.setReplyMode(msg); break;
            case 'forward': ChatApp.forwarding.showForwardDialog(msg); break;
            case 'copy':
                if (msg.content && navigator.clipboard) {
                    navigator.clipboard.writeText(msg.content).catch(function () { });
                }
                break;
            case 'edit': ChatApp.messageInput.setEditMode(msg); break;
            case 'download':
                if (msg.files && msg.files.length > 0) {
                    ChatApp.api.download(msg.files[0].downloadUrl, msg.files[0].fileName);
                }
                break;
            case 'pin': ChatApp.messages.togglePin(msg.id); break;
            case 'favorite': ChatApp.messages.toggleFavorite(msg.id); break;
            case 'later': ChatApp.messages.markAsLater(msg.id); break;
            case 'select': ChatApp.selection.toggleSelect(msg.id); break;
            case 'delete': ChatApp.messages.deleteMessage(msg.id); break;
        }
    }

    // --- Scroll management ---
    if (messagesContainer) {
        messagesContainer.addEventListener('scroll', ChatApp.utils.throttle(function () {
            // Check near bottom
            _isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50;

            // Hide new message indicator and reset badge if near bottom
            if (_isNearBottom && newMsgIndicator) {
                newMsgIndicator.style.display = 'none';
                _newMsgCount = 0;
                updateNewMsgBadge();
            }

            // Load older messages when scrolled to top
            if (messagesContainer.scrollTop < 100 && _hasOlderMessages && !_isLoading) {
                loadOlderMessages();
            }

            // Load newer messages when scrolling down in around mode
            if (_hasNewerMessages && !_isLoading && messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 100) {
                loadNewerMessages();
            }

            // Close any open context menus on scroll
            var openMenu = document.querySelector('.chevron-dropdown.msg-context-dropdown');
            if (openMenu) openMenu.remove();
        }, 100));
    }

    function scrollToBottom(smooth) {
        if (!messagesContainer) return;
        requestAnimationFrame(function () {
            requestAnimationFrame(function () {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: smooth ? 'smooth' : 'auto'
                });
            });
        });
    }

    async function scrollToMessage(messageId) {
        var el = messagesList.querySelector('[data-message-id="' + messageId + '"]');
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.add('message-highlight');
            setTimeout(function () { el.classList.remove('message-highlight'); }, 2000);
            return;
        }

        // Message not in DOM - load messages around that ID
        var isChannel = _currentConvType === 'channel';
        var endpoint = isChannel
            ? '/api/channels/' + _currentConvId + '/messages?around=' + messageId + '&pageSize=' + _pageSize
            : '/api/conversations/' + _currentConvId + '/messages?around=' + messageId + '&pageSize=' + _pageSize;

        var result = await ChatApp.api.get(endpoint);
        if (result.isSuccess && result.value) {
            var items = result.value.items || result.value || [];
            if (items.length > 0) {
                _messages = items;
                _hasOlderMessages = true;
                _hasNewerMessages = true;
                renderMessages();

                requestAnimationFrame(function () {
                    var targetEl = messagesList.querySelector('[data-message-id="' + messageId + '"]');
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetEl.classList.add('message-highlight');
                        setTimeout(function () { targetEl.classList.remove('message-highlight'); }, 2000);
                    }
                });
            }
        }
    }

    // --- New message count badge ---
    function updateNewMsgBadge() {
        if (!newMsgIndicatorBtn) return;
        var badge = newMsgIndicatorBtn.querySelector('.new-msg-badge');
        if (_newMsgCount > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'new-msg-badge';
                badge.style.cssText = 'background:#25D366;color:#fff;border-radius:10px;padding:1px 6px;font-size:11px;font-weight:600;margin-left:4px;';
                newMsgIndicatorBtn.appendChild(badge);
            }
            badge.textContent = _newMsgCount > 99 ? '99+' : _newMsgCount;
        } else if (badge) {
            badge.remove();
        }
    }

    // --- New message indicator ---
    if (newMsgIndicatorBtn) {
        newMsgIndicatorBtn.addEventListener('click', function () {
            scrollToBottom(true);
            newMsgIndicator.style.display = 'none';
            _newMsgCount = 0;
            updateNewMsgBadge();
        });
    }

    // --- Pinned messages ---
    async function loadPinnedMessages() {
        const isChannel = _currentConvType === 'channel';
        const endpoint = isChannel
            ? '/api/channels/' + _currentConvId + '/messages/pinned'
            : '/api/conversations/' + _currentConvId + '/messages/pinned';

        const result = await ChatApp.api.get(endpoint);
        if (result.isSuccess) {
            _pinnedMessages = result.value || [];
            updatePinnedBar();
        }
    }

    function updatePinnedBar() {
        if (_pinnedMessages.length > 0) {
            pinnedBar.style.display = '';
            pinnedBarText.textContent = _pinnedMessages.length + ' pinned message' + (_pinnedMessages.length > 1 ? 's' : '');
        } else {
            pinnedBar.style.display = 'none';
        }
    }

    if (pinnedBarToggle) {
        pinnedBarToggle.addEventListener('click', function () {
            const isOpen = pinnedDropdown.style.display !== 'none';
            pinnedDropdown.style.display = isOpen ? 'none' : '';
            if (!isOpen) {
                pinnedDropdown.innerHTML = '';
                _pinnedMessages.forEach(function (msg) {
                    const item = document.createElement('div');
                    item.className = 'pinned-message-item';
                    item.innerHTML = '<span class="pinned-sender">' +
                        ChatApp.utils.escapeHtml(msg.senderFullName || msg.senderName || '') + '</span>' +
                        '<span class="pinned-text">' + ChatApp.utils.escapeHtml(ChatApp.utils.truncateText(msg.content || '', 60)) + '</span>';
                    item.addEventListener('click', function () {
                        scrollToMessage(msg.id);
                        pinnedDropdown.style.display = 'none';
                    });
                    pinnedDropdown.appendChild(item);
                });
            }
        });
    }

    // --- Channel membership ---
    async function checkMembership() {
        const result = await ChatApp.api.get('/api/channels/' + _currentConvId + '/members/me');
        _isMember = result.isSuccess && result.value;
        if (_isMember && result.value) {
            _myChannelRole = result.value.role || result.value.memberRole || null;
        } else {
            _myChannelRole = null;
        }
        joinChannelBanner.style.display = _isMember ? 'none' : '';
        // Update header to show admin controls if applicable
        updateHeaderAdminControls();
    }

    function isChannelAdmin() {
        return _myChannelRole === 'Admin' || _myChannelRole === 'Owner' ||
            _myChannelRole === 1 || _myChannelRole === 0 || ChatApp.state.isAdmin;
    }

    if (joinChannelBtn) {
        joinChannelBtn.addEventListener('click', async function () {
            const result = await ChatApp.api.post('/api/channels/' + _currentConvId + '/join');
            if (result.isSuccess) {
                _isMember = true;
                joinChannelBanner.style.display = 'none';
            }
        });
    }

    // --- Typing indicators ---
    ChatApp.signalR.on('userTypingInChannel', function (data) {
        if (data.channelId !== _currentConvId) return;
        handleTyping(data.userId, data.fullName, data.isTyping);
    });

    ChatApp.signalR.on('userTypingInConversation', function (data) {
        if (data.conversationId !== _currentConvId) return;
        handleTyping(data.userId, null, data.isTyping);
    });

    function handleTyping(userId, fullName, isTyping) {
        if (userId === (ChatApp.state.currentUser ? ChatApp.state.currentUser.id : null)) return;
        if (isTyping) {
            _typingUsers[userId] = fullName || 'Someone';
        } else {
            delete _typingUsers[userId];
        }
        updateTypingIndicator();
    }

    function updateTypingIndicator() {
        const names = Object.values(_typingUsers);
        if (names.length > 0) {
            typingIndicator.style.display = '';
            typingName.textContent = names.length === 1
                ? names[0] + ' is typing'
                : names.length + ' people are typing';
        } else {
            typingIndicator.style.display = 'none';
        }
    }

    // --- SignalR message events ---
    ChatApp.signalR.on('newDirectMessage', function (msg) {
        if ((msg.conversationId || msg.directConversationId) !== _currentConvId) return;
        appendMessage(msg);
    });

    ChatApp.signalR.on('newChannelMessage', function (msg) {
        if (msg.channelId !== _currentConvId) return;
        appendMessage(msg);
    });

    function appendMessage(msg) {
        // Dedup: skip if already processed
        if (msg.id && _processedMessageIds.has(msg.id)) return;
        if (msg.id) _processedMessageIds.add(msg.id);

        // Remove optimistic pending version if exists
        if (msg.id && _pendingMessageIds.has(msg.id)) {
            _pendingMessageIds.delete(msg.id);
            var pendingEl = messagesList.querySelector('[data-message-id="pending-' + msg.id + '"]');
            if (pendingEl) pendingEl.remove();
            _messages = _messages.filter(function (m) { return m._pendingId !== msg.id; });
        }

        // Also remove temp pending by matching content for optimistic messages
        if (msg._tempId) {
            var tempEl = messagesList.querySelector('[data-message-id="' + msg._tempId + '"]');
            if (tempEl) tempEl.remove();
            _messages = _messages.filter(function (m) { return m.id !== msg._tempId; });
        }

        _messages.push(msg);
        const el = createMessageElement(msg, false);
        messagesList.appendChild(el);

        if (_isNearBottom) {
            scrollToBottom(true);
            markAsRead();
            _newMsgCount = 0;
        } else {
            _newMsgCount++;
            newMsgIndicator.style.display = '';
            updateNewMsgBadge();
        }
    }

    // --- Add pending (optimistic) message to UI ---
    function addPendingMessage(tempId, content) {
        var currentUser = ChatApp.state.currentUser || {};
        var pendingMsg = {
            id: tempId,
            _pendingId: tempId,
            _isPending: true,
            content: content,
            senderId: currentUser.id,
            senderFullName: currentUser.fullName || '',
            senderAvatarUrl: currentUser.avatarUrl,
            createdAt: new Date().toISOString(),
            status: 'Sending'
        };
        _messages.push(pendingMsg);
        var el = createMessageElement(pendingMsg, false);
        el.style.opacity = '0.6';
        messagesList.appendChild(el);
        scrollToBottom(true);
    }

    // Message edited
    ChatApp.signalR.on('directMessageEdited', updateMessageInPlace);
    ChatApp.signalR.on('channelMessageEdited', updateMessageInPlace);

    function updateMessageInPlace(msg) {
        const idx = _messages.findIndex(function (m) { return m.id === msg.id; });
        if (idx !== -1) {
            _messages[idx] = Object.assign(_messages[idx], msg);
            renderMessages();
        }
    }

    // Message deleted
    ChatApp.signalR.on('directMessageDeleted', removeMessage);
    ChatApp.signalR.on('channelMessageDeleted', removeMessage);

    function removeMessage(msg) {
        var msgId = msg.id || msg;
        var el = document.querySelector('[data-message-id="' + msgId + '"]');
        if (!el) return;
        // Instead of removing, show deleted tombstone
        var bubble = el.querySelector('.message-bubble');
        if (bubble) {
            bubble.innerHTML = '<div class="deleted-message"><span class="material-icons" style="font-size:16px;">block</span> This message was deleted</div>';
            bubble.classList.add('deleted');
        }
        // Remove action buttons
        var actions = el.querySelector('.message-actions-col');
        if (actions) actions.remove();
        el.classList.add('deleted');
        // Update in _messages array
        var msgObj = _messages.find(function (m) { return m.id === msgId; });
        if (msgObj) msgObj.isDeleted = true;
    }

    // Reactions
    ChatApp.signalR.on('directMessageReactionToggled', function (data) {
        updateReactions(data.messageId, data.reactions);
    });
    ChatApp.signalR.on('channelMessageReactionsUpdated', function (data) {
        updateReactions(data.messageId, data.reactions);
    });

    function updateReactions(messageId, reactions) {
        const idx = _messages.findIndex(function (m) { return m.id === messageId; });
        if (idx !== -1) {
            _messages[idx].reactions = reactions;
            renderMessages();
        }
    }

    // Pin/unpin
    ChatApp.signalR.on('directMessagePinned', function () { loadPinnedMessages(); });
    ChatApp.signalR.on('directMessageUnpinned', function () { loadPinnedMessages(); });
    ChatApp.signalR.on('channelMessagePinned', function () { loadPinnedMessages(); });
    ChatApp.signalR.on('channelMessageUnpinned', function () { loadPinnedMessages(); });

    // Read status
    ChatApp.signalR.on('messageRead', function (data) {
        if (data.conversationId !== _currentConvId) return;
        const msg = _messages.find(function (m) { return m.id === data.messageId; });
        if (msg) {
            msg.status = 'Read';
            msg.messageStatus = 2;
            renderMessages();
        }
    });

    // --- Mark as read ---
    const markAsRead = ChatApp.utils.debounce(function () {
        if (!_currentConvId || !_isMember) return;
        const isChannel = _currentConvType === 'channel';
        const endpoint = isChannel
            ? '/api/channels/' + _currentConvId + '/messages/mark-as-read'
            : '/api/conversations/' + _currentConvId + '/mark-as-read';
        ChatApp.api.post(endpoint);
    }, 500);

    // --- Sidebar/Search buttons ---
    if (chatSidebarBtn) {
        chatSidebarBtn.addEventListener('click', function () {
            if (ChatApp.sidebar) ChatApp.sidebar.toggle(_currentConvId, _currentConvType, _currentConv);
        });
    }

    if (chatSearchBtn) {
        chatSearchBtn.addEventListener('click', function () {
            if (ChatApp.search) ChatApp.search.toggle(_currentConvId, _currentConvType);
        });
    }

    if (chatBackBtn) {
        chatBackBtn.addEventListener('click', function () {
            chatContent.style.display = 'none';
            chatEmptyState.style.display = '';
        });
    }

    // --- Utility ---
    function showMessagesLoading() {
        if (!messagesLoading) return;
        messagesLoading.style.display = '';
        // Replace spinner with skeleton placeholders
        messagesLoading.innerHTML = '';
        for (var i = 0; i < 6; i++) {
            var sk = document.createElement('div');
            sk.className = 'message-skeleton' + (i % 3 === 0 ? ' own' : '');
            sk.innerHTML = '<div class="skeleton-avatar"></div>' +
                '<div class="skeleton-content">' +
                '<div class="skeleton-line skeleton-name"></div>' +
                '<div class="skeleton-line skeleton-text"></div>' +
                '<div class="skeleton-line skeleton-text short"></div>' +
                '</div>';
            messagesLoading.appendChild(sk);
        }
    }
    function hideMessagesLoading() { if (messagesLoading) { messagesLoading.style.display = 'none'; messagesLoading.innerHTML = ''; } }

    // --- Public API ---
    ChatApp.chatArea = {
        getCurrentConvId: function () { return _currentConvId; },
        getCurrentConvType: function () { return _currentConvType; },
        getCurrentConv: function () { return _currentConv; },
        isMember: function () { return _isMember; },
        isChannelAdmin: isChannelAdmin,
        scrollToBottom: scrollToBottom,
        scrollToMessage: scrollToMessage,
        appendMessage: appendMessage,
        addPendingMessage: addPendingMessage,
        renderMessages: renderMessages,
        showAddMemberDialog: showAddMemberDialog,
        openLightbox: openLightbox,
        closeLightbox: closeLightbox,
        getMessages: function () { return _messages; },
        reload: function () {
            _messages = [];
            _oldestPage = 1;
            _processedMessageIds.clear();
            _pendingMessageIds.clear();
            loadMessages();
        }
    };

})();

