@page "/channels"
@inject IChannelService ChannelService
@inject IChannelMemberService MemberService
@inject ChannelState ChannelState
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject UserState UserState
@attribute [Authorize]

<PageTitle>Channels</PageTitle>

<div class="channel-list-page">
    <MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
        <div class="page-header mb-4" style="animation: fadeInDown 0.4s ease-out;">
            <div class="d-flex justify-space-between align-center mb-4">
                <div>
                    <MudText Typo="Typo.H4" Class="font-weight-bold">Channels</MudText>
                    <MudText Typo="Typo.Body2" Color="Color.Secondary">
                        Connect and collaborate with your team
                    </MudText>
                </div>

                @if (UserState.HasPermission("Groups.Create"))
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="OpenCreateChannelDialog"
                               Class="create-btn">
                        Create Channel
                    </MudButton>
                }
            </div>

            <div class="d-flex gap-2 mb-4">
                <MudTextField @bind-Value="_searchQuery"
                              Placeholder="Search channels..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              OnDebounceInterval="300"
                              DebounceInterval="300"
                              Class="flex-grow-1" />

                <MudButtonGroup Variant="Variant.Outlined">
                    <MudButton OnClick="@(() => SetFilter(ChannelFilter.MyChannels))"
                               Variant="@(_currentFilter == ChannelFilter.MyChannels ? Variant.Filled : Variant.Outlined)"
                               Color="@(_currentFilter == ChannelFilter.MyChannels ? Color.Primary : Color.Default)">
                        My Channels
                    </MudButton>
                    <MudButton OnClick="@(() => SetFilter(ChannelFilter.PublicChannels))"
                               Variant="@(_currentFilter == ChannelFilter.PublicChannels ? Variant.Filled : Variant.Outlined)"
                               Color="@(_currentFilter == ChannelFilter.PublicChannels ? Color.Primary : Color.Default)">
                        Public
                    </MudButton>
                </MudButtonGroup>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" />
            </div>
        }
        else if (!_filteredChannels.Any())
        {
            <div class="empty-state" style="animation: fadeIn 0.5s ease-out;">
                <MudPaper Elevation="0" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Outlined.Forum"
                             Size="Size.Large"
                             Color="Color.Secondary"
                             Style="font-size: 80px;"
                             Class="mb-4" />

                    @if (_currentFilter == ChannelFilter.MyChannels)
                    {
                        <MudText Typo="Typo.H6" Color="Color.Secondary" Class="mb-2">
                            No channels yet
                        </MudText>
                        <MudText Typo="Typo.Body2" Color="Color.Secondary" Class="mb-4">
                            Create a channel or join a public channel to get started
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.H6" Color="Color.Secondary" Class="mb-2">
                            No public channels available
                        </MudText>
                        <MudText Typo="Typo.Body2" Color="Color.Secondary" Class="mb-4">
                            Be the first to create a public channel
                        </MudText>
                    }

                    @if (UserState.HasPermission("Groups.Create"))
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="OpenCreateChannelDialog">
                            Create Channel
                        </MudButton>
                    }
                </MudPaper>
            </div>
        }
        else
        {
            <MudGrid Spacing="3">
                @foreach (var channel in _filteredChannels)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Class="channel-card" Style="animation: scaleIn 0.3s ease-out;">
                            <MudCardContent>
                                <div class="d-flex align-items-start gap-2 mb-2">
                                    <MudIcon Icon="@(channel.Type == ChannelType.Public ? Icons.Material.Filled.Public : Icons.Material.Filled.Lock)"
                                             Color="@(channel.Type == ChannelType.Public ? Color.Success : Color.Warning)"
                                             Size="Size.Small" />

                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.H6" Class="font-weight-bold">
                                            @channel.Name
                                        </MudText>
                                    </div>

                                    @if (channel.IsArchived)
                                    {
                                        <MudChip Size="Size.Small" Color="Color.Default">Archived</MudChip>
                                    }
                                </div>

                                @if (!string.IsNullOrWhiteSpace(channel.Description))
                                {
                                    <MudText Typo="Typo.Body2" Color="Color.Secondary" Class="mb-3">
                                        @(channel.Description.Length > 100 ? channel.Description.Substring(0, 100) + "..." : channel.Description)
                                    </MudText>
                                }

                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="d-flex align-items-center gap-1">
                                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.Caption" Color="Color.Secondary">
                                            @channel.MemberCount members
                                        </MudText>
                                    </div>

                                    <div class="d-flex align-items-center gap-1">
                                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.Caption" Color="Color.Secondary">
                                            @GetRelativeTime(channel.CreatedAtUtc)
                                        </MudText>
                                    </div>
                                </div>

                                @if (GetUnreadCount(channel.Id) > 0)
                                {
                                    <MudChip Size="Size.Small" Color="Color.Error" Class="mb-2">
                                        @GetUnreadCount(channel.Id) unread
                                    </MudChip>
                                }
                            </MudCardContent>

                            <MudCardActions>
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           OnClick="@(() => OpenChannel(channel.Id))">
                                    Open
                                </MudButton>

                                @if (_currentFilter == ChannelFilter.MyChannels)
                                {
                                    <MudSpacer />
                                    <MudIconButton Icon="@Icons.Material.Filled.ExitToApp"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => LeaveChannel(channel.Id))"
                                                   Title="Leave channel" />
                                }
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudContainer>
</div>

<style>
    .channel-list-page {
        min-height: 100vh;
        background: linear-gradient(135deg, rgba(var(--mud-palette-primary-rgb), 0.05) 0%, rgba(var(--mud-palette-secondary-rgb), 0.05) 100%);
    }

    .channel-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        height: 100%;
    }

    .channel-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .create-btn {
        animation: pulse 2s ease-in-out infinite;
    }
</style>

@code {
    private List<ChannelDto> _myChannels = new();
    private List<ChannelDto> _publicChannels = new();
    private List<ChannelDto> _filteredChannels = new();
    private string _searchQuery = string.Empty;
    private ChannelFilter _currentFilter = ChannelFilter.MyChannels;
    private bool _isLoading = false;

    private enum ChannelFilter
    {
        MyChannels,
        PublicChannels
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadChannels();
        ChannelState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ChannelState.OnChange -= StateHasChanged;
    }

    private async Task LoadChannels()
    {
        _isLoading = true;

        if (_currentFilter == ChannelFilter.MyChannels)
        {
            var result = await ChannelService.GetMyChannelsAsync();
            if (result.IsSuccess)
            {
                _myChannels = result.Data ?? new();
            }
        }
        else
        {
            var result = await ChannelService.GetPublicChannelsAsync();
            if (result.IsSuccess)
            {
                _publicChannels = result.Data ?? new();
            }
        }

        _isLoading = false;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var channels = _currentFilter == ChannelFilter.MyChannels ? _myChannels : _publicChannels;

        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            _filteredChannels = channels
                .Where(c => c.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                           (c.Description?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ?? false))
                .ToList();
        }
        else
        {
            _filteredChannels = channels;
        }
    }

    private async Task SetFilter(ChannelFilter filter)
    {
        if (_currentFilter != filter)
        {
            _currentFilter = filter;
            await LoadChannels();
        }
    }

    private async Task OpenCreateChannelDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateChannelDialog>("Create Channel", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Guid channelId)
        {
            await LoadChannels();
            OpenChannel(channelId);
        }
    }

    private void OpenChannel(Guid channelId)
    {
        Navigation.NavigateTo($"/channels/{channelId}");
    }

    private async Task LeaveChannel(Guid channelId)
    {
        var channel = _myChannels.FirstOrDefault(c => c.Id == channelId);
        if (channel == null) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Leave Channel",
            $"Are you sure you want to leave '{channel.Name}'?",
            yesText: "Leave", cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await MemberService.LeaveChannelAsync(channelId);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Left '{channel.Name}'", Severity.Success);
                await LoadChannels();
            }
            else
            {
                Snackbar.Add(result.Error ?? "Failed to leave channel", Severity.Error);
            }
        }
    }

    private int GetUnreadCount(Guid channelId)
    {
        return ChannelState.GetUnreadCount(channelId);
    }

    private string GetRelativeTime(DateTime utcTime)
    {
        var localTime = utcTime.ToLocalTime();
        var timeSpan = DateTime.Now - localTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return localTime.ToString("MMM dd, yyyy");
    }
}
