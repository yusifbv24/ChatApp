@inject IChannelMessageService MessageService
@inject ChannelState ChannelState

<div class="message-list" @ref="_messageListRef">
    @if (_isLoading && !_messages.Any())
    {
        <div class="d-flex justify-center align-center pa-8">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }
    else if (!_messages.Any())
    {
        <div class="d-flex flex-column justify-center align-center pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Outlined.ChatBubbleOutline"
                     Size="Size.Large"
                     Color="Color.Secondary"
                     Class="mb-4" />
            <MudText Typo="Typo.H6" Color="Color.Secondary">
                No messages yet
            </MudText>
            <MudText Typo="Typo.Body2" Color="Color.Secondary">
                Be the first to send a message!
            </MudText>
        </div>
    }
    else
    {
        @if (_pinnedMessages.Any())
        {
            <div class="pinned-messages-banner">
                <MudPaper Elevation="1" Class="pa-3 mb-3" Style="background-color: rgba(var(--mud-palette-warning-rgb), 0.1);">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.PushPin" Color="Color.Warning" />
                        <MudText Typo="Typo.Subtitle2" Color="Color.Warning">
                            Pinned Messages (@_pinnedMessages.Count)
                        </MudText>
                    </div>
                    @foreach (var msg in _pinnedMessages.Take(3))
                    {
                        <div class="pinned-message-preview mb-1">
                            <MudText Typo="Typo.Caption" Class="font-weight-bold">@msg.SenderName:</MudText>
                            <MudText Typo="Typo.Caption">
                                @(msg.Content.Length > 100 ? msg.Content.Substring(0, 100) + "..." : msg.Content)
                            </MudText>
                        </div>
                    }
                </MudPaper>
            </div>
        }

        <div class="messages-container">
            @if (_hasMoreMessages)
            {
                <div class="text-center pa-2">
                    <MudButton Variant="Variant.Text"
                               OnClick="LoadMoreMessages"
                               Disabled="@_isLoadingMore">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        }
                        else
                        {
                            <span>Load More Messages</span>
                        }
                    </MudButton>
                </div>
            }

            @{
                DateTime? lastDate = null;
            }

            @foreach (var message in _messages.OrderBy(m => m.SentAtUtc))
            {
                var messageDate = message.SentAtUtc.ToLocalTime().Date;

                @if (lastDate == null || lastDate.Value.Date != messageDate)
                {
                    <div class="date-separator">
                        <MudDivider />
                        <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                            @GetDateLabel(messageDate)
                        </MudChip>
                        <MudDivider />
                    </div>
                    lastDate = messageDate;
                }

                <MessageItem Message="@message"
                            ChannelId="@ChannelId"
                            CanManageMessages="@CanManageMessages"
                            OnMessageChanged="OnMessageChanged" />
            }
        </div>

        <div @ref="_scrollAnchorRef" style="height: 1px;"></div>
    }
</div>

<style>
    .message-list {
        height: 100%;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    .messages-container {
        flex: 1;
    }

    .date-separator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 16px 0;
    }

    .date-separator .mud-divider {
        flex: 1;
    }

    .pinned-message-preview {
        padding: 4px 0;
    }
</style>

@code {
    [Parameter] public Guid ChannelId { get; set; }
    [Parameter] public bool CanManageMessages { get; set; }

    private List<ChannelMessageDto> _messages = new();
    private List<ChannelMessageDto> _pinnedMessages = new();
    private bool _isLoading = false;
    private bool _isLoadingMore = false;
    private bool _hasMoreMessages = true;
    private ElementReference _messageListRef;
    private ElementReference _scrollAnchorRef;
    private bool _shouldScrollToBottom = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadMessages();
        await LoadPinnedMessages();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScrollToBottom && _messages.Any())
        {
            _shouldScrollToBottom = false;
            // In a real implementation, use JS interop to scroll
            // await JSRuntime.InvokeVoidAsync("scrollToBottom", _messageListRef);
        }
    }

    private async Task LoadMessages()
    {
        _isLoading = true;

        var result = await MessageService.GetMessagesAsync(ChannelId, pageSize: 50);

        _isLoading = false;

        if (result.IsSuccess)
        {
            _messages = result.Data ?? new();
            _hasMoreMessages = _messages.Count >= 50;
            _shouldScrollToBottom = true;
        }
    }

    private async Task LoadMoreMessages()
    {
        if (!_messages.Any()) return;

        _isLoadingMore = true;

        var oldestMessage = _messages.OrderBy(m => m.SentAtUtc).First();
        var result = await MessageService.GetMessagesAsync(ChannelId, pageSize: 50, before: oldestMessage.SentAtUtc);

        _isLoadingMore = false;

        if (result.IsSuccess && result.Data != null)
        {
            _messages.InsertRange(0, result.Data);
            _hasMoreMessages = result.Data.Count >= 50;
        }
    }

    private async Task LoadPinnedMessages()
    {
        var result = await MessageService.GetPinnedMessagesAsync(ChannelId);

        if (result.IsSuccess)
        {
            _pinnedMessages = result.Data ?? new();
        }
    }

    private async Task OnMessageChanged()
    {
        await LoadMessages();
        await LoadPinnedMessages();
        StateHasChanged();
    }

    private string GetDateLabel(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date == today)
            return "Today";
        else if (date == yesterday)
            return "Yesterday";
        else if (date.Year == today.Year)
            return date.ToString("MMMM dd");
        else
            return date.ToString("MMMM dd, yyyy");
    }

    public async Task RefreshMessages()
    {
        await LoadMessages();
        await LoadPinnedMessages();
        _shouldScrollToBottom = true;
        StateHasChanged();
    }
}
