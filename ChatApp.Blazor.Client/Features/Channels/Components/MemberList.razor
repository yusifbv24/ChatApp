@inject IChannelMemberService MemberService
@inject ISnackbar Snackbar

<div class="member-list">
    <div class="member-list-header pa-3">
        <MudText Typo="Typo.H6">Members (@_members.Count)</MudText>

        @if (CanManageMembers)
        {
            <MudButton StartIcon="@Icons.Material.Filled.PersonAdd"
                       Size="Size.Small"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="OpenAddMemberDialog"
                       Class="mt-2">
                Add Member
            </MudButton>
        }
    </div>

    <MudDivider />

    @if (_isLoading)
    {
        <div class="d-flex justify-center pa-4">
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        </div>
    }
    else
    {
        @foreach (var roleGroup in _members.GroupBy(m => m.Role).OrderByDescending(g => g.Key))
        {
            <div class="role-group">
                <div class="role-header pa-2">
                    <MudText Typo="Typo.Subtitle2" Color="Color.Secondary">
                        @GetRoleLabel(roleGroup.Key) (@roleGroup.Count())
                    </MudText>
                </div>

                @foreach (var member in roleGroup.OrderBy(m => m.DisplayName))
                {
                    <div class="member-item pa-2 d-flex align-items-center gap-2" style="animation: slideInRight 0.3s ease-out;">
                        <MudAvatar Color="@GetRoleColor(member.Role)" Size="Size.Small">
                            @member.DisplayName.Substring(0, 1).ToUpper()
                        </MudAvatar>

                        <div class="flex-grow-1">
                            <MudText Typo="Typo.Body2">
                                @member.DisplayName
                            </MudText>
                            <MudText Typo="Typo.Caption" Color="Color.Secondary">
                                @member.Email
                            </MudText>
                        </div>

                        @if (member.Role == MemberRole.Owner)
                        {
                            <MudChip Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">
                                Owner
                            </MudChip>
                        }
                        else if (member.Role == MemberRole.Admin)
                        {
                            <MudChip Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">
                                Admin
                            </MudChip>
                        }

                        @if (CanManageMembers && member.Role != MemberRole.Owner)
                        {
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                @if (IsOwner)
                                {
                                    <MudMenuItem OnClick="@(() => PromoteToAdmin(member))"
                                                 Disabled="@(member.Role == MemberRole.Admin)">
                                        Promote to Admin
                                    </MudMenuItem>
                                    <MudMenuItem OnClick="@(() => DemoteToMember(member))"
                                                 Disabled="@(member.Role == MemberRole.Member)">
                                        Demote to Member
                                    </MudMenuItem>
                                    <MudDivider />
                                }
                                <MudMenuItem OnClick="@(() => RemoveMember(member))" Class="text-error">
                                    Remove from Channel
                                </MudMenuItem>
                            </MudMenu>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .member-list {
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--mud-palette-background-grey);
    }

    .member-item {
        transition: background-color 0.2s;
        cursor: pointer;
    }

    .member-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .role-group {
        margin-bottom: 8px;
    }

    .role-header {
        background-color: rgba(0, 0, 0, 0.02);
    }
</style>

@code {
    [Parameter] public Guid ChannelId { get; set; }
    [Parameter] public bool CanManageMembers { get; set; }
    [Parameter] public bool IsOwner { get; set; }

    private List<ChannelMemberDto> _members = new();
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadMembers();
    }

    private async Task LoadMembers()
    {
        _isLoading = true;

        var result = await MemberService.GetMembersAsync(ChannelId);

        _isLoading = false;

        if (result.IsSuccess)
        {
            _members = result.Data ?? new();
        }
    }

    private void OpenAddMemberDialog()
    {
        // In a full implementation, open a dialog to select and add users
        Snackbar.Add("Add member functionality - coming soon", Severity.Info);
    }

    private async Task PromoteToAdmin(ChannelMemberDto member)
    {
        var request = new UpdateMemberRoleRequest { NewRole = MemberRole.Admin };
        var result = await MemberService.UpdateMemberRoleAsync(ChannelId, member.UserId, request);

        if (result.IsSuccess)
        {
            Snackbar.Add($"{member.DisplayName} promoted to Admin", Severity.Success);
            await LoadMembers();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to update role", Severity.Error);
        }
    }

    private async Task DemoteToMember(ChannelMemberDto member)
    {
        var request = new UpdateMemberRoleRequest { NewRole = MemberRole.Member };
        var result = await MemberService.UpdateMemberRoleAsync(ChannelId, member.UserId, request);

        if (result.IsSuccess)
        {
            Snackbar.Add($"{member.DisplayName} demoted to Member", Severity.Success);
            await LoadMembers();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to update role", Severity.Error);
        }
    }

    private async Task RemoveMember(ChannelMemberDto member)
    {
        var result = await MemberService.RemoveMemberAsync(ChannelId, member.UserId);

        if (result.IsSuccess)
        {
            Snackbar.Add($"{member.DisplayName} removed from channel", Severity.Success);
            await LoadMembers();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to remove member", Severity.Error);
        }
    }

    private string GetRoleLabel(MemberRole role) => role switch
    {
        MemberRole.Owner => "Owner",
        MemberRole.Admin => "Admins",
        MemberRole.Member => "Members",
        _ => "Unknown"
    };

    private Color GetRoleColor(MemberRole role) => role switch
    {
        MemberRole.Owner => Color.Warning,
        MemberRole.Admin => Color.Info,
        MemberRole.Member => Color.Primary,
        _ => Color.Default
    };
}
