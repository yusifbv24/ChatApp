<div class="message-input-container @(IsEditing ? "editing" : "") @(IsReplying ? "replying" : "")">
    @if (IsEditing)
    {
        <div class="edit-indicator">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
            <span>Editing message</span>
            <button class="cancel-edit-btn" @onclick="CancelEdit">
                <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
            </button>
        </div>
    }

    @if (IsReplying && !string.IsNullOrEmpty(ReplyToSenderName))
    {
        <div class="reply-indicator">
            <MudIcon Icon="@Icons.Material.Filled.Reply" Size="Size.Small" />
            <div class="reply-info">
                <span class="reply-to-name">Replying to @ReplyToSenderName</span>
                @if (!string.IsNullOrEmpty(ReplyToFileId))
                {
                    <div class="reply-file-preview">
                        <div class="reply-file-icon @GetFileIconClass(ReplyToFileName)">
                            <MudIcon Icon="@GetFileIcon(ReplyToFileName)" Size="Size.Small" />
                        </div>
                        <span class="reply-file-name">@ReplyToFileName</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(ReplyToContent))
                {
                    <span class="reply-to-preview">@StringHelper.TruncateText(ReplyToContent, 60)</span>
                }
            </div>
            <button class="cancel-reply-btn" @onclick="CancelReply">
                <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
            </button>
        </div>
    }

    @if (!UserState.HasPermission("Messages.Send"))
    {
        <div class="input-bubble disabled-input">
            <div class="permission-denied-message">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                <span>You don't have permission to send messages</span>
            </div>
        </div>
    }
    else
    {
        <div class="input-bubble">
            <!-- Hidden file input -->
            <InputFile @ref="fileInputRef" OnChange="HandleFileSelection" multiple style="display: none;" />

            <!-- Top row: attach icon + textarea -->
            <div class="input-top-row">
                @if (UserState.HasPermission(Permissions.FilesUpload))
                {
                    <button class="input-icon-btn attach-btn" title="Attach file" @onclick="OnAttachClick" disabled="@IsSending">
                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" />
                    </button>
                }

                <textarea @ref="textAreaRef"
                          class="message-textarea"
                          placeholder="@Placeholder"
                          value="@MessageText"
                          @oninput="HandleInput"
                          @onkeydown="HandleKeyDown"
                          @onblur="HandleBlur"
                          disabled="@IsSending"
                          maxlength="4000"
                          rows="1"></textarea>
            </div>

            <!-- Bottom row: icons + send -->
            <div class="input-bottom-row">
                <div class="input-actions">
                    <span class="char-counter @(IsNearLimit ? "near-limit" : "") @(IsAtLimit ? "at-limit" : "")">
                        @MessageText.Length/@MaxLength
                    </span>

                    <button class="input-icon-btn emoji-btn" title="Emoji" @onclick="ToggleEmojiPicker" disabled="@IsSending">
                        <MudIcon Icon="@Icons.Material.Filled.EmojiEmotions" Size="Size.Small" />
                    </button>

                    <button class="send-btn @(CanSend ? "active" : "")"
                            title="@(IsEditing ? "Save" : "Send")"
                            @onclick="SendMessage"
                            disabled="@SendButtonDisabled">
                        @if (IsSending)
                        {
                            <div class="send-spinner"></div>
                        }
                        else
                        {
                            <MudIcon Icon="@(IsEditing ? Icons.Material.Filled.Check : Icons.Material.Filled.Send)" Size="Size.Small" />
                        }
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Mention Panel - CONTAINER DAXILINDƏ olmalıdır -->
    @if (showMentionPanel)
    {
        <div @ref="mentionPanelContainerRef" class="mention-panel-wrapper">
            <MentionPanel Users="mentionUsers"
                          SearchQuery="@mentionSearchQuery"
                          OnUserSelected="HandleMentionSelected"
                          OnCancel="HandleMentionCancel" />
        </div>
    }
</div>

<!-- Emoji Picker -->
@if (showEmojiPicker)
{
    <div class="emoji-picker-overlay" @onclick="CloseEmojiPicker">
        <div class="emoji-picker" @onclick:stopPropagation="true">
            <div class="emoji-picker-header">
                <span>Emoji</span>
                <button class="close-picker-btn" @onclick="CloseEmojiPicker">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>
            <div class="emoji-grid">
                @foreach (var emoji in CommonEmojis)
                {
                    <button class="emoji-btn" @onclick="() => InsertEmoji(emoji)">@emoji</button>
                }
            </div>
        </div>
    </div>
}

<!-- File Selection Panel -->
@if (showFileSelectionPanel && selectedFiles.Count > 0)
{
    <FileSelectionPanel SelectedFiles="selectedFiles"
                       OnClose="HandleCloseFilePanel"
                       OnSend="HandleSendWithFiles"
                       OnRetry="HandleRetryFile" />
}