<div class="conversation-list">
    <!-- Header with New Button -->
    <div class="conversation-list-header">
        <h2>Chats</h2>
        <div class="new-chat-wrapper">
            @if(UserState.HasPermission("Messages.Send") || UserState.HasPermission("Groups.Create"))
            {
                <button class="new-chat-btn" @onclick="ToggleNewMenu">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                </button>
            }
            
            @if (showNewMenu)
            {
                <div class="new-menu-overlay" @onclick="CloseNewMenu"></div>
                <div class="new-menu">
                    @if (UserState.HasPermission("Messages.Send"))
                    {
                        <button class="new-menu-item" @onclick="OnNewConversationClick">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                            <div class="new-menu-item-text">
                                <span class="new-menu-item-title">New Message</span>
                                <span class="new-menu-item-desc">Start a private conversation</span>
                            </div>
                        </button>
                    }
                    
                    @if (UserState.HasPermission("Groups.Create"))
                    {
                        <button class="new-menu-item" @onclick="OnNewChannelClick">
                            <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" />
                            <div class="new-menu-item-text">
                                <span class="new-menu-item-title">New Group</span>
                                <span class="new-menu-item-desc">Create a group chat</span>
                            </div>
                        </button>
                    }
                
                </div>
            }
        
        </div>
    </div>


    <!-- Search Bar -->
    <div class="conversation-search">
        <div class="search-input-wrapper">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="search-icon" Size="Size.Small"/>
            <input type="text"
                   class="search-input"
                   placeholder="Search or start new chat"
                   @bind="SearchTerm"
                   @bind:event="oninput" />

            @if (!string.IsNullOrEmpty(SearchTerm))
            {
                <button class="search-clear" @onclick="ClearSearch">
                    <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                </button>
            }
        </div>
    </div>


    <!-- Unified Conversation List -->
    <div class="conversation-items" @onscroll="HandleScroll">
        @if (IsLoading)
        {
            <div class="conversation-loading">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
        }
        else if (UnifiedList.Any() && UserState.HasPermission("Messages.Read"))
        {
            @foreach(var item in UnifiedList)
            {
                @if (item.IsChannel)
                {
                    <!-- Channel Item -->
                    <div @key="item.Id" class="conversation-item @(SelectedChannelId == item.Id ? "selected" : "")"
                         @onclick="()=> SelectChannelItem(item)"
                         @onmouseenter="()=> HandleMouseEnter(item.Id)"
                         @onmouseleave="HandleMouseLeave"
                         @oncontextmenu:preventDefault="true"
                         @oncontextmenu="()=> HandleContextMenu(item.Id)">
                        <div class="conversation-avatar group-avatar" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.Id);">
                            <span class="group-initials">@StringHelper.GetInitials(item.Name)</span>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name-wrapper">
                                    <span class="conversation-name">@item.Name</span>
                                    @if (item.IsMuted)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.VolumeOff" Class="conv-mute-icon" />
                                    }
                                </div>
                                <div class="conversation-meta">
                                    @if (item.IsMyLastMessage && !string.IsNullOrEmpty(item.LastMessageStatus) && item.UnreadCount == 0)
                                    {
                                        <MudIcon Icon="@GetStatusIcon(item.LastMessageStatus)"
                                                 Class="@($"status-icon {(item.LastMessageStatus == "Read" ? "read" : "")}")"
                                                 Size="Size.Small" />
                                    }
                                    @if (item.LastActivityTime.HasValue)
                                    {
                                        <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                    }
                                </div>
                            </div>
                            <div class="conversation-preview">
                                <div class="preview-content">
                                    @if (ChannelTypingUsers.TryGetValue(item.Id, out var typingUsers) && typingUsers.Any())
                                    {
                                        <span class="preview-text typing-preview">
                                            @if (typingUsers.Count == 1)
                                            {
                                                <text>@typingUsers[0] is typing...</text>
                                            }
                                            else if (typingUsers.Count == 2)
                                            {
                                                <text>@typingUsers[0] and @typingUsers[1] are typing...</text>
                                            }
                                            else
                                            {
                                                <text>@typingUsers.Count people are typing...</text>
                                            }
                                        </span>
                                    }
                                    else if (item.HasDraft)
                                    {
                                        <span class="preview-text draft-preview">
                                            <span class="draft-label">Draft:</span> @item.DraftText
                                        </span>
                                    }
                                    else if (!string.IsNullOrEmpty(item.LastMessage))
                                    {
                                        @if (item.IsMyLastMessage)
                                        {
                                            <span class="preview-text my-message-preview">
                                                <MudIcon Icon="@Icons.Material.Filled.Reply" Class="reply-icon" Size="Size.Small" />
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="preview-text other-message-preview">
                                                @if (!string.IsNullOrEmpty(item.LastMessageSenderAvatarUrl))
                                                {
                                                    <img src="@item.LastMessageSenderAvatarUrl" alt="Sender" class="sender-avatar-preview" />
                                                }
                                                else
                                                {
                                                    <div class="sender-avatar-placeholder">?</div>
                                                }
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="preview-text">@($"{item.MemberCount} members")</span>
                                    }
                                    @if (item.HasUnreadMentions)
                                    {
                                        <span class="mention-indicator">@@</span>
                                    }
                                    @if (item.IsMarkedReadLater || item.LastReadLaterMessageId.HasValue)
                                    {
                                        <span class="read-later-badge">
                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        </span>
                                    }
                                </div>
                                <div class="preview-actions">
                                    @if (item.UnreadCount > 0)
                                    {
                                        <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                    }
                                    @if (item.IsPinned)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.PushPin" Class="conv-status-icon pin-icon" />
                                    }
                                    <button class="conversation-more-btn @(hoveredItemId == item.Id || showMoreMenu && moreMenuItemId == item.Id ? "visible" : "")"
                                            @onclick:stopPropagation="true"
                                            @onclick="()=> ToggleMoreMenu(item.Id)">
                                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- More Menu Panel -->
                        @if (showMoreMenu && moreMenuItemId == item.Id)
                        {
                            <div class="conversation-more-menu" @onclick:stopPropagation="true">
                                @if (item.LastReadLaterMessageId.HasValue || item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await MarkChannelAllAsRead(item.Id); CloseMoreMenu(); }">
                                        <span>Mark all as read</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="menu-item" @onclick="async () => { await ToggleMarkChannelAsReadLater(item.Id); CloseMoreMenu(); }">
                                        <span>Mark to read later</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await TogglePinChannel(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsPinned ? "Unpin" : "Pin")</span>
                                </button>
                                <button class="menu-item" @onclick="async () => { await ToggleMuteChannel(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsMuted ? "Unmute" : "Mute")</span>
                                </button>
                                @if (item.LastMessageId.HasValue)
                                {
                                    <button class="menu-item" @onclick="async () => { await HideChannel(item.Id); CloseMoreMenu(); }">
                                        <span>Hide</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await OnChannelLeave.InvokeAsync(item.Id); CloseMoreMenu(); }">
                                    <span>Leave</span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Direct Conversation Item -->
                    <div @key="item.Id" class="conversation-item @(SelectedConversationId == item.Id ? "selected": "") @(item.IsNotes ? "notes-conversation" : "")"
                         @onclick="()=>SelectConversationItem(item)"
                         @onmouseenter="()=> HandleMouseEnter(item.Id)"
                         @onmouseleave="HandleMouseLeave"
                         @oncontextmenu:preventDefault="true"
                         @oncontextmenu="()=> HandleContextMenu(item.Id)">
                        <div class="conversation-avatar @(item.IsNotes ? "notes-avatar" : "")">
                            @if (item.IsNotes)
                            {
                                <div class="notes-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Medium" />
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(item.AvatarUrl))
                            {
                                <img src="@item.AvatarUrl" alt="@item.Name" />
                            }
                            else
                            {
                                <div class="avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.OtherUserId ?? item.Id);">@StringHelper.GetInitials(item.Name)</div>
                            }
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name-wrapper">
                                    <span class="conversation-name @(item.IsNotes ? "notes-name" : "")">@item.Name</span>
                                    @if (item.IsMuted)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.VolumeOff" Class="conv-mute-icon" />
                                    }
                                </div>
                                <div class="conversation-meta">
                                    @if (item.IsMyLastMessage && !string.IsNullOrEmpty(item.LastMessageStatus) && item.UnreadCount == 0)
                                    {
                                        <MudIcon Icon="@GetStatusIcon(item.LastMessageStatus)"
                                                 Class="@($"status-icon {(item.LastMessageStatus == "Read" ? "read" : "")}")"
                                                 Size="Size.Small" />
                                    }
                                    @if (item.LastActivityTime.HasValue)
                                    {
                                        <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                    }
                                </div>
                            </div>
                            <div class="conversation-preview">
                                <div class="preview-content">
                                    @if (ConversationTypingState.GetValueOrDefault(item.Id, false))
                                    {
                                        <span class="preview-text typing-preview">typing...</span>
                                    }
                                    else if (item.HasDraft)
                                    {
                                        <span class="preview-text draft-preview">
                                            <span class="draft-label">Draft:</span> @item.DraftText
                                        </span>
                                    }
                                    else if (!string.IsNullOrEmpty(item.LastMessage))
                                    {
                                        @if (item.IsMyLastMessage)
                                        {
                                            <span class="preview-text my-message-preview">
                                                <MudIcon Icon="@Icons.Material.Filled.Reply" Class="reply-icon" Size="Size.Small" />
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="preview-text">@item.LastMessage</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="preview-text">No messages yet</span>
                                    }
                                    @if (item.HasUnreadMentions)
                                    {
                                        <span class="mention-indicator">@@</span>
                                    }
                                    @if (item.IsMarkedReadLater || item.LastReadLaterMessageId.HasValue)
                                    {
                                        <span class="read-later-badge">
                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        </span>
                                    }
                                </div>
                                <div class="preview-actions">
                                    @if (item.UnreadCount > 0)
                                    {
                                        <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                    }
                                    @if (item.IsPinned)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.PushPin" Class="conv-status-icon pin-icon" />
                                    }
                                    <button class="conversation-more-btn @(hoveredItemId == item.Id || showMoreMenu && moreMenuItemId == item.Id ? "visible" : "")"
                                            @onclick:stopPropagation="true"
                                            @onclick="()=> ToggleMoreMenu(item.Id)">
                                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- More Menu Panel (DM) -->
                        @if (showMoreMenu && moreMenuItemId == item.Id)
                        {
                            <div class="conversation-more-menu" @onclick:stopPropagation="true">
                                @if (item.LastReadLaterMessageId.HasValue || item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await MarkConversationAllAsRead(item.Id); CloseMoreMenu(); }">
                                        <span>Mark all as read</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="menu-item" @onclick="async () => { await ToggleMarkConversationAsReadLater(item.Id); CloseMoreMenu(); }">
                                        <span>Mark to read later</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await TogglePinConversation(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsPinned ? "Unpin" : "Pin")</span>
                                </button>
                                <button class="menu-item" @onclick="async () => { await ToggleMuteConversation(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsMuted ? "Unmute" : "Mute")</span>
                                </button>
                                @if (!item.IsNotes)
                                {
                                    @if (item.LastMessageId.HasValue)
                                    {
                                        <button class="menu-item" @onclick="async () => { await HideConversation(item.Id); CloseMoreMenu(); }">
                                            <span>Hide</span>
                                        </button>
                                    }
                                    <button class="menu-item" @onclick="CloseMoreMenu">
                                        <span>View profile</span>
                                    </button>
                                    <button class="menu-item" @onclick="() => HandleFindChatsWithUser(item.Id)">
                                        <span>Find chats with this user</span>
                                    </button>
                                }
                            </div>
                        }
                    </div>
                }
            }
        }
        else
        {
            <div class="empty-state">
                <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Class="empty-icon" />
                <p>@(string.IsNullOrEmpty(SearchTerm) ? "No chats yet" : "No results found")</p>
                @if (string.IsNullOrEmpty(SearchTerm))
                {
                    <button class="empty-action-btn" @onclick="() => { showNewMenu = true; }">Start a chat</button>
                }
            </div>
        }
    </div>
</div>