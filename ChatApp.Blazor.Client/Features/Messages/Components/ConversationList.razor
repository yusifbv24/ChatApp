@inject UserState UserState

<div class="conversation-list">
    <!-- Header with New Button -->
    <div class="conversation-list-header">
        <h2>Chats</h2>
        <div class="new-chat-wrapper">
            @if(UserState.HasPermission("Messages.Send") || UserState.HasPermission("Groups.Create"))
            {
                <button class="new-chat-btn" @onclick="ToggleNewMenu">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                </button>
            }
            
            @if (showNewMenu)
            {
                <div class="new-menu-overlay" @onclick="CloseNewMenu"></div>
                <div class="new-menu">
                    @if (UserState.HasPermission("Messages.Send"))
                    {
                        <button class="new-menu-item" @onclick="OnNewConversationClick">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                            <div class="new-menu-item-text">
                                <span class="new-menu-item-title">New Message</span>
                                <span class="new-menu-item-desc">Start a private conversation</span>
                            </div>
                        </button>
                    }
                    
                    @if (UserState.HasPermission("Groups.Create"))
                    {
                        <button class="new-menu-item" @onclick="OnNewChannelClick">
                            <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" />
                            <div class="new-menu-item-text">
                                <span class="new-menu-item-title">New Group</span>
                                <span class="new-menu-item-desc">Create a group chat</span>
                            </div>
                        </button>
                    }
                
                </div>
            }
        
        </div>
    </div>


    <!-- Search Bar -->
    <div class="conversation-search">
        <div class="search-input-wrapper">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="search-icon" Size="Size.Small"/>
            <input type="text"
                   class="search-input"
                   placeholder="Search or start new chat"
                   @bind="SearchTerm"
                   @bind:event="oninput" />

            @if (!string.IsNullOrEmpty(SearchTerm))
            {
                <button class="search-clear" @onclick="ClearSearch">
                    <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                </button>
            }
        </div>
    </div>


    <!-- Unified Conversation List -->
    <div class="conversation-items">
        @if (IsLoading)
        {
            <div class="conversation-loading">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
        }
        else if (UnifiedList.Any() && UserState.HasPermission("Messages.Read"))
        {
            @foreach(var item in UnifiedList)
            {
                @if (item.IsChannel)
                {
                    <!-- Channel Item -->
                    <div class="conversation-item @(SelectedChannelId == item.Id ? "selected" : "")"
                         @onclick="()=> SelectChannelItem(item)">
                        <div class="conversation-avatar group-avatar">
                            <MudIcon Icon="@(item.IsPrivate ? Icons.Material.Filled.Lock : Icons.Material.Filled.Group)"
                                     Class="group-icon" />
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <span class="conversation-name">@item.Name</span>
                                @if (item.LastActivityTime.HasValue)
                                {
                                    <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                }
                            </div>
                            <div class="conversation-preview">
                                @if (ChannelTypingUsers.TryGetValue(item.Id, out var typingUsers) && typingUsers.Any())
                                {
                                    <span class="preview-text typing-preview">
                                        @if (typingUsers.Count == 1)
                                        {
                                            <text>@typingUsers[0] is typing...</text>
                                        }
                                        else if (typingUsers.Count == 2)
                                        {
                                            <text>@typingUsers[0] and @typingUsers[1] are typing...</text>
                                        }
                                        else
                                        {
                                            <text>@typingUsers.Count people are typing...</text>
                                        }
                                    </span>
                                }
                                else if (item.HasDraft)
                                {
                                    <span class="preview-text draft-preview">
                                        <span class="draft-label">Draft:</span> @TruncateMessage(item.DraftText)
                                    </span>
                                }
                                else
                                {
                                    <span class="preview-text">@(item.LastMessage ?? $"{item.MemberCount} members")</span>
                                }
                                @if (item.UnreadCount > 0)
                                {
                                    <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Direct Conversation Item -->
                    <div class="conversation-item @(SelectedConversationId == item.Id ? "selected": "")"
                         @onclick="()=>SelectConversationItem(item)">
                        <div class="conversation-avatar">
                            @if (!string.IsNullOrEmpty(item.AvatarUrl))
                            {
                                <img src="@item.AvatarUrl" alt="@item.Name" />
                            }
                            else
                            {
                                <div class="avatar-placeholder">@GetInitials(item.Name)</div>
                            }
                            <span class="online-indicator @(item.IsOnline ? "online" : "offline")"></span>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <span class="conversation-name">@item.Name</span>
                                @if (item.LastActivityTime.HasValue)
                                {
                                    <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                }
                            </div>
                            <div class="conversation-preview">
                                @if (ConversationTypingState.GetValueOrDefault(item.Id, false))
                                {
                                    <span class="preview-text typing-preview">typing...</span>
                                }
                                else if (item.HasDraft)
                                {
                                    <span class="preview-text draft-preview">
                                        <span class="draft-label">Draft:</span> @TruncateMessage(item.DraftText)
                                    </span>
                                }
                                else
                                {
                                    <span class="preview-text">@TruncateMessage(item.LastMessage)</span>
                                }
                                @if (item.UnreadCount > 0)
                                {
                                    <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        }
        else
        {
            <div class="empty-state">
                <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Class="empty-icon" />
                <p>@(string.IsNullOrEmpty(SearchTerm) ? "No chats yet" : "No results found")</p>
                @if (string.IsNullOrEmpty(SearchTerm))
                {
                    <button class="empty-action-btn" @onclick="() => { showNewMenu = true; }">Start a chat</button>
                }
            </div>
        }
    </div>
</div>

@code{
    [Parameter] public List<DirectConversationDto> Conversations { get; set; } = new();
    [Parameter] public List<ChannelDto> Channels { get; set; } = new();
    [Parameter] public Guid? SelectedConversationId { get; set; }
    [Parameter] public Guid? SelectedChannelId { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public Dictionary<Guid, bool> ConversationTypingState { get; set; } = new();
    [Parameter] public Dictionary<Guid, List<string>> ChannelTypingUsers { get; set; } = new();
    [Parameter] public Dictionary<string, string> MessageDrafts { get; set; } = new();
    [Parameter] public EventCallback<DirectConversationDto> OnConversationSelected { get; set; }
    [Parameter] public EventCallback<ChannelDto> OnChannelSelected { get; set; }
    [Parameter] public EventCallback OnNewConversation { get; set; }
    [Parameter] public EventCallback OnNewChannel { get; set; }

    private string SearchTerm { get; set; } = string.Empty;
    private bool showNewMenu = false;

    // Unified list item model
    private class UnifiedChatItem
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string? AvatarUrl { get; set; }
        public string? LastMessage { get; set; }
        public DateTime? LastActivityTime { get; set; }
        public int UnreadCount { get; set; }
        public bool IsOnline { get; set; }
        public bool IsChannel { get; set; }
        public bool IsPrivate { get; set; } // For channels: private or public
        public int MemberCount { get; set; } // For channels
        public bool HasDraft { get; set; } // Draft indicator
        public string? DraftText { get; set; } // Draft content preview

        // Original references for selection
        public DirectConversationDto? DirectConversation { get; set; }
        public ChannelDto? Channel { get; set; }
    }

    private IEnumerable<UnifiedChatItem> UnifiedList
    {
        get
        {
            var items = new List<UnifiedChatItem>();

            // Add direct conversations
            foreach (var conv in Conversations)
            {
                // Check for draft - but hide if currently selected (user is typing)
                var draftKey = $"conv_{conv.Id}";
                var isSelected = SelectedConversationId == conv.Id;
                MessageDrafts.TryGetValue(draftKey, out var draftText);
                var hasDraft = !isSelected && !string.IsNullOrWhiteSpace(draftText);

                items.Add(new UnifiedChatItem
                {
                    Id = conv.Id,
                    Name = conv.OtherUserDisplayName,
                    AvatarUrl = conv.OtherUserAvatarUrl,
                    LastMessage = conv.LastMessageContent,
                    LastActivityTime = conv.LastMessageAtUtc,
                    UnreadCount = conv.UnreadCount,
                    IsOnline = conv.IsOtherUserOnline,
                    IsChannel = false,
                    HasDraft = hasDraft,
                    DraftText = hasDraft ? draftText : null,
                    DirectConversation = conv
                });
            }

            // Add channels
            foreach (var channel in Channels)
            {
                // Format last message as "SenderName: Message" if available
                string? lastMessage = null;
                if (!string.IsNullOrEmpty(channel.LastMessageContent) && !string.IsNullOrEmpty(channel.LastMessageSenderName))
                {
                    lastMessage = $"{channel.LastMessageSenderName}: {channel.LastMessageContent}";
                }

                // Check for draft - but hide if currently selected (user is typing)
                var draftKey = $"chan_{channel.Id}";
                var isSelected = SelectedChannelId == channel.Id;
                MessageDrafts.TryGetValue(draftKey, out var draftText);
                var hasDraft = !isSelected && !string.IsNullOrWhiteSpace(draftText);

                items.Add(new UnifiedChatItem
                {
                    Id = channel.Id,
                    Name = channel.Name,
                    LastMessage = lastMessage,
                    LastActivityTime = channel.LastMessageAtUtc ?? channel.CreatedAtUtc,
                    UnreadCount = channel.UnreadCount,
                    IsChannel = true,
                    IsPrivate = channel.Type == ChannelType.Private,
                    MemberCount = channel.MemberCount,
                    HasDraft = hasDraft,
                    DraftText = hasDraft ? draftText : null,
                    Channel = channel
                });
            }

            // Filter by search term
            if (!string.IsNullOrEmpty(SearchTerm))
            {
                items = items.Where(i =>
                    i.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)
                ).ToList();
            }

            // Sort by last activity (most recent first)
            return items.OrderByDescending(i => i.LastActivityTime ?? DateTime.MinValue);
        }
    }

    private void ToggleNewMenu()
    {
        showNewMenu = !showNewMenu;
    }

    private void CloseNewMenu()
    {
        showNewMenu = false;
    }

    private void ClearSearch()
    {
        SearchTerm = "";
    }

    private async Task SelectConversationItem(UnifiedChatItem item)
    {
        if (item.DirectConversation != null)
        {
            await OnConversationSelected.InvokeAsync(item.DirectConversation);
        }
    }

    private async Task SelectChannelItem(UnifiedChatItem item)
    {
        if (item.Channel != null)
        {
            await OnChannelSelected.InvokeAsync(item.Channel);
        }
    }

    private async Task OnNewConversationClick()
    {
        showNewMenu = false;
        await OnNewConversation.InvokeAsync();
    }

    private async Task OnNewChannelClick()
    {
        showNewMenu = false;
        await OnNewChannel.InvokeAsync();
    }

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[1][0]}".ToUpper()
            : name[0].ToString().ToUpper();
    }

    private string FormatTime(DateTime dateTime)
    {
        var now = DateTime.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalMinutes < 1) return "Now";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalHours < 24) return dateTime.ToLocalTime().ToString("HH:mm");
        if (diff.TotalDays < 7) return dateTime.ToLocalTime().ToString("ddd");
        return dateTime.ToLocalTime().ToString("dd/MM/yy");
    }

    private string TruncateMessage(string? message)
    {
        if (string.IsNullOrEmpty(message)) return "No messages yet";
        return message.Length > 35 ? message[..35] + "..." : message;
    }
}