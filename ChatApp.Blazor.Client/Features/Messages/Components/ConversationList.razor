<div class="conversation-list">
    <!-- Header Toolbar (Bitrix24 style) -->
    <div class="conversation-toolbar">
        <!-- Filter Button with Dropdown -->
        <div class="filter-button-container">
            <button class="toolbar-btn @(showFilterPanel ? "active" : "")"
                    title="Filter"
                    @onclick="ToggleFilterPanel"
                    @onclick:stopPropagation="true">
                <MudIcon Icon="@Icons.Material.Outlined.FilterList" Size="Size.Small" />
            </button>

            @if (showFilterPanel)
            {
                <div class="filter-dropdown-panel" @onclick:stopPropagation="true">
                    <button class="menu-item" @onclick="MarkAllAsRead">
                        <span>Mark all as read</span>
                    </button>
                </div>
            }
        </div>

        <!-- Search Input -->
        <div class="toolbar-search @(isSearchMode ? "search-active" : "")">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="toolbar-search-icon" Size="Size.Small" />
            <input type="text"
                   class="toolbar-search-input"
                   placeholder="Find employee or chat"
                   @bind="SearchTerm"
                   @bind:event="oninput"
                   @onfocus="EnterSearchMode"
                   @onblur="HandleSearchBlur" />
            @if (!string.IsNullOrEmpty(SearchTerm) || isSearchMode)
            {
                <button class="toolbar-search-clear" @onclick="ClearSearch" @onclick:stopPropagation="true">
                    <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                </button>
            }
        </div>

        <!-- Create Chat Button -->
        @if (UserState.HasPermission("Channels.Create"))
        {
            <button class="toolbar-btn toolbar-btn-primary" @onclick="OnNewChannelClick" title="Create group">
                <MudIcon Icon="@Icons.Material.Filled.EditNote" Size="Size.Small" />
            </button>
        }
    </div>


    <!-- Search Mode: Unified Search Results (Users + Channels) -->
    @if (isSearchMode)
    {
        <div class="conversation-items search-results-container">
            @if (isSearchingUsers)
            {
                <div class="search-loading">
                    <div class="search-loading-spinner"></div>
                    <span>Searching...</span>
                </div>
            }
            else if (string.IsNullOrWhiteSpace(SearchTerm))
            {
                <div class="search-empty-state">
                    <div class="search-empty-icon">
                        <MudIcon Icon="@Icons.Material.Outlined.Search" Size="Size.Large" />
                    </div>
                    <span class="search-empty-text">Search for people or channels</span>
                    <span class="search-empty-hint">Type at least 2 characters to search</span>
                </div>
            }
            else if (!userSearchResults.Any() && !channelSearchResults.Any())
            {
                <div class="search-empty-state">
                    <div class="search-empty-icon no-results">
                        <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="Size.Large" />
                    </div>
                    <span class="search-empty-text">No results found</span>
                    <span class="search-empty-hint">Try a different search term</span>
                </div>
            }
            else
            {
                <!-- Channels Section -->
                @if (channelSearchResults.Any())
                {
                    <div class="search-section">
                        <div class="search-section-header">
                            <MudIcon Icon="@Icons.Material.Outlined.Tag" Size="Size.Small" Class="section-icon" />
                            <span>Channels</span>
                            <span class="section-count">@channelSearchResults.Count</span>
                        </div>
                        <div class="search-section-items">
                            @foreach (var channel in channelSearchResults)
                            {
                                <div class="search-result-item channel-item" @onclick="() => SelectSearchedChannel(channel)">
                                    <div class="search-result-avatar">
                                        @if (!string.IsNullOrEmpty(channel.AvatarUrl))
                                        {
                                            <img src="@channel.AvatarUrl" alt="@channel.Name" />
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder channel-avatar" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(channel.Id);">
                                                @StringHelper.GetInitials(channel.Name)
                                            </div>
                                        }
                                    </div>
                                    <div class="search-result-info">
                                        <div class="search-result-name">
                                            <span>@channel.Name</span>
                                        </div>
                                        <div class="search-result-meta">
                                            <span class="meta-item">
                                                <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Small" />
                                                @channel.MemberCount members
                                            </span>
                                            @if (!string.IsNullOrEmpty(channel.Description))
                                            {
                                                <span class="meta-description">@channel.Description</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="search-result-action">
                                        <MudIcon Icon="@Icons.Material.Outlined.ArrowForward" Size="Size.Small" />
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- People Section -->
                @if (userSearchResults.Any())
                {
                    <div class="search-section">
                        <div class="search-section-header">
                            <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Small" Class="section-icon" />
                            <span>People</span>
                            <span class="section-count">@userSearchResults.Count</span>
                        </div>
                        <div class="search-section-items">
                            @foreach (var user in userSearchResults)
                            {
                                <div class="search-result-item user-item" @onclick="() => SelectSearchedUser(user)">
                                    <div class="search-result-avatar">
                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                        {
                                            <img src="@user.AvatarUrl" alt="@user.FullName" />
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(user.Id);">
                                                @StringHelper.GetInitials(user.FullName)
                                            </div>
                                        }
                                    </div>
                                    <div class="search-result-info">
                                        <div class="search-result-name">
                                            <span>@user.FullName</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(user.Position))
                                        {
                                            <div class="search-result-meta">
                                                <span class="meta-position">@user.Position</span>
                                            </div>
                                        }
                                    </div>
                                    <div class="search-result-action">
                                        <MudIcon Icon="@Icons.Material.Outlined.Chat" Size="Size.Small" />
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    }
    else
    {
        <!-- Normal Mode: Unified Conversation List -->
        <div class="conversation-items" @onscroll="HandleScroll">
        @if (IsLoading)
        {
            <div class="conversation-loading">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
        }
        else if (UnifiedList.Any() && UserState.HasPermission("Messages.Read"))
        {
            @foreach(var item in UnifiedList)
            {
                @if (item.IsDepartmentUser)
                {
                    <!-- Department User Item (no conversation yet) -->
                    <div @key="@($"dept_{item.Id}")" class="conversation-item department-user-item"
                         @onclick="()=> SelectDepartmentUserItem(item)">
                        <div class="conversation-avatar">
                            @if (!string.IsNullOrEmpty(item.AvatarUrl))
                            {
                                <img src="@item.AvatarUrl" alt="@item.Name" />
                            }
                            else
                            {
                                <div class="avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.OtherUserId ?? item.Id);">@StringHelper.GetInitials(item.Name)</div>
                            }
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <span class="conversation-name">@item.Name</span>
                            </div>
                            <div class="conversation-preview">
                                <span class="preview-text department-position">@(item.LastMessage ?? "Department colleague")</span>
                            </div>
                        </div>
                    </div>
                }
                else if (item.IsChannel)
                {
                    <!-- Channel Item -->
                    <div @key="item.Id" class="conversation-item @(SelectedChannelId == item.Id ? "selected" : "")"
                         @onclick="()=> SelectChannelItem(item)"
                         @onmouseenter="()=> HandleMouseEnter(item.Id)"
                         @onmouseleave="HandleMouseLeave"
                         @oncontextmenu:preventDefault="true"
                         @oncontextmenu="()=> HandleContextMenu(item.Id)">
                        <div class="conversation-avatar group-avatar">
                            @if (!string.IsNullOrEmpty(item.AvatarUrl))
                            {
                                <img src="@item.AvatarUrl" alt="@item.Name" />
                            }
                            else
                            {
                                <div class="avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.Id);">@StringHelper.GetInitials(item.Name)</div>
                            }
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name-wrapper">
                                    <span class="conversation-name">@item.Name</span>
                                    @if (item.IsMuted)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.VolumeOff" Class="conv-mute-icon" />
                                    }
                                </div>
                                <div class="conversation-meta">
                                    @if (item.IsMyLastMessage && !string.IsNullOrEmpty(item.LastMessageStatus) && item.UnreadCount == 0)
                                    {
                                        <MudIcon Icon="@GetStatusIcon(item.LastMessageStatus)"
                                                 Class="@($"status-icon {(item.LastMessageStatus == "Read" ? "read" : "")}")"
                                                 Size="Size.Small" />
                                    }
                                    @if (item.LastActivityTime.HasValue)
                                    {
                                        <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                    }
                                </div>
                            </div>
                            <div class="conversation-preview">
                                <div class="preview-content">
                                    @if (ChannelTypingUsers.TryGetValue(item.Id, out var typingUsers) && typingUsers.Any())
                                    {
                                        <span class="preview-text typing-preview">
                                            @if (typingUsers.Count == 1)
                                            {
                                                <text>@typingUsers[0] is typing...</text>
                                            }
                                            else if (typingUsers.Count == 2)
                                            {
                                                <text>@typingUsers[0] and @typingUsers[1] are typing...</text>
                                            }
                                            else
                                            {
                                                <text>@typingUsers.Count people are typing...</text>
                                            }
                                        </span>
                                    }
                                    else if (item.HasDraft)
                                    {
                                        <span class="preview-text draft-preview">
                                            <span class="draft-label">Draft:</span> @item.DraftText
                                        </span>
                                    }
                                    else if (!string.IsNullOrEmpty(item.LastMessage))
                                    {
                                        @if (item.IsMyLastMessage)
                                        {
                                            <span class="preview-text my-message-preview">
                                                <MudIcon Icon="@Icons.Material.Filled.Reply" Class="reply-icon" Size="Size.Small" />
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="preview-text other-message-preview">
                                                @if (!string.IsNullOrEmpty(item.LastMessageSenderAvatarUrl))
                                                {
                                                    <img src="@item.LastMessageSenderAvatarUrl" alt="Sender" class="sender-avatar-preview" />
                                                }
                                                else
                                                {
                                                    <div class="sender-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.Channel?.LastMessageSenderId ?? item.Id)">@StringHelper.GetInitials(item.LastMessageSenderFullName)</div>
                                                }
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="preview-text">@($"{item.MemberCount} members")</span>
                                    }
                                    @if (item.HasUnreadMentions)
                                    {
                                        <span class="mention-indicator">@@</span>
                                    }
                                    @if (item.IsMarkedReadLater || item.LastReadLaterMessageId.HasValue)
                                    {
                                        <span class="read-later-badge">
                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        </span>
                                    }
                                </div>
                                <div class="preview-actions">
                                    @if (item.UnreadCount > 0)
                                    {
                                        <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                    }
                                    @if (item.IsPinned)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.PushPin" Class="conv-status-icon pin-icon" />
                                    }
                                    <button class="conversation-more-btn @(hoveredItemId == item.Id || showMoreMenu && moreMenuItemId == item.Id ? "visible" : "")"
                                            @onclick:stopPropagation="true"
                                            @onclick="()=> ToggleMoreMenu(item.Id)"
                                            aria-label="More options"
                                            title="More options">
                                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- More Menu Panel -->
                        @if (showMoreMenu && moreMenuItemId == item.Id)
                        {
                            <div class="conversation-more-menu" @onclick:stopPropagation="true">
                                @if (item.UnreadCount > 0 || item.LastReadLaterMessageId.HasValue || item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await MarkChannelAllAsRead(item.Id); CloseMoreMenu(); }">
                                        <span>Mark all as read</span>
                                    </button>
                                }
                                @if (item.UnreadCount == 0 && !item.LastReadLaterMessageId.HasValue && !item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await ToggleMarkChannelAsReadLater(item.Id); CloseMoreMenu(); }">
                                        <span>Mark to read later</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await TogglePinChannel(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsPinned ? "Unpin" : "Pin")</span>
                                </button>
                                <button class="menu-item" @onclick="async () => { await ToggleMuteChannel(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsMuted ? "Unmute" : "Mute")</span>
                                </button>
                                @if (item.LastMessageId.HasValue)
                                {
                                    <button class="menu-item" @onclick="async () => { await HideChannel(item.Id); CloseMoreMenu(); }">
                                        <span>Hide</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await OnChannelLeave.InvokeAsync(item.Id); CloseMoreMenu(); }">
                                    <span>Leave</span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Direct Conversation Item -->
                    <div @key="item.Id" class="conversation-item @(SelectedConversationId == item.Id ? "selected": "") @(item.IsNotes ? "notes-conversation" : "")"
                         @onclick="()=>SelectConversationItem(item)"
                         @onmouseenter="()=> HandleMouseEnter(item.Id)"
                         @onmouseleave="HandleMouseLeave"
                         @oncontextmenu:preventDefault="true"
                         @oncontextmenu="()=> HandleContextMenu(item.Id)">
                        <div class="conversation-avatar @(item.IsNotes ? "notes-avatar" : "")">
                            @if (item.IsNotes)
                            {
                                <div class="notes-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Medium" />
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(item.AvatarUrl))
                            {
                                <img src="@item.AvatarUrl" alt="@item.Name" />
                            }
                            else
                            {
                                <div class="avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.OtherUserId ?? item.Id);">@StringHelper.GetInitials(item.Name)</div>
                            }
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <div class="conversation-name-wrapper">
                                    <span class="conversation-name @(item.IsNotes ? "notes-name" : "")">@item.Name</span>
                                    @if (item.IsMuted)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.VolumeOff" Class="conv-mute-icon" />
                                    }
                                </div>
                                <div class="conversation-meta">
                                    @if (item.IsMyLastMessage && !string.IsNullOrEmpty(item.LastMessageStatus) && item.UnreadCount == 0)
                                    {
                                        <MudIcon Icon="@GetStatusIcon(item.LastMessageStatus)"
                                                 Class="@($"status-icon {(item.LastMessageStatus == "Read" ? "read" : "")}")"
                                                 Size="Size.Small" />
                                    }
                                    @if (item.LastActivityTime.HasValue)
                                    {
                                        <span class="conversation-time">@FormatTime(item.LastActivityTime.Value)</span>
                                    }
                                </div>
                            </div>
                            <div class="conversation-preview">
                                <div class="preview-content">
                                    @if (ConversationTypingState.GetValueOrDefault(item.Id, false))
                                    {
                                        <span class="preview-text typing-preview">typing...</span>
                                    }
                                    else if (item.HasDraft)
                                    {
                                        <span class="preview-text draft-preview">
                                            <span class="draft-label">Draft:</span> @item.DraftText
                                        </span>
                                    }
                                    else if (!string.IsNullOrEmpty(item.LastMessage))
                                    {
                                        @if (item.IsMyLastMessage)
                                        {
                                            <span class="preview-text my-message-preview">
                                                <MudIcon Icon="@Icons.Material.Filled.Reply" Class="reply-icon" Size="Size.Small" />
                                                <span class="message-content">@item.LastMessage</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="preview-text">@item.LastMessage</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="preview-text">No messages yet</span>
                                    }
                                    @if (item.HasUnreadMentions)
                                    {
                                        <span class="mention-indicator">@@</span>
                                    }
                                    @if (item.IsMarkedReadLater || item.LastReadLaterMessageId.HasValue)
                                    {
                                        <span class="read-later-badge">
                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        </span>
                                    }
                                </div>
                                <div class="preview-actions">
                                    @if (item.UnreadCount > 0)
                                    {
                                        <span class="unread-badge">@(item.UnreadCount > 99 ? "99+" : item.UnreadCount.ToString())</span>
                                    }
                                    @if (item.IsPinned)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.PushPin" Class="conv-status-icon pin-icon" />
                                    }
                                    <button class="conversation-more-btn @(hoveredItemId == item.Id || showMoreMenu && moreMenuItemId == item.Id ? "visible" : "")"
                                            @onclick:stopPropagation="true"
                                            @onclick="()=> ToggleMoreMenu(item.Id)"
                                            aria-label="More options"
                                            title="More options">
                                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- More Menu Panel (DM) -->
                        @if (showMoreMenu && moreMenuItemId == item.Id)
                        {
                            <div class="conversation-more-menu" @onclick:stopPropagation="true">
                                @if (item.UnreadCount > 0 || item.LastReadLaterMessageId.HasValue || item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await MarkConversationAllAsRead(item.Id); CloseMoreMenu(); }">
                                        <span>Mark all as read</span>
                                    </button>
                                }
                                @if (item.UnreadCount == 0 && !item.LastReadLaterMessageId.HasValue && !item.IsMarkedReadLater)
                                {
                                    <button class="menu-item" @onclick="async () => { await ToggleMarkConversationAsReadLater(item.Id); CloseMoreMenu(); }">
                                        <span>Mark to read later</span>
                                    </button>
                                }
                                <button class="menu-item" @onclick="async () => { await TogglePinConversation(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsPinned ? "Unpin" : "Pin")</span>
                                </button>
                                <button class="menu-item" @onclick="async () => { await ToggleMuteConversation(item.Id); CloseMoreMenu(); }">
                                    <span>@(item.IsMuted ? "Unmute" : "Mute")</span>
                                </button>
                                @if (!item.IsNotes)
                                {
                                    @if (item.LastMessageId.HasValue)
                                    {
                                        <button class="menu-item" @onclick="async () => { await HideConversation(item.Id); CloseMoreMenu(); }">
                                            <span>Hide</span>
                                        </button>
                                    }
                                    <button class="menu-item" @onclick="CloseMoreMenu">
                                        <span>View profile</span>
                                    </button>
                                    <button class="menu-item" @onclick="() => HandleFindChatsWithUser(item.Id)">
                                        <span>Find chats with this user</span>
                                    </button>
                                }
                            </div>
                        }
                    </div>
                }
            }
        }
        else
        {
            <div class="empty-state">
                <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Class="empty-icon" />
                <p>@(string.IsNullOrEmpty(SearchTerm) ? "No chats yet" : "No results found")</p>
                @if (string.IsNullOrEmpty(SearchTerm))
                {
                    <button class="empty-action-btn" @onclick="OnNewChannelClick">Start a chat</button>
                }
            </div>
        }

            @if (IsLoadingMore)
            {
                <div class="conversation-loading-more">
                    <div class="loading-spinner small"></div>
                </div>
            }
        </div>
    }
</div>