<div class="sidebar-panel" @onclick="CloseContextMenu" @onclick:stopPropagation="false">
    @if (showFavoritesPanel)
    {
        <!-- Favorites Panel -->
        <div class="sidebar-favorites-panel">
            <div class="sidebar-header-panel">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <button class="sidebar-close-btn" @onclick="CloseFavoritesPanel" @onclick:stopPropagation="true">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                        </button>
                        <span class="sidebar-title">Favorite messages</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-favorites-content">
                @if (isLoadingFavorites)
                {
                    <div class="favorites-loading">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    </div>
                }
                else if (IsDirectMessage && (FavoriteDirectMessages == null || !FavoriteDirectMessages.Any()))
                {
                    <div class="favorites-empty">
                        <MudIcon Icon="@Icons.Material.Outlined.StarBorder" Size="Size.Large" Class="favorites-empty-icon" />
                        <span>No favorite messages</span>
                    </div>
                }
                else if (!IsDirectMessage && (FavoriteChannelMessages == null || !FavoriteChannelMessages.Any()))
                {
                    <div class="favorites-empty">
                        <MudIcon Icon="@Icons.Material.Outlined.StarBorder" Size="Size.Large" Class="favorites-empty-icon" />
                        <span>No favorite messages</span>
                    </div>
                }
                else
                {
                    @if (IsDirectMessage && FavoriteDirectMessages != null)
                    {
                        @foreach (var group in GroupedDirectFavorites)
                        {
                            <div class="favorites-date-divider">
                                <span>@FormatDate(group.Key)</span>
                            </div>
                            @foreach (var message in GetOrderedDirectMessages(group))
                            {
                                <div class="favorites-message-item"
                                     @onmouseenter="() => hoveredMessageId = message.Id"
                                     @onmouseleave="() => { if (activeMenuMessageId != message.Id) hoveredMessageId = null; }">
                                    <div class="favorites-message-avatar">
                                        @if (!string.IsNullOrEmpty(message.SenderAvatarUrl))
                                        {
                                            <img src="@message.SenderAvatarUrl" alt="@message.SenderFullName" />
                                        }
                                        else
                                        {
                                            <div class="favorites-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(message.SenderId);">@StringHelper.GetInitials(message.SenderFullName)</div>
                                        }
                                    </div>
                                    <div class="favorites-message-content" @onclick="() => NavigateToMessage(message.Id)">
                                        <div class="favorites-sender-name">@message.SenderFullName</div>
                                        <div class="favorites-message-text @(message.IsDeleted ? "deleted" : "")">
                                            @GetFilePreview(message)
                                        </div>
                                    </div>
                                    <div class="favorites-message-actions">
                                        @if (hoveredMessageId == message.Id || activeMenuMessageId == message.Id)
                                        {
                                            <button class="favorites-menu-btn" @onclick="() => ToggleMessageMenu(message.Id)" @onclick:stopPropagation="true">
                                                <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" />
                                            </button>
                                        }
                                        @if (activeMenuMessageId == message.Id)
                                        {
                                            <div class="favorites-context-menu" @onclick:stopPropagation="true">
                                                <button class="context-menu-item" @onclick="() => HandleViewContext(message.Id)">
                                                    <span>View context</span>
                                                </button>
                                                <button class="context-menu-item" @onclick="() => HandleRemoveFromFavorites(message.Id)">
                                                    <span>Remove from favorites</span>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                    else if (!IsDirectMessage && FavoriteChannelMessages != null)
                    {
                        @foreach (var group in GroupedChannelFavorites)
                        {
                            <div class="favorites-date-divider">
                                <span>@FormatDate(group.Key)</span>
                            </div>
                            @foreach (var message in GetOrderedChannelMessages(group))
                            {
                                <div class="favorites-message-item"
                                     @onmouseenter="() => hoveredMessageId = message.Id"
                                     @onmouseleave="() => { if (activeMenuMessageId != message.Id) hoveredMessageId = null; }">
                                    <div class="favorites-message-avatar">
                                        @if (!string.IsNullOrEmpty(message.SenderAvatarUrl))
                                        {
                                            <img src="@message.SenderAvatarUrl" alt="@message.SenderFullName" />
                                        }
                                        else
                                        {
                                            <div class="favorites-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(message.SenderId);">@StringHelper.GetInitials(message.SenderFullName)</div>
                                        }
                                    </div>
                                    <div class="favorites-message-content" @onclick="() => NavigateToMessage(message.Id)">
                                        <div class="favorites-sender-name">@message.SenderFullName</div>
                                        <div class="favorites-message-text @(message.IsDeleted ? "deleted" : "")">
                                            @GetFilePreview(message)
                                        </div>
                                    </div>
                                    <div class="favorites-message-actions">
                                        @if (hoveredMessageId == message.Id || activeMenuMessageId == message.Id)
                                        {
                                            <button class="favorites-menu-btn" @onclick="() => ToggleMessageMenu(message.Id)" @onclick:stopPropagation="true">
                                                <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Small" />
                                            </button>
                                        }
                                        @if (activeMenuMessageId == message.Id)
                                        {
                                            <div class="favorites-context-menu" @onclick:stopPropagation="true">
                                                <button class="context-menu-item" @onclick="() => HandleViewContext(message.Id)">
                                                    <span>View context</span>
                                                </button>
                                                <button class="context-menu-item" @onclick="() => HandleRemoveFromFavorites(message.Id)">
                                                    <span>Remove from favorites</span>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                }
            </div>
        </div>
    }
    else if (showLinksPanel)
    {
        <!-- Links Panel -->
        <div class="sidebar-favorites-panel">
            <div class="sidebar-header-panel">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <button class="sidebar-close-btn" @onclick="CloseLinksPanel" @onclick:stopPropagation="true">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                        </button>
                        <span class="sidebar-title">All links</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-favorites-content">
                <div class="favorites-empty">
                    <MudIcon Icon="@Icons.Material.Outlined.Link" Size="Size.Large" Class="favorites-empty-icon" />
                    <span>No links yet</span>
                </div>
            </div>
        </div>
    }
    else if (showFilesPanel)
    {
        <!-- Files and Media Panel -->
        <div class="sidebar-favorites-panel">
            <div class="sidebar-header-panel">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <button class="sidebar-close-btn" @onclick="CloseFilesPanel" @onclick:stopPropagation="true">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                        </button>
                        <span class="sidebar-title">Files and media</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-favorites-content">
                <div class="favorites-empty">
                    <MudIcon Icon="@Icons.Material.Outlined.PhotoLibrary" Size="Size.Large" Class="favorites-empty-icon" />
                    <span>No files or media yet</span>
                </div>
            </div>
        </div>
    }
    else if (showChatsWithUserPanel)
    {
        <!-- Chats with User Panel -->
        <div class="sidebar-favorites-panel">
            <div class="sidebar-header-panel">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <button class="sidebar-close-btn" @onclick="HandleChatsWithUserPanelClose" @onclick:stopPropagation="true">
                            <MudIcon Icon="@(chatsWithUserMode == "sidebar" ? Icons.Material.Filled.ArrowBack : Icons.Material.Filled.Close)" Size="Size.Small" />
                        </button>
                        <span class="sidebar-title">Chats with user</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-favorites-content">
                @if (isLoadingSharedChannels)
                {
                    <div class="favorites-loading">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    </div>
                }
                else if (SharedChannels == null || !SharedChannels.Any())
                {
                    <div class="favorites-empty">
                        <MudIcon Icon="@Icons.Material.Outlined.Forum" Size="Size.Large" Class="favorites-empty-icon" />
                        <span>No shared channels</span>
                    </div>
                }
                else
                {
                    @foreach (var channel in SharedChannels)
                    {
                        <div class="shared-channel-item" @onclick="() => NavigateToSharedChannel(channel.Id)">
                            <div class="shared-channel-avatar">
                                @if (!string.IsNullOrEmpty(channel.AvatarUrl))
                                {
                                    <img src="@channel.AvatarUrl" alt="@channel.Name" class="shared-channel-avatar-img" />
                                }
                                else
                                {
                                    <div class="shared-channel-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(channel.Id);">
                                        @StringHelper.GetInitials(channel.Name)
                                    </div>
                                }
                            </div>
                            <div class="shared-channel-info">
                                <div class="shared-channel-name">@channel.Name</div>
                                <div class="shared-channel-type">Group chat</div>
                            </div>
                            <div class="shared-channel-time">
                                @FormatDate(channel.LastMessageAtUtc)
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
    else
    {
        <!-- Main Sidebar Content -->
        <div class="sidebar-header-panel">
            <div class="sidebar-header">
                <div class="sidebar-header-left">
                    <button class="sidebar-close-btn" @onclick="() => OnClose.InvokeAsync()" @onclick:stopPropagation="true">
                        <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                    </button>
                    <span class="sidebar-title">About chat</span>
                </div>
                <div class="sidebar-header-right">
                    <button class="sidebar-menu-btn" @onclick="ToggleContextMenu" @onclick:stopPropagation="true">
                        <MudIcon Icon="@Icons.Material.Outlined.MoreHoriz" Size="Size.Small" />
                    </button>

                    @if (showContextMenu)
                    {
                        <div class="sidebar-context-menu" @onclick:stopPropagation="true">
                            <button class="menu-item" @onclick="HandlePin">
                                <span>@(IsPinned ? "Unpin" : "Pin")</span>
                            </button>
                            @if (IsDirectMessage)
                            {
                                <button class="menu-item" @onclick="HandleViewProfile">
                                    <span>View profile</span>
                                </button>
                                @if (!IsNotesConversation)
                                {
                                    <button class="menu-item" @onclick="HandleFindChatsWithUser">
                                        <span>Find chats with this user</span>
                                    </button>
                                }
                            }
                            else
                            {
                                @if (IsChannelAdminOrOwner)
                                {
                                    <button class="menu-item" @onclick="HandleAddMembers">
                                        <span>Add members</span>
                                    </button>
                                    <button class="menu-item" @onclick="HandleEditChannel">
                                        <span>Edit</span>
                                    </button>
                                }
                            }
                            @if (LastMessageId.HasValue)
                            {
                                <button class="menu-item" @onclick="HandleHide">
                                    <span>Hide</span>
                                </button>
                            }
                            @if (!IsDirectMessage)
                            {
                                <button class="menu-item @(IsChannelOwner ? "" : "delete-item")" @onclick="HandleLeave">
                                    <span>Leave</span>
                                </button>
                            }
                            @if (!IsDirectMessage && IsChannelOwner)
                            {
                                <button class="menu-item delete-item" @onclick="HandleDeleteChannel">
                                    <span>Delete</span>
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="sidebar-content">
            <div class="sidebar-info-panel">
                @if (IsDirectMessage)
                {
                    <div class="sidebar-avatar-container">
                        @if (IsNotesConversation)
                        {
                            <div class="sidebar-notes-icon">
                                <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Large" />
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(RecipientAvatarUrl))
                        {
                            <img src="@RecipientAvatarUrl" alt="@RecipientName" class="sidebar-avatar" />
                        }
                        else
                        {
                            <div class="sidebar-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(RecipientId ?? Guid.Empty);">@StringHelper.GetInitials(RecipientName)</div>
                        }
                    </div>
                    <div class="sidebar-user-name">@(string.IsNullOrEmpty(RecipientName) ? "Unknown User" : RecipientName)</div>
                    <div class="sidebar-user-role">@(IsNotesConversation ? "Visible to you only" : "User")</div>
                }
                else
                {
                    <div class="sidebar-avatar-container">
                        @if (!string.IsNullOrEmpty(ChannelAvatarUrl))
                        {
                            <img src="@ChannelAvatarUrl" alt="@ChannelName" class="sidebar-avatar" />
                        }
                        else
                        {
                            <div class="sidebar-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(ChannelId ?? Guid.Empty);">@StringHelper.GetInitials(ChannelName)</div>
                        }
                    </div>
                    <div class="sidebar-user-name">@(string.IsNullOrEmpty(ChannelName) ? "Unknown Group" : ChannelName)</div>
                    <div class="sidebar-user-role">@MemberCount members</div>
                }
            </div>

            <div class="sidebar-details-panel">
                <div class="sidebar-details-header">
                    <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Class="details-header-icon" />
                    <span class="details-header-text @(IsNotesConversation ? "notes-details-text" : "")">@(IsNotesConversation ? "A scratchpad to keep important messages, files and links in one place." : (IsDirectMessage ? "User" : "Group chat"))</span>
                </div>

                @if (!IsNotesConversation)
                {
                    <div class="sidebar-section-item" @onclick:stopPropagation="true">
                        <div class="sidebar-section-left">
                            <MudIcon Icon="@(IsMuted ? Icons.Material.Outlined.VolumeOff : Icons.Material.Outlined.VolumeUp)" Size="Size.Small" Class="section-icon section-icon-primary" />
                            <span class="section-text section-text-primary">Sound</span>
                        </div>
                        <div class="sidebar-section-right">
                            <label class="toggle-switch">
                                <input type="checkbox" checked="@IsSoundEnabled" @onchange="HandleSoundToggle" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                }

                <div class="sidebar-section-item" @onclick="OpenFavoritesPanel">
                    <div class="sidebar-section-left">
                        <MudIcon Icon="@Icons.Material.Outlined.StarBorder" Size="Size.Small" Class="section-icon section-icon-primary" />
                        <span class="section-text section-text-primary">Favorite messages</span>
                    </div>
                    <div class="sidebar-section-right">
                        <span class="sidebar-section-count">@FavoriteCount</span>
                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Class="sidebar-section-arrow" />
                    </div>
                </div>

                <div class="sidebar-section-item" @onclick="OpenLinksPanel">
                    <div class="sidebar-section-left">
                        <MudIcon Icon="@Icons.Material.Outlined.Link" Size="Size.Small" Class="section-icon section-icon-primary" />
                        <span class="section-text section-text-primary">All links</span>
                    </div>
                    <div class="sidebar-section-right">
                        <span class="sidebar-section-count">@LinkCount</span>
                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Class="sidebar-section-arrow" />
                    </div>
                </div>

                <div class="sidebar-section-item" @onclick="OpenFilesPanel">
                    <div class="sidebar-section-left">
                        <MudIcon Icon="@Icons.Material.Outlined.PhotoLibrary" Size="Size.Small" Class="section-icon section-icon-primary" />
                        <span class="section-text section-text-primary">Files and media</span>
                    </div>
                    <div class="sidebar-section-right">
                        <span class="sidebar-section-count">@FileCount</span>
                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Class="sidebar-section-arrow" />
                    </div>
                </div>
            </div>
        </div>
    }
</div>