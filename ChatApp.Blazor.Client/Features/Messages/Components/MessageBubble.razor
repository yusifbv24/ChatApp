<div id="message-@MessageId" class="message-wrapper @(IsOwn ? "own" : "other") @(IsDeleted ? "deleted" : "") @(!IsDirectMessage && !IsOwn ? "group-message" : "") @(IsSelectMode ? "select-mode" : "")">

    @* Selection checkbox - visible only in select mode and not for deleted messages *@
    @if (IsSelectMode && !IsDeleted)
    {
        <div class="message-select-checkbox @(IsSelected ? "selected" : "")" @onclick="HandleBubbleClick" @onclick:stopPropagation="true">
            @if (IsSelected)
            {
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Medium" Class="checkbox-icon" />
            }
            else
            {
                <div class="checkbox-empty"></div>
            }
        </div>
    }

    @if (!IsOwn && !IsDirectMessage)
    {
        <!-- Always show avatar space for group messages to maintain alignment -->
        <div class="message-avatar @(!ShowAvatar ? "avatar-spacer" : "")">
            @if (ShowAvatar)
            {
                @if (!string.IsNullOrEmpty(AvatarUrl))
                {
                    <img src="@AvatarUrl" alt="@SenderName" />
                }
                else
                {
                    <div class="avatar-placeholder">@StringHelper.GetInitials(SenderName)</div>
                }
            }
        </div>
    }

    <div class="message-content-wrapper">
        <div class="message-bubble @(IsOwn ? "own-bubble" : "other-bubble") @(IsSelectMode && !IsDeleted ? "selectable" : "")"
             @onmouseenter="() => showHoverActions = true"
             @onmouseleave="() => { if (!showMoreMenu && !showReactionPicker) showHoverActions = false; }"
             @onclick="HandleBubbleClick">
            @if (IsDeleted)
            {
                <div class="deleted-message">
                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" />
                    <span>This message was deleted</span>
                </div>
            }
            else
            {
                <div class="message-content-block">
                    @* Show sender name inside bubble for group messages *@
                    @if (!IsOwn && ShowSenderName)
                    {
                        <div class="message-sender-inside">@SenderName</div>
                    }

                    @* Show forwarded indicator *@
                    @if (IsForwarded)
                    {
                        <div class="forwarded-label">
                            <MudIcon Icon="@Icons.Material.Filled.Forward" Size="Size.Small" />
                            <span>Forwarded</span>
                        </div>
                    }

                    @* Show replied message preview if this is a reply *@
                    @if (!string.IsNullOrEmpty(ReplyToContent))
                    {
                        <div class="reply-preview clickable" @onclick="HandleReplyClick">
                            <div class="reply-bar"></div>
                            <div class="reply-content">
                                <div class="reply-sender">@ReplyToSenderName</div>
                                <div class="reply-text">@StringHelper.TruncateText(ReplyToContent, 50)</div>
                            </div>
                        </div>
                    }

                    <!-- Message text -->
                    <div class="message-text">@((MarkupString)ParseLinks(Content))</div>

                    <!-- Footer Row: Reactions (left) and Time/Status (right) -->
                    <div class="message-footer-row">
                        <!-- Reactions - parallel to footer -->
                        @if (GetReactionsList() is var reactions && reactions != null && reactions.Count > 0 && !IsDeleted)
                        {
                            <div class="message-reactions-inline">
                                @foreach (var reaction in reactions)
                                {
                                    var reactionIndex = reactions.IndexOf(reaction);
                                    var isOwnReaction = CurrentUserId.HasValue && reaction.UserIds.Contains(CurrentUserId.Value);
                                    var badgeClass = isOwnReaction ? "reaction-badge own-reaction" : "reaction-badge";

                                    @if (!IsDirectMessage)
                                    {
                                        @* Channel messages - show user panel on hover *@
                                        <span class="@badgeClass reaction-badge-wrapper"
                                              @onclick="() => SelectReaction(reaction.Emoji)"
                                              @onmouseenter="() => ShowReactionUsers(reactionIndex)"
                                              @onmouseleave="ScheduleHideReactionUsers">
                                            <span class="reaction-emoji">@reaction.Emoji</span>
                                            <span class="reaction-count">@reaction.Count</span>

                                            @* User panel popup *@
                                            @if (hoveredReactionIndex == reactionIndex)
                                            {
                                                <div class="reaction-users-panel"
                                                     @onclick:stopPropagation="true"
                                                     @onmouseenter="CancelHideReactionUsers"
                                                     @onmouseleave="ScheduleHideReactionUsers">
                                                    @for (int i = 0; i < reaction.UserDisplayNames.Count; i++)
                                                    {
                                                        var displayName = reaction.UserDisplayNames[i];
                                                        var avatarUrl = reaction.UserAvatarUrls[i];
                                                        <div class="reaction-user-item">
                                                            <div class="reaction-user-avatar">
                                                                @if (!string.IsNullOrEmpty(avatarUrl))
                                                                {
                                                                    <img src="@avatarUrl" alt="@displayName" />
                                                                }
                                                                else
                                                                {
                                                                    <div class="avatar-placeholder-small">@StringHelper.GetInitials(displayName)</div>
                                                                }
                                                            </div>
                                                            <span class="reaction-user-name">@displayName</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </span>
                                    }
                                    else
                                    {
                                        @* Direct messages - no user panel on hover *@
                                        <span class="@badgeClass reaction-badge-wrapper"
                                              @onclick="() => SelectReaction(reaction.Emoji)">
                                            <span class="reaction-emoji">@reaction.Emoji</span>
                                            <span class="reaction-count">@reaction.Count</span>
                                        </span>
                                    }
                                }
                            </div>
                        }

                        <!-- Footer: Time and status -->
                        <div class="message-footer">
                            @if (IsEdited)
                            {
                                <span class="edited-label">edited</span>
                            }
                            @if (IsPinned)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.PushPin" Size="Size.Small" Class="pinned-icon-inline" />
                            }
                            <span class="message-time">@FormatTime(CreatedAt)</span>
                            @if (IsOwn && !IsDeleted)
                            {
                                @if (IsDirectMessage)
                                {
                                    <span class="read-status">
                                        @if (IsRead)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.DoneAll" Size="Size.Small" Class="read-icon" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Done" Size="Size.Small" />
                                        }
                                    </span>
                                }
                                else
                                {
                                    @* Channel message read status *@
                                    <span class="read-status">
                                        @if (ReadByCount > 0)
                                        {
                                            @* At least one person read it - show double checkmark *@
                                            @* Blue if everyone (except sender) read it, gray if only some read it *@
                                            @* TotalMemberCount already excludes sender (calculated in backend) *@
                                            <MudIcon Icon="@Icons.Material.Filled.DoneAll" Size="Size.Small"
                                                     Class="@(TotalMemberCount > 0 && ReadByCount >= TotalMemberCount ? "read-icon" : "")" />
                                        }
                                        else
                                        {
                                            @* Not read by anyone - show single checkmark *@
                                            <MudIcon Icon="@Icons.Material.Filled.Done" Size="Size.Small" />
                                        }
                                    </span>
                                }
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Chevron button - top right corner -->
            @if (!IsSelectMode)
            {
                <div class="chevron-wrapper" @ref="chevronWrapperRef">
                    <button class="chevron-more-btn @(showMoreMenu ? "visible" : "") @((showHoverActions || showMoreMenu) ? "" : "hidden-btn")"
                            title="More"
                            @onclick="ToggleMoreMenu"
                            @onclick:stopPropagation="true">
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                    </button>
                </div>
            }

            <!-- More Menu (positioned relative to bubble, not chevron) -->
            @if (!IsSelectMode && showMoreMenu)
            {
                <div class="chevron-more-menu @(menuPositionAbove ? "menu-above" : "")" @onclick:stopPropagation="true">
                    @if (IsDeleted)
                    {
                        @* Deleted messages: ONLY Reply is allowed *@
                        <button class="menu-item" @onclick="HandleReplyButtonClick">
                            <span>Reply</span>
                            <MudIcon Icon="@Icons.Material.Outlined.FormatQuote" Size="Size.Small" />
                        </button>
                    }
                    else
                    {
                        @* Normal messages: Full menu *@
                        <button class="menu-item" @onclick="HandleReplyButtonClick">
                            <span>Reply</span>
                            <MudIcon Icon="@Icons.Material.Outlined.FormatQuote" Size="Size.Small" />
                        </button>
                        <button class="menu-item" @onclick="OnCopyClick">
                            <span>Copy</span>
                            <MudIcon Icon="@Icons.Material.Outlined.ContentCopy" Size="Size.Small" />
                        </button>
                        @if (IsOwn && !IsForwarded)
                        {
                            <button class="menu-item" @onclick="OnEditClick">
                                <span>Edit</span>
                                <MudIcon Icon="@Icons.Material.Outlined.Edit" Size="Size.Small" />
                            </button>
                        }
                        <button class="menu-item" @onclick="OnForwardClick">
                            <span>Forward</span>
                            <MudIcon Icon="@Icons.Material.Outlined.Redo" Size="Size.Small" />
                        </button>
                        @* More submenu with Pin, Favorites, Mark Later *@
                        <div class="menu-item-with-submenu"
                             @onmouseenter="ShowMoreSubmenu"
                             @onmouseleave="HideMoreSubmenu">
                            <button class="menu-item">
                                <span>More</span>
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" />
                            </button>
                            @if (showMoreSubmenu)
                            {
                                <div class="submenu @(IsOwn ? "submenu-left" : "submenu-right")">
                                    <button class="menu-item" @onclick="OnPinClick">
                                        <span>@(IsPinned ? "Unpin" : "Pin")</span>
                                        <MudIcon Icon="@Icons.Material.Outlined.PushPin" Size="Size.Small" />
                                    </button>
                                    <button class="menu-item" @onclick="HandleToggleFavoriteClick">
                                        <span>@(IsFavorite ? "Remove from Favorites" : "Add to Favorites")</span>
                                        <MudIcon Icon="@(IsFavorite ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)" Size="Size.Small" />
                                    </button>
                                    @if (!IsMarkedAsLater)
                                    {
                                        <button class="menu-item" @onclick="HandleMarkAsLaterClick">
                                            <span>Mark as Later</span>
                                            <MudIcon Icon="@Icons.Material.Outlined.WatchLater" Size="Size.Small" />
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                        @if (IsOwn)
                        {
                            <button class="menu-item delete-item" @onclick="OnDeleteClick">
                                <span>Delete</span>
                                <MudIcon Icon="@Icons.Material.Outlined.Delete" Size="Size.Small" />
                            </button>
                        }
                        <button class="menu-item" @onclick="HandleSelectClick">
                            <span>Select</span>
                            <MudIcon Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small" />
                        </button>
                    }
                </div>
            }

            <!-- Quick Reaction Icon (Like button in bottom corner) - hidden for deleted messages and select mode -->
            @if (!IsSelectMode && !IsDeleted && (showHoverActions || showReactionPicker))
            {
                <div class="reaction-quick-icon @(showReactionPicker ? "active" : "")"
                     @onmouseenter="HandleReactionIconHover"
                     @onmouseleave="CancelReactionIconHover"
                     @onclick="ToggleLikeReaction"
                     @onclick:stopPropagation="true">
                    <span class="quick-icon-emoji">👍</span>

                    @if (showReactionPicker)
                    {
                        <div class="reaction-picker-quick"
                             @onmouseenter="KeepReactionPickerOpen"
                             @onmouseleave="HandleReactionPickerLeave"
                             @onclick:stopPropagation="true">
                            @foreach (var emoji in CommonReactions)
                            {
                                <button class="reaction-btn" @onclick="() => SelectReaction(emoji)">@emoji</button>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- More Menu Overlay -->
    @if (showMoreMenu)
    {
        <div class="popup-overlay" @onclick="CloseMoreMenu"></div>
    }
</div>