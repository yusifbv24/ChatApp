@implements IAsyncDisposable

<div class="chat-area">
    @if (IsEmpty)
    {
        <!-- Empty State -->
        <div class="chat-empty-state">
            <div class="empty-illustration">
                <MudIcon Icon="@Icons.Material.Filled.Forum" Class="empty-main-icon"/>
            </div>
            <h2>Select a conversation</h2>
            <p>Choose a conversation from the list or start a new one</p>
        </div>
    }
    else
    {
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-header-info">
                @if (IsDirectMessage)
                {
                    <div class="header-avatar">
                        @if (!string.IsNullOrEmpty(RecipientAvatarUrl))
                        {
                            <img src="@RecipientAvatarUrl" alt="@RecipientName" />
                        }
                        else
                        {
                            <div class="avatar-placeholder">@StringHelper.GetInitials(RecipientName)</div>
                        }
                        <span class="online-indicator @(IsRecipientOnline ? "online" : "offline")"></span>
                    </div>
                    <div class="header-details">
                        <h3 class="header-name">@RecipientName</h3>
                        @if (TypingUsers?.Any() ?? false)
                        {
                            <span class="header-status typing">typing...</span>
                        }
                        else
                        {
                            <span class="header-status">@(IsRecipientOnline ? "Online" : "Offline")</span>
                        }
                    </div>
                }
                else
                {
                    <div class="header-avatar">
                        <div class="avatar-placeholder channel-avatar">@StringHelper.GetInitials(ChannelName)</div>
                    </div>
                    <div class="header-details">
                        <h3 class="header-name">@ChannelName</h3>
                        @if (TypingUsers?.Any() ?? false)
                        {
                            <span class="header-status typing">
                                @if (TypingUsers.Count == 1)
                                {
                                    <text>@TypingUsers[0] is typing...</text>
                                }
                                else if (TypingUsers.Count == 2)
                                {
                                    <text>@TypingUsers[0] and @TypingUsers[1] are typing...</text>
                                }
                                else
                                {
                                    <text>@TypingUsers.Count people are typing...</text>
                                }
                            </span>
                        }
                        else
                        {
                            <span class="header-status">@MemberCount members</span>
                        }
                    </div>
                }
            </div>
            <div class="chat-header-actions">
                @if (!IsDirectMessage && IsChannelAdmin)
                {
                    <button class="header-action-btn" title="Add member" @onclick="ToggleAddMemberPanel">
                        <MudIcon Icon="@Icons.Material.Filled.PersonAdd" />
                    </button>
                }
                <button class="header-action-btn @(IsSearchPanelOpen ? "active" : "")" title="Search" @onclick="() => OnToggleSearchPanel.InvokeAsync()">
                    <MudIcon Icon="@Icons.Material.Filled.Search" />
                </button>
                <button class="header-action-btn @(IsSidebarOpen || IsSearchPanelOpen ? "active" : "")" title="Sidebar" @onclick="() => OnToggleSidebar.InvokeAsync()">
                    <MudIcon Icon="@Icons.Material.Outlined.ViewSidebar" />
                </button>
            </div>
        </div>

        <!-- Pinned Messages Header -->
        @if ((IsDirectMessage && PinnedDirectMessageCount > 0) || (!IsDirectMessage && PinnedCount > 0))
        {
            <div class="pinned-messages-header-wrapper">
                <div class="pinned-messages-header" @onclick="HandlePinnedHeaderClick">
                    <div class="pinned-header-content">
                        <div class="pinned-header-left">
                            <div class="pinned-message-info">
                                @if (showPinnedDropdown)
                                {
                                    <span class="pinned-title-expanded">Pinned messages : <span class="pinned-title-count">@(IsDirectMessage ? PinnedDirectMessageCount : PinnedCount)</span></span>
                                }
                                else
                                {
                                    <span class="pinned-title">Pinned messages</span>
                                    var currentPinned = IsDirectMessage ? GetCurrentPinnedDirectMessage() : null;
                                    var currentChannelPinned = !IsDirectMessage ? GetCurrentPinnedChannelMessage() : null;
                                    var senderName = currentPinned?.SenderDisplayName ?? currentChannelPinned?.SenderDisplayName;
                                    var messageContent = currentPinned?.Content ?? currentChannelPinned?.Content;

                                    if (!string.IsNullOrEmpty(senderName))
                                    {
                                        <span class="pinned-preview">
                                            <span class="pinned-sender-name">@senderName</span>
                                            <span class="pinned-separator">:</span>
                                            <span class="pinned-message-text">@StringHelper.TruncateText(messageContent, 50)</span>
                                        </span>
                                    }
                                }
                            </div>
                        </div>
                        <div class="pinned-header-right">
                            @if (showPinnedDropdown)
                            {
                                <button class="pinned-close-btn" @onclick="ClosePinnedDropdown" @onclick:stopPropagation="true">
                                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                                </button>
                            }
                            else
                            {
                                <button class="pinned-toggle-btn-vertical" @onclick="TogglePinnedDropdown" @onclick:stopPropagation="true">
                                    <MudIcon Icon="@Icons.Material.Outlined.PushPin" Size="Size.Small" Class="pinned-icon-dark" />
                                    <span class="pinned-count-dark">@(currentPinnedIndex + 1)/@(IsDirectMessage ? PinnedDirectMessageCount : PinnedCount)</span>
                                </button>
                            }
                        </div>
                    </div>
                </div>

                @if (showPinnedDropdown)
                {
                    <div class="pinned-dropdown-panel">
                        <div class="pinned-dropdown-list">
                            @if (IsDirectMessage)
                            {
                                @foreach (var message in PinnedDirectMessages)
                                {
                                    <div class="pinned-dropdown-item" @onclick="() => NavigateToPinnedMessage(message.Id)">
                                        <div class="pinned-item-avatar">
                                            @if (!string.IsNullOrEmpty(message.SenderAvatarUrl))
                                            {
                                                <img src="@message.SenderAvatarUrl" alt="@message.SenderDisplayName" />
                                            }
                                            else
                                            {
                                                <div class="avatar-placeholder">@StringHelper.GetInitials(message.SenderDisplayName)</div>
                                            }
                                        </div>
                                        <div class="pinned-item-content">
                                            <span class="pinned-item-sender">@message.SenderDisplayName</span>
                                            <span class="pinned-item-text">@StringHelper.TruncateText(message.Content, 60)</span>
                                        </div>
                                        <button class="unpin-btn" @onclick="() => HandleUnpinMessage(message.Id)" @onclick:stopPropagation="true" title="Unpin">
                                            <MudIcon Icon="@Icons.Material.Outlined.PushPin" Size="Size.Small" />
                                        </button>
                                    </div>
                                }
                            }
                            else
                            {
                                @foreach (var message in PinnedChannelMessages)
                                {
                                    <div class="pinned-dropdown-item" @onclick="() => NavigateToPinnedMessage(message.Id)">
                                        <div class="pinned-item-avatar">
                                            @if (!string.IsNullOrEmpty(message.SenderAvatarUrl))
                                            {
                                                <img src="@message.SenderAvatarUrl" alt="@message.SenderDisplayName" />
                                            }
                                            else
                                            {
                                                <div class="avatar-placeholder">@StringHelper.GetInitials(message.SenderDisplayName)</div>
                                            }
                                        </div>
                                        <div class="pinned-item-content">
                                            <span class="pinned-item-sender">@message.SenderDisplayName</span>
                                            <span class="pinned-item-text">@StringHelper.TruncateText(message.Content, 60)</span>
                                        </div>
                                        <button class="unpin-btn" @onclick="() => HandleUnpinChannelMessage(message.Id)" @onclick:stopPropagation="true" title="Unpin">
                                            <MudIcon Icon="@Icons.Material.Outlined.PushPin" Size="Size.Small" />
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Messages Area -->
        <div id="chat-messages" class="messages-container" @ref="messagesContainerRef" @onscroll="HandleScroll">
            @if (IsLoading)
            {
                <div class="messages-loading">
                    <div class="loading-spinner"></div>
                    <span>Loading messages...</span>
                </div>
            }
            else if (IsLoadingMoreMessages)
            {
                <div class="load-more-container">
                    <div class="loading-spinner small"></div>
                    <span>Loading...</span>
                </div>
            }
            @if (DirectMessages.Any())
            {
                @foreach(var group in GroupedDirectMessages)
                {
                    <div class="message-group">
                        <div class="date-divider">
                            <span>@FormatDateDivider(group.Key)</span>
                        </div>
                        <div class="messages-in-group">
                            @foreach(var message in group)
                            {
                                @* Read Later separator appears BEFORE the marked message *@
                                @* Only show if there's NO unread separator (unread has priority) *@
                                @if (LastReadLaterMessageId.HasValue && message.Id == LastReadLaterMessageId.Value && !UnreadSeparatorAfterMessageId.HasValue)
                                {
                                    <div class="unread-separator" id="read-later-separator">
                                        <span>Read Later</span>
                                    </div>
                                }

                                <MessageBubble @key="message.Id"
                                       MessageId="message.Id"
                                       Content="@message.Content"
                                       SenderName="@message.SenderDisplayName"
                                       AvatarUrl="@message.SenderAvatarUrl"
                                       CreatedAt="@message.CreatedAtUtc"
                                       IsOwn="@(message.SenderId==CurrentUserId)"
                                       IsEdited="@message.IsEdited"
                                       IsDeleted="@message.IsDeleted"
                                       IsRead="@message.IsRead"
                                       IsPinned="@message.IsPinned"
                                       IsFavorite="@FavoriteMessageIds.Contains(message.Id)"
                                       ReactionCount="@message.ReactionCount"
                                       Reactions="@message.Reactions"
                                       CurrentUserId="@CurrentUserId"
                                       IsDirectMessage="true"
                                       ShowAvatar="false"
                                       ShowSenderName="false"
                                       ReplyToMessageId="@message.ReplyToMessageId"
                                       ReplyToContent="@message.ReplyToContent"
                                       ReplyToSenderName="@message.ReplyToSenderName"
                                       IsForwarded="@message.IsForwarded"
                                       LastReadLaterMessageId="@LastReadLaterMessageId"
                                       IsSelectMode="@IsSelectMode"
                                       IsSelected="@SelectedMessageIds.Contains(message.Id)"
                                       OnSelectToggle="OnSelectToggle"
                                       OnEdit="()=>StartEditMessage(message.Id,message.Content)"
                                       OnDelete="()=>DeleteMessage(message.Id)"
                                       OnReaction="(emoji)=>AddReaction(message.Id,emoji)"
                                       OnReply="()=>OnReply.InvokeAsync(message.Id)"
                                       OnPin="()=>PinDirectMessage(message.Id,message.IsPinned)"
                                       OnForward="()=>OnForward.InvokeAsync(message.Id)"
                                       OnToggleFavorite="()=>OnToggleFavorite.InvokeAsync(message.Id)"
                                       OnMarkAsLater="OnMarkAsLater"
                                       OnReplyClick="HandleReplyClick"
                                       OnActionCompleted="RefocusInput"
                                       ScrollToBottom="ScrollToBottomAsync" />

                                @if (UnreadSeparatorAfterMessageId.HasValue && message.Id == UnreadSeparatorAfterMessageId.Value)
                                {
                                    <div class="unread-separator" id="unread-separator">
                                        <span>New messages</span>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            }
            else if (ChannelMessages.Any())
            {
                @foreach(var group in GroupedChannelMessages)
                {
                    <div class="message-group">
                        <div class="date-divider">
                            <span>@FormatDateDivider(group.Key)</span>
                        </div>
                        <div class="messages-in-group">
                            @foreach (var message in group)
                            {
                                @* Read Later separator appears BEFORE the marked message *@
                                @* Only show if there's NO unread separator (unread has priority) *@
                                @if (LastReadLaterMessageId.HasValue && message.Id == LastReadLaterMessageId.Value && !UnreadSeparatorAfterMessageId.HasValue)
                                {
                                    <div class="unread-separator" id="read-later-separator">
                                        <span>Read Later</span>
                                    </div>
                                }

                                <MessageBubble @key="message.Id"
                                       MessageId="message.Id"
                                       Content="@message.Content"
                                       SenderName="@message.SenderDisplayName"
                                       AvatarUrl="@message.SenderAvatarUrl"
                                       CreatedAt="@message.CreatedAtUtc"
                                       IsOwn="@(message.SenderId == CurrentUserId)"
                                       IsEdited="@message.IsEdited"
                                       IsDeleted="@message.IsDeleted"
                                       IsPinned="@message.IsPinned"
                                       IsFavorite="@FavoriteMessageIds.Contains(message.Id)"
                                       ReactionCount="@message.ReactionCount"
                                       Reactions="@message.Reactions"
                                       CurrentUserId="@CurrentUserId"
                                       ReadByCount="@message.ReadByCount"
                                       TotalMemberCount="@message.TotalMemberCount"
                                       IsDirectMessage="false"
                                       ShowAvatar="@ShouldShowAvatarInChannel(message, group)"
                                       ShowSenderName="@ShouldShowSenderName(message, group)"
                                       ReplyToMessageId="@message.ReplyToMessageId"
                                       ReplyToContent="@message.ReplyToContent"
                                       ReplyToSenderName="@message.ReplyToSenderName"
                                       IsForwarded="@message.IsForwarded"
                                       LastReadLaterMessageId="@LastReadLaterMessageId"
                                       IsSelectMode="@IsSelectMode"
                                       IsSelected="@SelectedMessageIds.Contains(message.Id)"
                                       OnSelectToggle="OnSelectToggle"
                                       OnEdit="() => StartEditMessage(message.Id, message.Content)"
                                       OnDelete="() => DeleteMessage(message.Id)"
                                       OnReaction="(emoji) => AddReaction(message.Id, emoji)"
                                       OnReply="()=>OnReply.InvokeAsync(message.Id)"
                                       OnPin="()=>PinChannelMessage(message.Id, message.IsPinned)"
                                       OnForward="()=>OnForward.InvokeAsync(message.Id)"
                                       OnToggleFavorite="()=>OnToggleFavorite.InvokeAsync(message.Id)"
                                       OnMarkAsLater="OnMarkAsLater"
                                       OnReplyClick="HandleReplyClick"
                                       OnActionCompleted="RefocusInput"
                                       ScrollToBottom="ScrollToBottomAsync" />

                                @* Unread separator appears AFTER the last read message (existing behavior) *@
                                @if (UnreadSeparatorAfterMessageId.HasValue && message.Id == UnreadSeparatorAfterMessageId.Value)
                                {
                                    <div class="unread-separator" id="unread-separator">
                                        <span>New messages</span>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            }
            else if (!IsLoading)
            {
                <div class="no-messages">
                    <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Class="no-messages-icon">
                        <p>No messages yet</p>
                        <span>Send a message to start the conversation</span>
                    </MudIcon>
                </div>
            }
        </div>

        <!-- Scroll to Bottom Float Button (həm normal, həm around mode) -->
        @if (showScrollToBottom)
        {
            <button class="scroll-to-bottom-btn @(IsSidebarOpen || IsSearchPanelOpen ? "panel-open" : "")" @onclick="ScrollToBottomAndFocusAsync" type="button">
                <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Medium" />
                @if (newMessagesCount > 0)
                {
                    <span class="new-messages-badge">@(newMessagesCount > 99 ? "99+" : newMessagesCount.ToString())</span>
                }
            </button>
        }

        <!-- Message Input or Selection Toolbar -->
        @if (IsSelectMode)
        {
            <SelectionToolbar SelectedCount="@SelectedMessageIds.Count"
                             CanDelete="@CanDeleteSelected"
                             OnCancel="OnCancelSelection"
                             OnDelete="OnDeleteSelected"
                             OnForward="OnForwardSelected" />
        }
        else
        {
            <MessageInput @ref="messageInputRef"
                          Placeholder="@GetInputPlaceholder()"
                          IsEditing="@isEditing"
                          EditingContent="@editingContent"
                          IsSending="@IsSending"
                          ConversationId="@ConversationId"
                          IsReplying="@IsReplying"
                          ReplyToSenderName="@ReplyToSenderName"
                          ReplyToContent="@ReplyToContent"
                          InitialDraft="@InitialDraft"
                          OnSend="SendMessage"
                          OnEdit="EditMessage"
                          OnCancelEdit="CancelEdit"
                          OnCancelReply="OnCancelReply"
                          OnTyping="HandleTyping"
                          OnAttach="HandleAttach"
                          OnDraftChanged="OnDraftChanged" />
        }
    }
</div>

<!-- Add Member Dialog -->
@if (showAddMemberPanel)
{
    <div class="dialog-overlay" @onclick="CloseAddMemberPanel">
        <div class="dialog-content add-member-dialog" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h3>Add Member</h3>
                <button class="dialog-close-btn" @onclick="CloseAddMemberPanel">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="dialog-body">
                <!-- Search Users -->
                <div class="member-search-section">
                    <div class="member-search-input">
                        <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" />
                        <input type="text"
                               placeholder="Search users..."
                               value="@memberSearchQuery"
                               @oninput="OnMemberSearchInput" />
                    </div>

                    @if (isSearchingMembers)
                    {
                        <div class="member-search-loading">
                            <div class="loading-spinner small"></div>
                            <span>Searching...</span>
                        </div>
                    }
                    else if (memberSearchResults.Any())
                    {
                        <div class="member-search-results">
                            @foreach (var user in memberSearchResults)
                            {
                                <div class="member-search-item">
                                    <div class="member-avatar">
                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                        {
                                            <img src="@user.AvatarUrl" alt="@user.DisplayName" />
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder">@StringHelper.GetInitials(user.DisplayName)</div>
                                        }
                                    </div>
                                    <div class="member-info">
                                        <span class="member-name">@user.DisplayName</span>
                                        <span class="member-username">@@@user.Username</span>
                                    </div>
                                    <div class="member-actions">
                                        <select class="role-select" @bind="selectedRoleForUser[user.Id]">
                                            <option value="@ChannelMemberRole.Member">Member</option>
                                            <option value="@ChannelMemberRole.Admin">Admin</option>
                                        </select>
                                        <button class="add-member-btn" @onclick="() => AddMemberToChannel(user.Id)" disabled="@isAddingMember">
                                            @if (isAddingMember && addingUserId == user.Id)
                                            {
                                                <div class="loading-spinner small"></div>
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                                            }
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(memberSearchQuery) && memberSearchQuery.Length >= 2)
                    {
                        <div class="member-search-empty">
                            <span>No users found</span>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(addMemberError))
                {
                    <div class="add-member-error">
                        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                        <span>@addMemberError</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(addMemberSuccess))
                {
                    <div class="add-member-success">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                        <span>@addMemberSuccess</span>
                    </div>
                }
            </div>
        </div>
    </div>
}