@page "/messages"
@attribute [Authorize]
@implements IAsyncDisposable

<div class="messages-page">
    <!-- Left Panel : Conversation List -->
    <div class="messages-sidebar">
        <ConversationList Conversations="directConversations"
                          Channels="channelConversations"
                          SelectedConversationId="@selectedConversationId"
                          SelectedChannelId="@selectedChannelId"
                          IsLoading="@isLoadingConversationList"
                          ConversationTypingState="@conversationTypingState"
                          ChannelTypingUsers="@channelTypingUsers"
                          MessageDrafts="@messageDrafts"
                          OnConversationSelected="SelectDirectConversation"
                          OnChannelSelected="SelectChannel"
                          OnNewConversation="OpenNewConversationDialog"
                          OnNewChannel="OpenNewChannelDialog"
                          OnConversationMuteToggled="HandleConversationListMuteToggle"
                          OnConversationClosed="CloseConversation"
                          OnChannelClosed="CloseConversation"
                          OnFindChatsWithUser="HandleFindChatsWithUser"
                          OnChannelLeave="HandleChannelLeave"
                          DepartmentUsers="departmentUsers"
                          HasMoreItems="@hasMoreConversationItems"
                          IsLoadingMore="@isLoadingMoreItems"
                          OnDepartmentUserSelected="StartConversationWithDepartmentUser"
                          OnLoadMore="LoadMoreConversationItems"/>
    </div>

    <!-- Main Panel: Chat Area -->
    <div class="messages-main">
        <ChatArea IsEmpty="@IsEmpty"
                  IsDirectMessage="@isDirectMessage"
                  CurrentUserId="@currentUserId"
                  ConversationId="@(selectedConversationId ?? selectedChannelId)"
                  ChannelId="@selectedChannelId"
                  CacheVersion="@messageCacheVersion"
                  DirectMessages="@directMessages"
                  RecipientId="@recipientUserId"
                  RecipientName="@recipientName"
                  RecipientAvatarUrl="@recipientAvatarUrl"
                  IsRecipientOnline="@isRecipientOnline"
                  IsNotesConversation="@isNotesConversation"
                  IsPinned="@selectedConversationIsPinned"
                  IsMuted="@selectedConversationIsMuted"
                  IsMarkedReadLater="@selectedConversationIsMarkedReadLater"
                  ChannelMessages="@channelMessages"
                  ChannelName="@selectedChannelName"
                  ChannelDescription="@selectedChannelDescription"
                  ChannelType="@selectedChannelType"
                  MemberCount="@selectedChannelMemberCount"
                  PinnedCount="@pinnedChannelMessageCount"
                  PinnedDirectMessageCount="@pinnedDirectMessageCount"
                  PinnedChannelMessages="@pinnedChannelMessages"
                  PinnedDirectMessages="@pinnedDirectMessages"
                  OnNavigateToPinnedMessage="NavigateToPinnedMessage"
                  IsChannelAdmin="@isChannelAdmin"
                  IsLoading="@isLoadingMessages"
                  IsLoadingMoreMessages="@isLoadingMoreMessages"
                  HasMoreMessages="@hasMoreMessages"
                  HasMoreNewerMessages="@hasMoreNewerMessages"
                  IsSending="@isSendingMessage"
                  TypingUsers="@typingUsers"
                  IsReplying="@isReplying"
                  ReplyToMessageId="@replyToMessageId"
                  ReplyToSenderName="@replyToSenderName"
                  ReplyToContent="@replyToContent"
                  ReplyToFileId="@replyToFileId"
                  ReplyToFileName="@replyToFileName"
                  ReplyToFileContentType="@replyToFileContentType"
                  UserSearchResults="@memberSearchResults"
                  IsSearchingUsers="@isSearchingMembersForAdd"
                  UnreadSeparatorAfterMessageId="@unreadSeparatorAfterMessageId"
                  LastReadLaterMessageId="@lastReadLaterMessageId"
                  IsSelectMode="@isSelectingMessageBuble"
                  SelectedMessageIds="@selectedMessageIds"
                  CanDeleteSelected="@CanDeleteSelected()"
                  OnSendMessage="SendMessage"
                  OnSendWithFiles="HandleSendWithFiles"
                  OnEditMessage="EditMessage"
                  OnDeleteMessage="DeleteMessage"
                  OnAddReaction="AddReaction"
                  OnMentionClick="HandleMentionClick"
                  OnReply="HandleReply"
                  OnForward="HandleForward"
                  OnCancelReply="CancelReply"
                  OnTyping="HandleTyping"
                  OnLoadMore="LoadMoreMessages"
                  OnLoadNewer="LoadNewerMessages"
                  OnPinDirectMessage="HandlePinDirectMessage"
                  OnUnpinDirectMessage="HandleUnpinDirectMessage"
                  OnPinChannelMessage="HandlePinChannelMessage"
                  OnUnpinChannelMessage="HandleUnpinChannelMessage"
                  OnSearchUsers="SearchUsersForAddMember"
                  OnAddMember="AddMemberToChannel"
                  OnMarkAsLater="HandleToggleMarkAsLaterClick"
                  OnSelectToggle="HandleSelectToggle"
                  OnCancelSelection="ToggleSelectMode"
                  OnDeleteSelected="DeleteSelectedMessages"
                  OnForwardSelected="ForwardSelectedMessages"
                  FavoriteMessageIds="@favoriteMessageIds"
                  OnToggleFavorite="HandleToggleFavorite"
                  OnToggleSearchPanel="ToggleSearchPanel"
                  OnToggleSidebar="ToggleSidebar"
                  IsSearchPanelOpen="@showSearchPanel"
                  IsSidebarOpen="@showSidebar"
                  IsViewingAroundMessage="@isViewingAroundMessage"
                  OnScrollToBottom="ScrollToBottomAsync"
                  InitialDraft="@currentDraft"
                  OnDraftChanged="HandleDraftChanged"
                  IsChannel="@(!isDirectMessage)"
                  ChannelMembers="@currentChannelMembers"
                  ConversationPartner="@currentConversationPartner"
                  OnSearchMentionUsers="SearchUsersForMention" />
    </div>

    <!-- Right Panel Container (Sidebar and Search Panel share same space) -->
    @if (showSidebar || showSearchPanel)
    {
        <div class="messages-right-panel">
            <!-- Sidebar Panel (underneath) -->
            @if (showSidebar)
            {
                <div class="messages-sidebar-panel @(showSearchPanel ? "hidden" : "")">
                    <Sidebar @ref="sidebarRef"
                             IsDirectMessage="@isDirectMessage"
                             RecipientId="@recipientUserId"
                             RecipientName="@recipientName"
                             RecipientAvatarUrl="@recipientAvatarUrl"
                             IsNotesConversation="@isNotesConversation"
                             ChannelName="@selectedChannelName"
                             MemberCount="@selectedChannelMemberCount"
                             CurrentUserChannelRole="@currentUserChannelRole"
                             ConversationId="@selectedConversationId"
                             ChannelId="@selectedChannelId"
                             LastMessageId="@(isDirectMessage ? directConversations.FirstOrDefault(c => c.Id == selectedConversationId)?.LastMessageId : channelConversations.FirstOrDefault(c => c.Id == selectedChannelId)?.LastMessageId)"
                             FavoriteCount="@(isDirectMessage ? (sidebarFavoriteDirectMessages?.Count ?? 0) : (sidebarFavoriteChannelMessages?.Count ?? 0))"
                             FileCount="0"
                             LinkCount="0"
                             IsMuted="@selectedConversationIsMuted"
                             IsPinned="@selectedConversationIsPinned"
                             FavoriteDirectMessages="@sidebarFavoriteDirectMessages"
                             FavoriteChannelMessages="@sidebarFavoriteChannelMessages"
                             SharedChannels="@sharedChannels"
                             OnLoadFavorites="LoadSidebarFavorites"
                             OnNavigateToMessage="NavigateToFavoriteMessage"
                             OnRemoveFromFavorites="HandleRemoveFromFavoritesInSidebar"
                             OnLoadSharedChannels="LoadSharedChannels"
                             OnNavigateToChannel="NavigateToSharedChannel"
                             OnMuteToggle="HandleSidebarMuteToggle"
                             OnPinToggle="HandleSidebarPinToggle"
                             OnHide="HandleSidebarHide"
                             OnLeave="HandleSidebarLeave"
                             OnEditChannel="HandleSidebarEditChannel"
                             OnDeleteChannel="HandleSidebarDeleteChannel"
                             OnViewProfile="OpenProfilePanel"
                             OnClose="CloseSidebar" />
                </div>
            }

            <!-- Search Panel (on top) -->
            @if (showSearchPanel)
            {
                <div class="messages-search-panel">
                    <SearchPanel ConversationId="@selectedConversationId"
                                 ChannelId="@selectedChannelId"
                                 IsDirectMessage="@isDirectMessage"
                                 SearchFunc="@SearchMessagesAsync"
                                 OnClose="CloseSearchPanel"
                                 OnNavigateToMessage="NavigateToSearchResult" />
                </div>
            }


        </div>
    }
</div>

<!-- Profile Panel (Global Overlay) -->
<ProfilePanel @bind-IsOpen="showProfilePanel" />

    <!-- New Conversation Dialog-->
@if (showNewConversationDialog)
    {
        <div class="dialog-overlay" @onclick="CloseNewConversationDialog">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>New Message</h3>
                    <button class="dialog-close-btn" @onclick="CloseNewConversationDialog">
                        <MudIcon Icon="@Icons.Material.Filled.Close"/>
                    </button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>Search users</label>
                        <input type="text"
                               class="form-input"
                               placeholder="Type an email or name..."
                               value="@userSearchQuery"
                               @oninput="OnUserSearchInput" />
                    </div>
                    @if (isSearchingUsers)
                    {
                        <div class="search-loading">
                            <div class="loading-spinner small"></div>
                            <span>Searching...</span>
                        </div>
                    }
                    else if (userSearchResults.Any())
                    {
                        <div class="user-search-result">
                            @foreach(var user in userSearchResults)
                            {
                                <div class="user-result-item" @onclick="()=>StartConversationWithUser(user.Id)">
                                    @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                    {
                                        <img src="@user.AvatarUrl" alt="@user.FullName" class="user-result-avatar" />
                                    }
                                    else
                                    {
                                        <div class="user-result-avatar-placeholder">@StringHelper.GetInitials(user.FullName)</div>
                                    }
                                    <div class="user-result-info">
                                        <span class="user-result-name">@user.FullName</span>
                                        <span class="user-result-username">@@@user.Email</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(userSearchQuery))
                    {
                        <div class="no-results">
                            <p>No users found</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }


    <!-- New Channel Dialog -->
@if (showNewChannelDialog)
{
        <div class="dialog-overlay" @onclick="CloseNewChannelDialog">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>Create Channel</h3>
                    <button class="dialog-close-btn" @onclick="CloseNewChannelDialog">
                        <MudIcon Icon="@Icons.Material.Filled.Close" />
                    </button>
                </div>
                <div class="dialog-body">
                    <EditForm Model="@newChannelRequest" OnValidSubmit="CreateChannel">
                        <DataAnnotationsValidator />
                        <div class="form-group">
                            <label>Channel Name</label>
                            <InputText class="form-input" @bind-Value="newChannelRequest.Name" placeholder="e.g., general" />
                            <ValidationMessage For="@(() => newChannelRequest.Name)" />
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <InputTextArea class="form-input form-textarea" @bind-Value="newChannelRequest.Description" placeholder="What's this channel about?" />
                            <ValidationMessage For="@(() => newChannelRequest.Description)" />
                        </div>
                        <div class="form-group">
                            <label>Channel Type</label>
                            <div class="channel-type-selector">
                                <button type="button"
                                        class="type-option @(newChannelRequest.Type == ChannelType.Public ? "selected" : "")"
                                        @onclick="() => newChannelRequest.Type = ChannelType.Public">
                                    <MudIcon Icon="@Icons.Material.Filled.Public" />
                                    <span>Public</span>
                                    <small>Anyone can join</small>
                                </button>
                                <button type="button"
                                        class="type-option @(newChannelRequest.Type == ChannelType.Private ? "selected" : "")"
                                        @onclick="() => newChannelRequest.Type = ChannelType.Private">
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" />
                                    <span>Private</span>
                                    <small>Invite only</small>
                                </button>
                            </div>
                        </div>
                        <div class="dialog-actions">
                            <button type="button" class="btn-secondary" @onclick="CloseNewChannelDialog">Cancel</button>
                            <button type="submit" class="btn-primary" disabled="@isCreatingChannel">
                                @if (isCreatingChannel)
                                {
                                    <div class="loading-spinner small"></div>
                                }
                                else
                                {
                                    <span>Create Channel</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
}

    <!-- Forward Message Dialog -->
@if (showForwardDialog)
{
    <div class="dialog-overlay" @onclick="CancelForward">
        <div class="dialog-content forward-dialog" @onclick:stopPropagation="true">
            <div class="forward-dialog-header">
                <span class="forward-dialog-title">Forward message</span>
                <button class="dialog-close-btn" @onclick="CancelForward">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>

            <div class="forward-search-container">
                <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" Class="forward-search-icon" />
                <input type="text"
                       class="forward-search-input"
                       placeholder="Search..."
                       @bind="forwardSearchQuery"
                       @bind:event="oninput" />
            </div>

            <div class="forward-dialog-body">
                <span class="forward-section-label">Recent chats</span>

                <div class="forward-chats-list">
                    @foreach (var item in GetFilteredForwardItems())
                    {
                        <div class="forward-chat-item">
                            <div class="forward-chat-avatar @(item.IsChannel ? "channel-type" : "")">
                                @if (item.IsChannel)
                                {
                                    <MudIcon Icon="@(item.IsPrivate ? Icons.Material.Filled.Lock : Icons.Material.Filled.Group)" Size="Size.Small" />
                                }
                                else if (!string.IsNullOrEmpty(item.AvatarUrl))
                                {
                                    <img src="@item.AvatarUrl" alt="@item.Name" />
                                }
                                else
                                {
                                    <span class="avatar-initials">@StringHelper.GetInitials(item.Name)</span>
                                }
                            </div>
                            <span class="forward-chat-name">@item.Name</span>
                            <button class="forward-send-btn" @onclick="() => HandleForwardItemClick(item)">
                                <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                            </button>
                        </div>
                    }
                </div>

                @if (!GetFilteredForwardItems().Any())
                {
                    <div class="forward-empty-state">
                        <span>No chats found</span>
                    </div>
                }
            </div>
        </div>
    </div>
}


    <!-- Error Toast -->
@if (!string.IsNullOrEmpty(errorMessage))
{
        <div class="error-toast">
            <MudIcon Icon="@Icons.Material.Filled.Error" />
            <span>@errorMessage</span>
            <button @onclick="ClearError">
                <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
            </button>
        </div>
}