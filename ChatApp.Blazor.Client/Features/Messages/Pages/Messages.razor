@page "/messages"
@attribute [Authorize]
@implements IAsyncDisposable

<div class="messages-page">
    <!-- Left Panel : Conversation List -->
    <div class="messages-sidebar">
        <ConversationList Conversations="directConversations"
                          Channels="channelConversations"
                          SelectedConversationId="@selectedConversationId"
                          SelectedChannelId="@selectedChannelId"
                          IsLoading="@isLoadingConversationList"
                          ConversationTypingState="@conversationTypingState"
                          ChannelTypingUsers="@channelTypingUsers"
                          MessageDrafts="@messageDrafts"
                          OnConversationSelected="SelectDirectConversation"
                          OnChannelSelected="SelectChannel"
                          OnNewChannel="OpenNewChannelDialog"
                          OnConversationMuteToggled="HandleConversationListMuteToggle"
                          OnConversationClosed="CloseConversation"
                          OnChannelClosed="CloseConversation"
                          OnFindChatsWithUser="HandleFindChatsWithUser"
                          OnChannelLeave="HandleChannelLeave"
                          DepartmentUsers="departmentUsers"
                          HasMoreItems="@hasMoreConversationItems"
                          IsLoadingMore="@isLoadingMoreItems"
                          OnDepartmentUserSelected="StartConversationWithDepartmentUser"
                          OnLoadMore="LoadMoreConversationItems"/>
    </div>

    <!-- Main Panel: Chat Area or Create Group Panel -->
    <div class="messages-main">
        @if (showCreateGroupPanel)
        {
            <!-- Create Group Panel (Bitrix24 Style) -->
            <div class="create-group-panel">
                <div class="create-group-content">
                    <!-- Group Avatar & Name -->
                    <div class="create-group-header-section">
                        <label class="create-group-avatar @(createGroupAvatarUrl != null ? "has-image" : "")" for="groupAvatarInput">
                            @if (createGroupAvatarUrl != null)
                            {
                                <img src="@createGroupAvatarUrl" alt="Group Avatar" class="group-avatar-preview" />
                                <div class="avatar-overlay">
                                    <MudIcon Icon="@Icons.Material.Filled.CameraAlt" Size="Size.Small" />
                                </div>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.CameraAlt" Size="Size.Medium" />
                            }
                            <InputFile id="groupAvatarInput" OnChange="OnGroupAvatarSelected" accept="image/*" style="display: none;" />
                        </label>
                        <div class="create-group-name-input">
                            <input type="text"
                                   placeholder="Enter chat name"
                                   @bind="newChannelRequest.Name"
                                   @bind:event="oninput"
                                   maxlength="100"
                                   class="group-name-field @(newChannelRequest.Name?.Length > 100 ? "invalid" : "")" />
                            <span class="char-counter @(newChannelRequest.Name?.Length > 100 ? "exceeded" : "")">@(newChannelRequest.Name?.Length ?? 0)/100</span>
                        </div>
                    </div>

                    <!-- Members Section -->
                    <div class="create-group-members-section">
                        <label class="members-label"><span class="members-title">Members</span> <span class="members-hint">(add a person or a department)</span></label>
                        <div class="members-input-container">
                            <!-- Group Creator (always first, cannot be removed) -->
                            <div class="selected-member-chip creator-chip">
                                @if (!string.IsNullOrEmpty(UserState.AvatarUrl))
                                {
                                    <img src="@UserState.AvatarUrl" alt="@UserState.FullName" class="chip-avatar" />
                                }
                                else
                                {
                                    <div class="chip-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(currentUserId);">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="creator-icon" />
                                    </div>
                                }
                                <span class="chip-name">@UserState.FullName</span>
                            </div>

                            <!-- Selected Members -->
                            @foreach (var member in createGroupSelectedMembers)
                            {
                                <div class="selected-member-chip @(IsSelectedDepartment(member.Id) ? "department-chip" : "")">
                                    @if (IsSelectedDepartment(member.Id))
                                    {
                                        <div class="chip-avatar-placeholder department-avatar">
                                            <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" />
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(member.AvatarUrl))
                                    {
                                        <img src="@member.AvatarUrl" alt="@member.FullName" class="chip-avatar" />
                                    }
                                    else
                                    {
                                        <div class="chip-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(member.Id);">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="member-icon" />
                                        </div>
                                    }
                                    <span class="chip-name">@member.FullName</span>
                                    <button class="chip-remove" @onclick="() => RemoveCreateGroupMember(member.Id)" @onclick:stopPropagation="true">
                                        <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                                    </button>
                                </div>
                            }

                            <!-- Add Button / Inline Search -->
                            @if (showCreateGroupMemberSearch)
                            {
                                <input type="text"
                                       placeholder=""
                                       value="@createGroupMemberSearchQuery"
                                       @oninput="OnCreateGroupMemberSearchInput"
                                       class="inline-member-search"
                                       autofocus />
                            }
                            else
                            {
                                <button class="add-member-trigger" @onclick="ToggleCreateGroupMemberSearch" @onclick:stopPropagation="true">
                                    <span>+ Add</span>
                                </button>
                            }
                        </div>

                        <!-- Member Search Dropdown -->
                        @if (showCreateGroupMemberSearch)
                        {
                            <div class="member-picker-dropdown">
                                <!-- Header with Tabs and Close Button -->
                                <div class="picker-header">
                                    <div class="picker-tabs">
                                        <button class="picker-tab @(memberPickerTab == "recent" ? "active" : "")"
                                                @onclick="@(() => SetMemberPickerTab("recent"))">
                                            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" />
                                            <span>Recent</span>
                                        </button>
                                        <button class="picker-tab @(memberPickerTab == "departments" ? "active" : "")"
                                                @onclick="@(() => SetMemberPickerTab("departments"))">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
                                            <span>Departments</span>
                                        </button>
                                    </div>
                                    <button class="picker-close-btn" @onclick="CloseMemberPicker">
                                        <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                                    </button>
                                </div>

                                <!-- Content -->
                                <div class="picker-content">
                                    @if (isSearchingCreateGroupMembers)
                                    {
                                        <div class="picker-loading">
                                            <div class="loading-spinner small"></div>
                                            <span>Searching...</span>
                                        </div>
                                    }
                                    else if (memberPickerTab == "recent")
                                    {
                                        <!-- Recent Users -->
                                        @if (createGroupMemberSearchResults.Any())
                                        {
                                            <div class="picker-list">
                                                @foreach (var user in createGroupMemberSearchResults)
                                                {
                                                    var isSelected = createGroupSelectedMembers.Any(m => m.Id == user.Id);
                                                    <div class="picker-item @(isSelected ? "selected" : "")" @onclick="() => ToggleCreateGroupMember(user)">
                                                        <div class="picker-item-avatar" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(user.Id);">
                                                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                                            {
                                                                <img src="@user.AvatarUrl" alt="@user.FullName" />
                                                            }
                                                            else
                                                            {
                                                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                                            }
                                                        </div>
                                                        <span class="picker-item-name">@user.FullName</span>
                                                        @if (isSelected)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="picker-item-check" />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else if (!string.IsNullOrEmpty(createGroupMemberSearchQuery) && createGroupMemberSearchQuery.Length >= 2)
                                        {
                                            <div class="picker-empty">
                                                <span>No users found</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="picker-hint">
                                                <span>Type to search users...</span>
                                            </div>
                                        }
                                    }
                                    else if (memberPickerTab == "departments")
                                    {
                                        <!-- Departments - Bitrix24 Style -->
                                        @if (isLoadingDepartments)
                                        {
                                            <div class="picker-loading">
                                                <div class="loading-spinner small"></div>
                                                <span>Loading...</span>
                                            </div>
                                        }
                                        else if (createGroupDepartments.Any())
                                        {
                                            <div class="picker-list dept-list">
                                                @foreach (var dept in GetFilteredDepartments())
                                                {
                                                    var isExpanded = expandedDepartmentIds.Contains(dept.Id);
                                                    var isSelected = selectedDepartmentIds.Contains(dept.Id);

                                                    <!-- Department Header -->
                                                    <div class="picker-item dept-item @(isSelected ? "selected" : "")" @onclick="() => ToggleDepartmentSelection(dept)">
                                                        <div class="picker-item-avatar dept-avatar">
                                                            <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" />
                                                        </div>
                                                        <div class="picker-item-info">
                                                            <span class="dept-label">Department</span>
                                                            <span class="picker-item-name">@dept.Name</span>
                                                        </div>
                                                        <button class="dept-expand-btn" @onclick="() => ToggleDepartmentExpand(dept.Id)" @onclick:stopPropagation="true">
                                                            <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)" Size="Size.Small" />
                                                        </button>
                                                    </div>

                                                    <!-- Department Users (expanded) -->
                                                    @if (isExpanded)
                                                    {
                                                        @if (departmentUsersCache.TryGetValue(dept.Id, out var users))
                                                        {
                                                            @foreach (var user in users.Where(u => u.UserId != currentUserId))
                                                            {
                                                                var userSelected = createGroupSelectedMembers.Any(m => m.Id == user.UserId);
                                                                <div class="picker-item user-item @(userSelected ? "selected" : "")"
                                                                     @onclick="() => ToggleDepartmentUser(user)">
                                                                    <div class="picker-item-avatar" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(user.UserId);">
                                                                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                                                        {
                                                                            <img src="@user.AvatarUrl" alt="@user.FullName" />
                                                                        }
                                                                        else
                                                                        {
                                                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                                                        }
                                                                    </div>
                                                                    <span class="picker-item-name">@user.FullName</span>
                                                                    @if (userSelected)
                                                                    {
                                                                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="picker-item-check" />
                                                                    }
                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <div class="picker-loading small">
                                                                <div class="loading-spinner small"></div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="picker-empty">
                                                <span>No departments found</span>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Chat Settings Section -->
                    <div class="create-group-settings-section">
                        <div class="settings-header" @onclick="ToggleChatSettings">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Class="settings-icon" />
                            <span class="settings-title">Chat settings</span>
                            <MudIcon Icon="@(showChatSettings ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)"
                                     Size="Size.Small"
                                     Class="settings-expand-icon" />
                        </div>

                        @if (showChatSettings)
                        {
                            <div class="settings-content">
                                <!-- Chat Type -->
                                <div class="settings-group">
                                    <label class="settings-label">Chat type</label>
                                    <div class="chat-type-options">
                                        <label class="chat-type-option">
                                            <input type="radio"
                                                   name="chatType"
                                                   checked="@(newChannelRequest.Type == ChannelType.Private)"
                                                   @onchange="() => newChannelRequest.Type = ChannelType.Private" />
                                            <div class="option-content">
                                                <span class="option-title">Private</span>
                                                <span class="option-description">This chat will not be visible in the chat list. Chat members can only be added manually. Perfect for private communications.</span>
                                            </div>
                                        </label>
                                        <label class="chat-type-option">
                                            <input type="radio"
                                                   name="chatType"
                                                   checked="@(newChannelRequest.Type == ChannelType.Public)"
                                                   @onchange="() => newChannelRequest.Type = ChannelType.Public" />
                                            <div class="option-content">
                                                <span class="option-title">Public</span>
                                                <span class="option-description">This chat is visible to everyone in the chat list. Anyone can join. Perfect for interdepartmental communication and general conversations.</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="settings-group">
                                    <div class="settings-label-row">
                                        <label class="settings-label">Description</label>
                                        <span class="char-counter @(newChannelRequest.Description?.Length > 500 ? "exceeded" : "")">@(newChannelRequest.Description?.Length ?? 0)/500</span>
                                    </div>
                                    <textarea class="description-textarea @(newChannelRequest.Description?.Length > 500 ? "invalid" : "")"
                                              placeholder="Enter chat description"
                                              @bind="newChannelRequest.Description"
                                              @bind:event="oninput"
                                              maxlength="500"
                                              rows="4"></textarea>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Fixed Footer with Buttons -->
                <div class="create-group-footer">
                    <button class="btn-create-chat" @onclick="CreateGroupChannel" disabled="@(isCreatingChannel || IsCreateGroupFormInvalid)">
                        @if (isCreatingChannel)
                        {
                            <div class="loading-spinner small"></div>
                        }
                        else
                        {
                            <span>CREATE CHAT</span>
                        }
                    </button>
                    <button class="btn-cancel-chat" @onclick="CancelCreateGroupPanel">CANCEL</button>
                </div>
            </div>
        }
        else
        {
            <ChatArea IsEmpty="@IsEmpty"
                      IsDirectMessage="@isDirectMessage"
                      CurrentUserId="@currentUserId"
                      ConversationId="@(selectedConversationId ?? selectedChannelId)"
                      ChannelId="@selectedChannelId"
                      CacheVersion="@messageCacheVersion"
                      DirectMessages="@directMessages"
                      RecipientId="@recipientUserId"
                      RecipientName="@recipientName"
                      RecipientAvatarUrl="@recipientAvatarUrl"
                      IsRecipientOnline="@isRecipientOnline"
                      IsNotesConversation="@isNotesConversation"
                      IsPinned="@selectedConversationIsPinned"
                      IsMuted="@selectedConversationIsMuted"
                      IsMarkedReadLater="@selectedConversationIsMarkedReadLater"
                      ChannelMessages="@channelMessages"
                      ChannelName="@selectedChannelName"
                      ChannelDescription="@selectedChannelDescription"
                      ChannelType="@selectedChannelType"
                      MemberCount="@selectedChannelMemberCount"
                      PinnedCount="@pinnedChannelMessageCount"
                      PinnedDirectMessageCount="@pinnedDirectMessageCount"
                      PinnedChannelMessages="@pinnedChannelMessages"
                      PinnedDirectMessages="@pinnedDirectMessages"
                      OnNavigateToPinnedMessage="NavigateToPinnedMessage"
                      IsChannelAdmin="@isChannelAdmin"
                      IsLoading="@isLoadingMessages"
                      IsLoadingMoreMessages="@isLoadingMoreMessages"
                      HasMoreMessages="@hasMoreMessages"
                      HasMoreNewerMessages="@hasMoreNewerMessages"
                      IsSending="@isSendingMessage"
                      TypingUsers="@typingUsers"
                      IsReplying="@isReplying"
                      ReplyToMessageId="@replyToMessageId"
                      ReplyToSenderName="@replyToSenderName"
                      ReplyToContent="@replyToContent"
                      ReplyToFileId="@replyToFileId"
                      ReplyToFileName="@replyToFileName"
                      ReplyToFileContentType="@replyToFileContentType"
                      UserSearchResults="@memberSearchResults"
                      IsSearchingUsers="@isSearchingMembersForAdd"
                      UnreadSeparatorAfterMessageId="@unreadSeparatorAfterMessageId"
                      LastReadLaterMessageId="@lastReadLaterMessageId"
                      IsSelectMode="@isSelectingMessageBuble"
                      SelectedMessageIds="@selectedMessageIds"
                      CanDeleteSelected="@CanDeleteSelected()"
                      OnSendMessage="SendMessage"
                      OnSendWithFiles="HandleSendWithFiles"
                      OnEditMessage="EditMessage"
                      OnDeleteMessage="DeleteMessage"
                      OnAddReaction="AddReaction"
                      OnMentionClick="HandleMentionClick"
                      OnReply="HandleReply"
                      OnForward="HandleForward"
                      OnCancelReply="CancelReply"
                      OnTyping="HandleTyping"
                      OnLoadMore="LoadMoreMessages"
                      OnLoadNewer="LoadNewerMessages"
                      OnPinDirectMessage="HandlePinDirectMessage"
                      OnUnpinDirectMessage="HandleUnpinDirectMessage"
                      OnPinChannelMessage="HandlePinChannelMessage"
                      OnUnpinChannelMessage="HandleUnpinChannelMessage"
                      OnSearchUsers="SearchUsersForAddMember"
                      OnAddMember="AddMemberToChannel"
                      OnMarkAsLater="HandleToggleMarkAsLaterClick"
                      OnSelectToggle="HandleSelectToggle"
                      OnCancelSelection="ToggleSelectMode"
                      OnDeleteSelected="DeleteSelectedMessages"
                      OnForwardSelected="ForwardSelectedMessages"
                      FavoriteMessageIds="@favoriteMessageIds"
                      OnToggleFavorite="HandleToggleFavorite"
                      OnToggleSearchPanel="ToggleSearchPanel"
                      OnToggleSidebar="ToggleSidebar"
                      IsSearchPanelOpen="@showSearchPanel"
                      IsSidebarOpen="@showSidebar"
                      IsViewingAroundMessage="@isViewingAroundMessage"
                      OnScrollToBottom="ScrollToBottomAsync"
                      InitialDraft="@currentDraft"
                      OnDraftChanged="HandleDraftChanged"
                      IsChannel="@(!isDirectMessage)"
                      ChannelMembers="@currentChannelMembers"
                      ConversationPartner="@currentConversationPartner"
                      OnSearchMentionUsers="SearchUsersForMention" />
        }
    </div>

    <!-- Right Panel Container (Sidebar and Search Panel share same space) -->
    @if (showSidebar || showSearchPanel)
    {
        <div class="messages-right-panel">
            <!-- Sidebar Panel (underneath) -->
            @if (showSidebar)
            {
                <div class="messages-sidebar-panel @(showSearchPanel ? "hidden" : "")">
                    <Sidebar @ref="sidebarRef"
                             IsDirectMessage="@isDirectMessage"
                             RecipientId="@recipientUserId"
                             RecipientName="@recipientName"
                             RecipientAvatarUrl="@recipientAvatarUrl"
                             IsNotesConversation="@isNotesConversation"
                             ChannelName="@selectedChannelName"
                             MemberCount="@selectedChannelMemberCount"
                             CurrentUserChannelRole="@currentUserChannelRole"
                             ConversationId="@selectedConversationId"
                             ChannelId="@selectedChannelId"
                             LastMessageId="@(isDirectMessage ? directConversations.FirstOrDefault(c => c.Id == selectedConversationId)?.LastMessageId : channelConversations.FirstOrDefault(c => c.Id == selectedChannelId)?.LastMessageId)"
                             FavoriteCount="@(isDirectMessage ? (sidebarFavoriteDirectMessages?.Count ?? 0) : (sidebarFavoriteChannelMessages?.Count ?? 0))"
                             FileCount="0"
                             LinkCount="0"
                             IsMuted="@selectedConversationIsMuted"
                             IsPinned="@selectedConversationIsPinned"
                             FavoriteDirectMessages="@sidebarFavoriteDirectMessages"
                             FavoriteChannelMessages="@sidebarFavoriteChannelMessages"
                             SharedChannels="@sharedChannels"
                             OnLoadFavorites="LoadSidebarFavorites"
                             OnNavigateToMessage="NavigateToFavoriteMessage"
                             OnRemoveFromFavorites="HandleRemoveFromFavoritesInSidebar"
                             OnLoadSharedChannels="LoadSharedChannels"
                             OnNavigateToChannel="NavigateToSharedChannel"
                             OnMuteToggle="HandleSidebarMuteToggle"
                             OnPinToggle="HandleSidebarPinToggle"
                             OnHide="HandleSidebarHide"
                             OnLeave="HandleSidebarLeave"
                             OnEditChannel="HandleSidebarEditChannel"
                             OnDeleteChannel="HandleSidebarDeleteChannel"
                             OnViewProfile="OpenProfilePanel"
                             OnClose="CloseSidebar" />
                </div>
            }

            <!-- Search Panel (on top) -->
            @if (showSearchPanel)
            {
                <div class="messages-search-panel">
                    <SearchPanel ConversationId="@selectedConversationId"
                                 ChannelId="@selectedChannelId"
                                 IsDirectMessage="@isDirectMessage"
                                 SearchFunc="@SearchMessagesAsync"
                                 OnClose="CloseSearchPanel"
                                 OnNavigateToMessage="NavigateToSearchResult" />
                </div>
            }


        </div>
    }
</div>

<!-- Profile Panel (Global Overlay) -->
<ProfilePanel @bind-IsOpen="showProfilePanel" />

    <!-- New Conversation Dialog-->
@if (showNewConversationDialog)
    {
        <div class="dialog-overlay" @onclick="CloseNewConversationDialog">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>New Message</h3>
                    <button class="dialog-close-btn" @onclick="CloseNewConversationDialog">
                        <MudIcon Icon="@Icons.Material.Filled.Close"/>
                    </button>
                </div>
                <div class="dialog-body">
                    <div class="form-group">
                        <label>Search users</label>
                        <input type="text"
                               class="form-input"
                               placeholder="Type an email or name..."
                               value="@userSearchQuery"
                               @oninput="OnUserSearchInput" />
                    </div>
                    @if (isSearchingUsers)
                    {
                        <div class="search-loading">
                            <div class="loading-spinner small"></div>
                            <span>Searching...</span>
                        </div>
                    }
                    else if (userSearchResults.Any())
                    {
                        <div class="user-search-result">
                            @foreach(var user in userSearchResults)
                            {
                                <div class="user-result-item" @onclick="()=>StartConversationWithUser(user.Id)">
                                    @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                    {
                                        <img src="@user.AvatarUrl" alt="@user.FullName" class="user-result-avatar" />
                                    }
                                    else
                                    {
                                        <div class="user-result-avatar-placeholder">@StringHelper.GetInitials(user.FullName)</div>
                                    }
                                    <div class="user-result-info">
                                        <span class="user-result-name">@user.FullName</span>
                                        <span class="user-result-username">@@@user.Email</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(userSearchQuery))
                    {
                        <div class="no-results">
                            <p>No users found</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }


    <!-- New Channel Dialog -->
@if (showNewChannelDialog)
{
        <div class="dialog-overlay" @onclick="CloseNewChannelDialog">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h3>Create Channel</h3>
                    <button class="dialog-close-btn" @onclick="CloseNewChannelDialog">
                        <MudIcon Icon="@Icons.Material.Filled.Close" />
                    </button>
                </div>
                <div class="dialog-body">
                    <EditForm Model="@newChannelRequest" OnValidSubmit="CreateChannel">
                        <DataAnnotationsValidator />
                        <div class="form-group">
                            <label>Channel Name</label>
                            <InputText class="form-input" @bind-Value="newChannelRequest.Name" placeholder="e.g., general" />
                            <ValidationMessage For="@(() => newChannelRequest.Name)" />
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <InputTextArea class="form-input form-textarea" @bind-Value="newChannelRequest.Description" placeholder="What's this channel about?" />
                            <ValidationMessage For="@(() => newChannelRequest.Description)" />
                        </div>
                        <div class="form-group">
                            <label>Channel Type</label>
                            <div class="channel-type-selector">
                                <button type="button"
                                        class="type-option @(newChannelRequest.Type == ChannelType.Public ? "selected" : "")"
                                        @onclick="() => newChannelRequest.Type = ChannelType.Public">
                                    <MudIcon Icon="@Icons.Material.Filled.Public" />
                                    <span>Public</span>
                                    <small>Anyone can join</small>
                                </button>
                                <button type="button"
                                        class="type-option @(newChannelRequest.Type == ChannelType.Private ? "selected" : "")"
                                        @onclick="() => newChannelRequest.Type = ChannelType.Private">
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" />
                                    <span>Private</span>
                                    <small>Invite only</small>
                                </button>
                            </div>
                        </div>
                        <div class="dialog-actions">
                            <button type="button" class="btn-secondary" @onclick="CloseNewChannelDialog">Cancel</button>
                            <button type="submit" class="btn-primary" disabled="@isCreatingChannel">
                                @if (isCreatingChannel)
                                {
                                    <div class="loading-spinner small"></div>
                                }
                                else
                                {
                                    <span>Create Channel</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
}

    <!-- Forward Message Dialog -->
@if (showForwardDialog)
{
    <div class="dialog-overlay" @onclick="CancelForward">
        <div class="dialog-content forward-dialog" @onclick:stopPropagation="true">
            <div class="forward-dialog-header">
                <span class="forward-dialog-title">Forward message</span>
                <button class="dialog-close-btn" @onclick="CancelForward">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>

            <div class="forward-search-container">
                <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" Class="forward-search-icon" />
                <input type="text"
                       class="forward-search-input"
                       placeholder="Search..."
                       @bind="forwardSearchQuery"
                       @bind:event="oninput" />
            </div>

            <div class="forward-dialog-body">
                <span class="forward-section-label">Recent chats</span>

                <div class="forward-chats-list">
                    @foreach (var item in GetFilteredForwardItems())
                    {
                        <div class="forward-chat-item">
                            <div class="forward-chat-avatar @(item.IsChannel ? "channel-type" : "")" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(item.OtherUserId ?? item.Id);">
                                @if (item.IsChannel)
                                {
                                    <MudIcon Icon="@(item.IsPrivate ? Icons.Material.Filled.Lock : Icons.Material.Filled.Group)" Size="Size.Small" />
                                }
                                else if (!string.IsNullOrEmpty(item.AvatarUrl))
                                {
                                    <img src="@item.AvatarUrl" alt="@item.Name" />
                                }
                                else
                                {
                                    <span class="avatar-initials">@StringHelper.GetInitials(item.Name)</span>
                                }
                            </div>
                            <span class="forward-chat-name">@item.Name</span>
                            <button class="forward-send-btn" @onclick="() => HandleForwardItemClick(item)">
                                <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                            </button>
                        </div>
                    }
                </div>

                @if (!GetFilteredForwardItems().Any())
                {
                    <div class="forward-empty-state">
                        <span>No chats found</span>
                    </div>
                }
            </div>
        </div>
    </div>
}


    <!-- Error Toast -->
@if (!string.IsNullOrEmpty(errorMessage))
{
        <div class="error-toast">
            <MudIcon Icon="@Icons.Material.Filled.Error" />
            <span>@errorMessage</span>
            <button @onclick="ClearError">
                <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
            </button>
        </div>
}