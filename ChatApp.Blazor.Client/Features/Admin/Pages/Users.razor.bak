@page "/admin/users"
@attribute [Authorize]
@inject IUserService UserService
@inject IRoleService RoleService
@inject IPermissionService PermissionService
@inject UserState UserState
@using ChatApp.Blazor.Client.Features.Admin.Services

<PageTitle>User Management - ChatApp</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div class="admin-page-title-section">
            <h1 class="admin-page-title">
                <MudIcon Icon="@Icons.Material.Filled.People" />
                User Management
            </h1>
            <p class="admin-page-subtitle">Manage system users, roles, and permissions</p>
        </div>
        <div class="admin-page-actions">
            <button class="admin-btn admin-btn-primary" @onclick="OpenCreateUserDialog">
                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
                <span>Create User</span>
            </button>
        </div>
    </div>

    <div class="admin-page-content">
        <!-- Search and Filter -->
        <div class="admin-search-bar">
            <div class="admin-search-input-wrapper">
                <MudIcon Icon="@Icons.Material.Filled.Search" Class="admin-search-icon" />
                <input type="text" class="admin-search-input" placeholder="Search users by name, username, or email..." @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearch" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="admin-search-clear" @onclick="ClearSearch">
                        <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                    </button>
                }
            </div>
            <div class="admin-filter-group">
                <select class="admin-select" @bind="statusFilter" @bind:after="LoadUsers">
                    <option value="all">All Status</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="admin-loading">
                <div class="admin-loading-spinner"></div>
                <p>Loading users...</p>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="admin-error">
                <MudIcon Icon="@Icons.Material.Filled.Error" />
                <span>@errorMessage</span>
            </div>
        }
        else
        {
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th class="admin-table-actions-header">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in filteredUsers)
                        {
                            <tr class="@(user.Id == selectedUserId ? "selected" : "")">
                                <td>
                                    <div class="admin-user-cell">
                                        <div class="admin-user-avatar">
                                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                            {
                                                <img src="@user.AvatarUrl" alt="@user.DisplayName" />
                                            }
                                            else
                                            {
                                                <div class="admin-user-avatar-placeholder">
                                                    @GetInitials(user.DisplayName)
                                                </div>
                                            }
                                        </div>
                                        <div class="admin-user-info">
                                            <span class="admin-user-name">@user.DisplayName</span>
                                            <span class="admin-user-username">@("@" + user.Username)</span>
                                        </div>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    <div class="admin-badges">
                                        @if (user.IsAdmin)
                                        {
                                            <span class="admin-badge admin-badge-admin">
                                                <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Small" />
                                                Admin
                                            </span>
                                        }
                                        @foreach (var role in user.Roles.Take(2))
                                        {
                                            <span class="admin-badge admin-badge-role">@role.Name</span>
                                        }
                                        @if (user.Roles.Count > 2)
                                        {
                                            <span class="admin-badge admin-badge-more">+@(user.Roles.Count - 2)</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="admin-status @(user.IsActive ? "active" : "inactive")">
                                        @(user.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td class="admin-table-date">@user.CreatedAtUtc.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <div class="admin-table-actions">
                                        <button class="admin-action-btn" title="Manage Roles" @onclick="() => OpenManageRolesDialog(user)">
                                            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Small" />
                                        </button>
                                        <button class="admin-action-btn" title="Manage Permissions" @onclick="() => OpenManagePermissionsDialog(user)">
                                            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" />
                                        </button>
                                        <button class="admin-action-btn" title="Edit User" @onclick="() => OpenEditUserDialog(user)">
                                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                                        </button>
                                        <button class="admin-action-btn" title="Change Password" @onclick="() => OpenChangePasswordDialog(user)">
                                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                                        </button>
                                        @if (user.IsActive)
                                        {
                                            <button class="admin-action-btn admin-action-warning" title="Deactivate" @onclick="() => DeactivateUser(user)">
                                                <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" />
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="admin-action-btn admin-action-success" title="Activate" @onclick="() => ActivateUser(user)">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                            </button>
                                        }
                                        <button class="admin-action-btn admin-action-danger" title="Delete User" @onclick="() => OpenDeleteUserDialog(user)">
                                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (filteredUsers.Count == 0)
            {
                <div class="admin-empty-state">
                    <MudIcon Icon="@Icons.Material.Filled.PersonOff" />
                    <h3>No users found</h3>
                    <p>@(string.IsNullOrEmpty(searchTerm) ? "There are no users in the system yet." : "Try adjusting your search criteria.")</p>
                </div>
            }
        }
    </div>
</div>

<!-- Create User Dialog -->
@if (showCreateUserDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseCreateUserDialog">
        <div class="admin-dialog" @onclick:stopPropagation="true">
            <div class="admin-dialog-header">
                <h2>Create New User</h2>
                <button class="admin-dialog-close" @onclick="CloseCreateUserDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <EditForm Model="@createUserModel" OnValidSubmit="HandleCreateUser">
                    <DataAnnotationsValidator />

                    <div class="admin-form-row">
                        <div class="admin-form-group">
                            <label>Username *</label>
                            <InputText @bind-Value="createUserModel.Username" class="admin-input" placeholder="Enter username" />
                            <ValidationMessage For="@(() => createUserModel.Username)" />
                        </div>
                        <div class="admin-form-group">
                            <label>Email *</label>
                            <InputText @bind-Value="createUserModel.Email" type="email" class="admin-input" placeholder="Enter email" />
                            <ValidationMessage For="@(() => createUserModel.Email)" />
                        </div>
                    </div>

                    <div class="admin-form-row">
                        <div class="admin-form-group">
                            <label>Display Name *</label>
                            <InputText @bind-Value="createUserModel.DisplayName" class="admin-input" placeholder="Enter display name" />
                            <ValidationMessage For="@(() => createUserModel.DisplayName)" />
                        </div>
                        <div class="admin-form-group">
                            <label>Password *</label>
                            <InputText @bind-Value="createUserModel.Password" type="password" class="admin-input" placeholder="Enter password" />
                            <ValidationMessage For="@(() => createUserModel.Password)" />
                        </div>
                    </div>

                    <div class="admin-form-group">
                        <label>Avatar URL (Optional)</label>
                        <InputText @bind-Value="createUserModel.AvatarUrl" class="admin-input" placeholder="https://example.com/avatar.jpg" />
                    </div>

                    <div class="admin-form-group">
                        <label>Notes (Optional)</label>
                        <InputTextArea @bind-Value="createUserModel.Notes" class="admin-textarea" placeholder="Additional notes about the user..." rows="3" />
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-checkbox-label">
                            <InputCheckbox @bind-Value="createUserModel.IsAdmin" class="admin-checkbox" />
                            <span>Admin User</span>
                        </label>
                    </div>

                    @if (!string.IsNullOrEmpty(createUserMessage))
                    {
                        <div class="admin-message @(createUserSuccess ? "success" : "error")">
                            <MudIcon Icon="@(createUserSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                            <span>@createUserMessage</span>
                        </div>
                    }

                    <div class="admin-dialog-actions">
                        <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseCreateUserDialog" disabled="@isCreatingUser">
                            Cancel
                        </button>
                        <button type="submit" class="admin-btn admin-btn-primary" disabled="@isCreatingUser">
                            @if (isCreatingUser)
                            {
                                <span class="admin-btn-spinner"></span>
                                <span>Creating...</span>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
                                <span>Create User</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<UserDto> users = new();
    private List<UserDto> filteredUsers = new();
    private string searchTerm = "";
    private string statusFilter = "all";
    private bool isLoading = true;
    private string? errorMessage;
    private Guid? selectedUserId;

    // Create User Dialog
    private bool showCreateUserDialog = false;
    private CreateUserRequest createUserModel = new();
    private bool isCreatingUser = false;
    private string? createUserMessage;
    private bool createUserSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await UserService.GetUsersAsync();

            if (result.IsSuccess && result.Value != null)
            {
                users = result.Value;
                ApplyFilters();
            }
            else
            {
                errorMessage = result.Error ?? "Failed to load users";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred while loading users";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredUsers = users.Where(u =>
        {
            // Search filter
            bool matchesSearch = string.IsNullOrEmpty(searchTerm) ||
                u.DisplayName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Username.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            // Status filter
            bool matchesStatus = statusFilter == "all" ||
                (statusFilter == "active" && u.IsActive) ||
                (statusFilter == "inactive" && !u.IsActive);

            return matchesSearch && matchesStatus;
        }).ToList();
    }

    private void HandleSearch()
    {
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchTerm = "";
        ApplyFilters();
    }

    private string GetInitials(string displayName)
    {
        if (string.IsNullOrWhiteSpace(displayName))
            return "?";

        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return displayName[0].ToString().ToUpper();
    }

    // Create User
    private void OpenCreateUserDialog()
    {
        createUserModel = new CreateUserRequest();
        createUserMessage = null;
        showCreateUserDialog = true;
    }

    private void CloseCreateUserDialog()
    {
        showCreateUserDialog = false;
    }

    private async Task HandleCreateUser()
    {
        isCreatingUser = true;
        createUserMessage = null;

        try
        {
            createUserModel.CreatedBy = UserState.CurrentUser?.Id ?? Guid.Empty;
            var result = await UserService.CreateUserAsync(createUserModel);

            if (result.IsSuccess)
            {
                createUserSuccess = true;
                createUserMessage = "User created successfully!";
                await Task.Delay(1500);
                showCreateUserDialog = false;
                await LoadUsers();
            }
            else
            {
                createUserSuccess = false;
                createUserMessage = result.Error ?? "Failed to create user";
            }
        }
        catch (Exception)
        {
            createUserSuccess = false;
            createUserMessage = "An error occurred while creating the user";
        }
        finally
        {
            isCreatingUser = false;
        }
    }

    // Placeholder methods - will be implemented next
    private void OpenEditUserDialog(UserDto user) { }
    private void OpenManageRolesDialog(UserDto user) { }
    private void OpenManagePermissionsDialog(UserDto user) { }
    private void OpenChangePasswordDialog(UserDto user) { }
    private void OpenDeleteUserDialog(UserDto user) { }
    private async Task ActivateUser(UserDto user) { }
    private async Task DeactivateUser(UserDto user) { }
}
