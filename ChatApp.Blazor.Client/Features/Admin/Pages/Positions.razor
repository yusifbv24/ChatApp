@page "/admin/positions"
@attribute [Authorize]

@inject IPositionService PositionService
@inject IDepartmentService DepartmentService
@inject NavigationManager Navigation
@inject UserState UserState

<PageTitle>Positions - ChatApp</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div class="admin-page-title-section">
            <h1 class="admin-page-title">
                <MudIcon Icon="@Icons.Material.Filled.WorkOutline" />
                Positions
            </h1>
            <p class="admin-page-subtitle">Manage positions across departments</p>
        </div>
        <div class="admin-page-actions">
            <button class="admin-btn admin-btn-secondary" @onclick="NavigateBack">
                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                <span>Back</span>
            </button>
            @if (UserState.HasPermission(Permissions.UsersCreate))
            {
                <button class="admin-btn admin-btn-primary" @onclick="OpenCreateDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                    <span>New Position</span>
                </button>
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="admin-loading">
            <div class="admin-loading-spinner"></div>
            <p>Loading positions...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="admin-error">
            <MudIcon Icon="@Icons.Material.Filled.Error" />
            <span>@errorMessage</span>
        </div>
    }
    else
    {
        @* Stats Bar *@
        <div class="pos-stats-bar">
            <div class="pos-stat-item">
                <span class="pos-stat-value">@allPositions.Count</span>
                <span class="pos-stat-label">Total Positions</span>
            </div>
            <div class="pos-stat-item">
                <span class="pos-stat-value">@filteredGroups.Count</span>
                <span class="pos-stat-label">Departments</span>
            </div>
        </div>

        @* Search *@
        <div class="pos-toolbar">
            <div class="pos-search">
                <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" Class="pos-search-icon" />
                <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search by name, description or department..." class="pos-search-input" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="pos-search-clear" @onclick="() => { searchTerm = string.Empty; }">
                        <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                    </button>
                }
            </div>
        </div>

        <div class="admin-page-content">
            @if (!filteredGroups.Any())
            {
                <div class="pos-empty-state">
                    <div class="pos-empty-icon">
                        <MudIcon Icon="@Icons.Material.Filled.WorkOff" />
                    </div>
                    <h3>No positions found</h3>
                    <p>@(string.IsNullOrEmpty(searchTerm) ? "Create your first position to get started." : "Try adjusting your search terms.")</p>
                    @if (string.IsNullOrEmpty(searchTerm) && UserState.HasPermission(Permissions.UsersCreate))
                    {
                        <button class="admin-btn admin-btn-primary" @onclick="OpenCreateDialog">
                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                            <span>Create Position</span>
                        </button>
                    }
                </div>
            }
            else
            {
                <div class="pos-groups">
                    @foreach (var group in filteredGroups)
                    {
                        <div class="pos-group-card">
                            <div class="pos-group-header">
                                <div class="pos-group-header-left">
                                    <div class="pos-group-icon">
                                        <MudIcon Icon="@Icons.Material.Filled.BusinessCenter" Size="Size.Small" />
                                    </div>
                                    <span class="pos-group-name">@group.DepartmentName</span>
                                </div>
                                <span class="pos-group-badge">@group.Positions.Count @(group.Positions.Count == 1 ? "position" : "positions")</span>
                            </div>
                            <div class="pos-group-body">
                                @foreach (var pos in group.Positions)
                                {
                                    <div class="pos-item">
                                        <div class="pos-item-info">
                                            <div class="pos-item-name">@pos.Name</div>
                                            @if (!string.IsNullOrEmpty(pos.Description))
                                            {
                                                <div class="pos-item-desc">@pos.Description</div>
                                            }
                                            <div class="pos-item-meta">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                <span>@pos.CreatedAtUtc.ToString("dd MMM yyyy")</span>
                                            </div>
                                        </div>
                                        <div class="pos-item-actions">
                                            @if (UserState.HasPermission(Permissions.UsersUpdate))
                                            {
                                                <button class="pos-action-btn" title="Edit" @onclick="() => OpenEditDialog(pos)">
                                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                                                </button>
                                            }
                                            @if (UserState.HasPermission(Permissions.UsersDelete))
                                            {
                                                <button class="pos-action-btn pos-action-btn-danger" title="Delete" @onclick="() => OpenDeleteDialog(pos)">
                                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@* Create Position Dialog *@
@if (showCreateDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseCreateDialog">
        <div class="admin-dialog" @onclick:stopPropagation>
            <div class="admin-dialog-header">
                <h2>Create New Position</h2>
                <button class="admin-dialog-close" @onclick="CloseCreateDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>
            <EditForm Model="createModel" OnValidSubmit="HandleCreate">
                <DataAnnotationsValidator />
                <div class="admin-dialog-content">
                    <div class="admin-form-group">
                        <label class="admin-label">Position Name <span class="admin-required">*</span></label>
                        <InputText @bind-Value="createModel.Name" class="admin-input" placeholder="e.g. Senior Developer" />
                        <ValidationMessage For="@(() => createModel.Name)" />
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Department</label>
                        <InputSelect @bind-Value="createDepartmentId" class="admin-input">
                            <option value="">No Department</option>
                            @foreach (var dept in departments)
                            {
                                <option value="@dept.Id">@dept.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Description</label>
                        <InputTextArea @bind-Value="createModel.Description" class="admin-input admin-textarea" rows="3" placeholder="Brief description of the position responsibilities..." />
                        <ValidationMessage For="@(() => createModel.Description)" />
                    </div>

                    @if (!string.IsNullOrEmpty(dialogMessage))
                    {
                        <div class="admin-message @(dialogSuccess ? "success" : "error")">
                            <MudIcon Icon="@(dialogSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                            <span>@dialogMessage</span>
                        </div>
                    }

                    <div class="admin-dialog-actions">
                        <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseCreateDialog" disabled="@isSaving">Cancel</button>
                        <button type="submit" class="admin-btn admin-btn-primary" disabled="@isSaving">
                            @if (isSaving) { <span class="admin-loading-spinner small"></span> }
                            Create Position
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
}

@* Edit Position Dialog *@
@if (showEditDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseEditDialog">
        <div class="admin-dialog" @onclick:stopPropagation>
            <div class="admin-dialog-header">
                <h2>Edit Position</h2>
                <button class="admin-dialog-close" @onclick="CloseEditDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>
            <EditForm Model="editModel" OnValidSubmit="HandleEdit">
                <DataAnnotationsValidator />
                <div class="admin-dialog-content">
                    <div class="admin-form-group">
                        <label class="admin-label">Position Name <span class="admin-required">*</span></label>
                        <InputText @bind-Value="editModel.Name" class="admin-input" />
                        <ValidationMessage For="@(() => editModel.Name)" />
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Department</label>
                        <InputSelect @bind-Value="editDepartmentId" class="admin-input">
                            <option value="">No Department</option>
                            @foreach (var dept in departments)
                            {
                                <option value="@dept.Id">@dept.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Description</label>
                        <InputTextArea @bind-Value="editModel.Description" class="admin-input admin-textarea" rows="3" />
                        <ValidationMessage For="@(() => editModel.Description)" />
                    </div>

                    @if (!string.IsNullOrEmpty(dialogMessage))
                    {
                        <div class="admin-message @(dialogSuccess ? "success" : "error")">
                            <MudIcon Icon="@(dialogSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                            <span>@dialogMessage</span>
                        </div>
                    }

                    <div class="admin-dialog-actions">
                        <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseEditDialog" disabled="@isSaving">Cancel</button>
                        <button type="submit" class="admin-btn admin-btn-primary" disabled="@isSaving">
                            @if (isSaving) { <span class="admin-loading-spinner small"></span> }
                            Save Changes
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
}

@* Delete Confirmation Dialog *@
@if (showDeleteDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseDeleteDialog">
        <div class="admin-dialog admin-dialog-small" @onclick:stopPropagation>
            <div class="admin-dialog-header">
                <h2>Delete Position</h2>
                <button class="admin-dialog-close" @onclick="CloseDeleteDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <div class="pos-delete-warning">
                    <div class="pos-delete-icon">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" />
                    </div>
                    <p>Are you sure you want to delete <strong>@deleteTarget?.Name</strong>?</p>
                    <p class="admin-text-muted">This action cannot be undone.</p>
                </div>

                @if (!string.IsNullOrEmpty(dialogMessage))
                {
                    <div class="admin-message error">
                        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                        <span>@dialogMessage</span>
                    </div>
                }

                <div class="admin-dialog-actions">
                    <button class="admin-btn admin-btn-secondary" @onclick="CloseDeleteDialog" disabled="@isSaving">Cancel</button>
                    <button class="admin-btn admin-btn-danger" @onclick="HandleDelete" disabled="@isSaving">
                        @if (isSaving) { <span class="admin-loading-spinner small"></span> }
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
}
