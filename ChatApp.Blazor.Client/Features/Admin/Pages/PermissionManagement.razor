@page "/admin/permissions"
@attribute [Authorize]
@inject IPermissionService PermissionService
@inject IRoleService RoleService
@inject UserState UserState
@inject ISnackbar Snackbar

<PageTitle>Permission Management - ChatApp</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Lock" Class="mr-2" />
    Permission Management
</MudText>

@if (!UserState.HasPermission("Roles.Read"))
{
    <MudAlert Severity="Severity.Warning">You don't have permission to view permissions.</MudAlert>
}
else
{
    <MudGrid>
        <!-- Filter by Module -->
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4 animate-fade-in-up">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudText Typo="Typo.h6">Filter by Module:</MudText>

                    <MudChipSet T="string" @bind-SelectedChip="_selectedModuleChip" Filter="true" Mandatory="false">
                        <MudChip Text="All" Color="Color.Primary" Default="true" />
                        @foreach (var module in _modules)
                        {
                            <MudChip Text="@module" Color="Color.Default" />
                        }
                    </MudChipSet>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Permissions Grid -->
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4 animate-fade-in-up delay-100">
                @if (_isLoading)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                }
                else
                {
                    <MudText Typo="Typo.h6" Class="mb-4">
                        Permissions (@_filteredPermissions.Count)
                    </MudText>

                    <!-- Group permissions by module -->
                    @foreach (var moduleGroup in _filteredPermissions.GroupBy(p => p.Module))
                    {
                        <MudStack Spacing="3" Class="mb-4">
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Class="mr-2" />
                                @moduleGroup.Key
                            </MudText>

                            <MudGrid>
                                @foreach (var permission in moduleGroup)
                                {
                                    <MudItem xs="12" sm="6" md="4">
                                        <MudCard Elevation="1" Class="hover-lift transition-all">
                                            <MudCardContent>
                                                <MudStack Spacing="2">
                                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                                        <MudIcon Icon="@GetPermissionIcon(permission.Name)" Color="Color.Primary" />
                                                    </MudStack>

                                                    <MudText Typo="Typo.subtitle1">
                                                        <b>@permission.Name</b>
                                                    </MudText>

                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                        @permission.Description
                                                    </MudText>

                                                    <MudDivider />

                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        <b>Assigned to Roles:</b>
                                                    </MudText>

                                                    <MudStack Row="true" Spacing="1">
                                                        @{
                                                            var rolesWithPermission = _allRoles
                                                                .Where(r => r.Permissions.Any(p => p.Id == permission.Id))
                                                                .ToList();
                                                        }

                                                        @if (rolesWithPermission.Any())
                                                        {
                                                            @foreach (var role in rolesWithPermission)
                                                            {
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@role.Name</MudChip>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Not assigned</MudText>
                                                        }
                                                    </MudStack>
                                                </MudStack>
                                            </MudCardContent>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudStack>

                        <MudDivider Class="my-4" />
                    }
                }
            </MudPaper>
        </MudItem>

        <!-- Permission Statistics -->
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="pa-4 animate-fade-in-up delay-200">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Statistics</MudText>

                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Permissions</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">@_allPermissions.Count</MudText>
                    </MudStack>

                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Modules</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Secondary">@_modules.Count</MudText>
                    </MudStack>

                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Roles</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Info">@_allRoles.Count</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Module Breakdown -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-4 animate-fade-in-up delay-300">
                <MudText Typo="Typo.h6" Class="mb-4">Module Breakdown</MudText>

                @foreach (var module in _modules)
                {
                    var count = _allPermissions.Count(p => p.Module == module);
                    var percentage = (count * 100.0) / _allPermissions.Count;

                    <MudStack Spacing="1" Class="mb-3">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2">@module</MudText>
                            <MudText Typo="Typo.body2">@count permissions</MudText>
                        </MudStack>
                        <MudProgressLinear Value="@percentage" Color="Color.Primary" Size="Size.Medium" />
                    </MudStack>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private List<PermissionDto> _allPermissions = new();
    private List<PermissionDto> _filteredPermissions = new();
    private List<RoleDto> _allRoles = new();
    private List<string> _modules = new();
    private bool _isLoading = true;
    private string? _selectedModuleChip;

    protected override async Task OnInitializedAsync()
    {
        await LoadPermissions();
        await LoadRoles();
        FilterPermissions();
    }

    private async Task LoadPermissions()
    {
        _isLoading = true;

        try
        {
            var result = await PermissionService.GetPermissionsAsync();

            if (result.IsSuccess && result.Value != null)
            {
                _allPermissions = result.Value;

                // Extract unique modules
                _modules = _allPermissions
                    .Select(p => p.Module ?? "Unknown")
                    .Distinct()
                    .OrderBy(m => m)
                    .ToList();

                FilterPermissions();
            }
            else
            {
                Snackbar.Add(result.Error ?? "Failed to load permissions", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadRoles()
    {
        var result = await RoleService.GetRolesAsync();

        if (result.IsSuccess && result.Value != null)
        {
            _allRoles = result.Value;
        }
    }

    private void FilterPermissions()
    {
        if (_selectedModuleChip == null || _selectedModuleChip == "All")
        {
            _filteredPermissions = _allPermissions;
        }
        else
        {
            _filteredPermissions = _allPermissions
                .Where(p => p.Module == _selectedModuleChip)
                .ToList();
        }
    }

    private string GetPermissionIcon(string? permissionName)
    {
        if (permissionName == null) return Icons.Material.Filled.Lock;

        return permissionName.ToLower() switch
        {
            var p when p.Contains("create") => Icons.Material.Filled.Add,
            var p when p.Contains("read") => Icons.Material.Filled.Visibility,
            var p when p.Contains("update") => Icons.Material.Filled.Edit,
            var p when p.Contains("delete") => Icons.Material.Filled.Delete,
            var p when p.Contains("manage") => Icons.Material.Filled.Settings,
            var p when p.Contains("send") => Icons.Material.Filled.Send,
            var p when p.Contains("upload") => Icons.Material.Filled.Upload,
            var p when p.Contains("download") => Icons.Material.Filled.Download,
            _ => Icons.Material.Filled.Lock
        };
    }
}
