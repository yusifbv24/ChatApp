@page "/admin/roles"
@attribute [Authorize]
@using ChatApp.Blazor.Client.Features.Admin.Services

<PageTitle>Role Management - ChatApp</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div class="admin-page-title-section">
            <h1 class="admin-page-title">
                <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" />
                Role Management
            </h1>
            <p class="admin-page-subtitle">Manage system roles and their permissions</p>
        </div>
        <div class="admin-page-actions">
            <button class="admin-btn admin-btn-primary" @onclick="OpenCreateRoleDialog">
                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                <span>Create Role</span>
            </button>
        </div>
    </div>

    <div class="admin-page-content">
        <div class="admin-search-bar">
            <div class="admin-search-input-wrapper">
                <MudIcon Icon="@Icons.Material.Filled.Search" Class="admin-search-icon" />
                <input type="text" class="admin-search-input" placeholder="Search roles..." @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearch" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="admin-search-clear" @onclick="ClearSearch">
                        <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                    </button>
                }
            </div>
        </div>

        @if (isLoading)
        {
            <div class="admin-loading">
                <div class="admin-loading-spinner"></div>
                <p>Loading roles...</p>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="admin-error">
                <MudIcon Icon="@Icons.Material.Filled.Error" />
                <span>@errorMessage</span>
            </div>
        }
        else
        {
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Role Name</th>
                            <th>Description</th>
                            <th>Permissions</th>
                            <th>Created</th>
                            <th class="admin-table-actions-header">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var role in filteredRoles)
                        {
                            <tr>
                                <td>
                                    <div class="admin-role-name-cell">
                                        <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" />
                                        <strong>@role.Name</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="admin-table-description">@(role.Description ?? "No description")</span>
                                </td>
                                <td>
                                    <span class="admin-badge admin-badge-role">
                                        @role.Permissions.Count @(role.Permissions.Count == 1 ? "permission" : "permissions")
                                    </span>
                                </td>
                                <td class="admin-table-date">@role.CreatedAtUtc.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <div class="admin-table-actions">
                                        <button class="admin-action-btn" title="Manage Permissions" @onclick="() => OpenManagePermissionsDialog(role)">
                                            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" />
                                        </button>
                                        <button class="admin-action-btn" title="Edit Role" @onclick="() => OpenEditRoleDialog(role)">
                                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                                        </button>
                                        <button class="admin-action-btn admin-action-danger" title="Delete Role" @onclick="() => OpenDeleteRoleDialog(role)">
                                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (filteredRoles.Count == 0)
            {
                <div class="admin-empty-state">
                    <MudIcon Icon="@Icons.Material.Filled.Security" />
                    <h3>No roles found</h3>
                    <p>@(string.IsNullOrEmpty(searchTerm) ? "There are no roles in the system yet." : "Try adjusting your search criteria.")</p>
                </div>
            }
        }
    </div>
</div>

@* Create Role Dialog *@
@if (showCreateRoleDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseCreateRoleDialog">
        <div class="admin-dialog" @onclick:stopPropagation="true">
            <div class="admin-dialog-header">
                <h2>Create New Role</h2>
                <button class="admin-dialog-close" @onclick="CloseCreateRoleDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <EditForm Model="@createRoleModel" OnValidSubmit="HandleCreateRole">
                    <DataAnnotationsValidator />

                    <div class="admin-form-group">
                        <label>Role Name *</label>
                        <InputText @bind-Value="createRoleModel.Name" class="admin-input" placeholder="Enter role name" />
                        <ValidationMessage For="@(() => createRoleModel.Name)" />
                    </div>

                    <div class="admin-form-group">
                        <label>Description (Optional)</label>
                        <InputTextArea @bind-Value="createRoleModel.Description" class="admin-textarea" placeholder="Enter role description..." rows="3" />
                    </div>

                    @if (!string.IsNullOrEmpty(createRoleMessage))
                    {
                        <div class="admin-message @(createRoleSuccess ? "success" : "error")">
                            <MudIcon Icon="@(createRoleSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                            <span>@createRoleMessage</span>
                        </div>
                    }

                    <div class="admin-dialog-actions">
                        <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseCreateRoleDialog" disabled="@isCreatingRole">
                            Cancel
                        </button>
                        <button type="submit" class="admin-btn admin-btn-primary" disabled="@isCreatingRole">
                            @if (isCreatingRole)
                            {
                                <span class="admin-btn-spinner"></span>
                                <span>Creating...</span>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                                <span>Create Role</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Edit Role Dialog *@
@if (showEditRoleDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseEditRoleDialog">
        <div class="admin-dialog" @onclick:stopPropagation="true">
            <div class="admin-dialog-header">
                <h2>Edit Role</h2>
                <button class="admin-dialog-close" @onclick="CloseEditRoleDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <EditForm Model="@editRoleModel" OnValidSubmit="HandleEditRole">
                    <DataAnnotationsValidator />

                    <div class="admin-form-group">
                        <label>Role Name *</label>
                        <InputText @bind-Value="editRoleModel.Name" class="admin-input" placeholder="Enter role name" />
                        <ValidationMessage For="@(() => editRoleModel.Name)" />
                    </div>

                    <div class="admin-form-group">
                        <label>Description (Optional)</label>
                        <InputTextArea @bind-Value="editRoleModel.Description" class="admin-textarea" placeholder="Enter role description..." rows="3" />
                    </div>

                    @if (!string.IsNullOrEmpty(editRoleMessage))
                    {
                        <div class="admin-message @(editRoleSuccess ? "success" : "error")">
                            <MudIcon Icon="@(editRoleSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                            <span>@editRoleMessage</span>
                        </div>
                    }

                    <div class="admin-dialog-actions">
                        <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseEditRoleDialog" disabled="@isUpdatingRole">
                            Cancel
                        </button>
                        <button type="submit" class="admin-btn admin-btn-primary" disabled="@isUpdatingRole">
                            @if (isUpdatingRole)
                            {
                                <span class="admin-btn-spinner"></span>
                                <span>Updating...</span>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Save" Size="Size.Small" />
                                <span>Save Changes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Manage Permissions Dialog *@
@if (showManagePermissionsDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseManagePermissionsDialog">
        <div class="admin-dialog admin-dialog-large" @onclick:stopPropagation="true">
            <div class="admin-dialog-header">
                <h2>Manage Permissions - @managingPermissionsRole?.Name</h2>
                <button class="admin-dialog-close" @onclick="CloseManagePermissionsDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <div class="admin-form-group">
                    <label>Filter by Module</label>
                    <select class="admin-select" @bind="selectedModule" @bind:after="FilterPermissionsByModule">
                        <option value="all">All Modules</option>
                        @foreach (var module in availablePermissions.Select(p => p.Module).Distinct())
                        {
                            <option value="@module">@module</option>
                        }
                    </select>
                </div>

                <div class="admin-permissions-list">
                    @foreach (var permission in filteredPermissions)
                    {
                        <label class="admin-permission-item">
                            <input type="checkbox"
                                   checked="@selectedPermissionIds.Contains(permission.Id)"
                                   @onchange="() => TogglePermission(permission.Id)"
                                   class="admin-checkbox" />
                            <div class="admin-permission-info">
                                <span class="admin-permission-name">@permission.Name</span>
                                <span class="admin-permission-description">@permission.Description</span>
                            </div>
                        </label>
                    }
                </div>

                @if (!string.IsNullOrEmpty(permissionsMessage))
                {
                    <div class="admin-message @(permissionsSuccess ? "success" : "error")">
                        <MudIcon Icon="@(permissionsSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" Size="Size.Small" />
                        <span>@permissionsMessage</span>
                    </div>
                }

                <div class="admin-dialog-actions">
                    <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseManagePermissionsDialog" disabled="@isUpdatingPermissions">
                        Cancel
                    </button>
                    <button type="button" class="admin-btn admin-btn-primary" @onclick="SavePermissions" disabled="@isUpdatingPermissions">
                        @if (isUpdatingPermissions)
                        {
                            <span class="admin-btn-spinner"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Save" Size="Size.Small" />
                            <span>Save Permissions</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Role Dialog *@
@if (showDeleteRoleDialog)
{
    <div class="admin-dialog-overlay" @onclick="CloseDeleteRoleDialog">
        <div class="admin-dialog admin-dialog-small" @onclick:stopPropagation="true">
            <div class="admin-dialog-header">
                <h2>Delete Role</h2>
                <button class="admin-dialog-close" @onclick="CloseDeleteRoleDialog">
                    <MudIcon Icon="@Icons.Material.Filled.Close" />
                </button>
            </div>
            <div class="admin-dialog-content">
                <div class="admin-delete-warning">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Class="admin-delete-icon" />
                    <h3>Are you sure?</h3>
                    <p>You are about to delete the role:</p>
                    <div class="admin-delete-user-info">
                        <strong>@deletingRole?.Name</strong>
                        <span>@(deletingRole?.Description ?? "No description")</span>
                    </div>
                    <p class="admin-delete-note">This action cannot be undone. All users with this role will lose their role permissions.</p>
                </div>

                @if (!string.IsNullOrEmpty(deleteRoleMessage))
                {
                    <div class="admin-message error">
                        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                        <span>@deleteRoleMessage</span>
                    </div>
                }

                <div class="admin-dialog-actions">
                    <button type="button" class="admin-btn admin-btn-secondary" @onclick="CloseDeleteRoleDialog" disabled="@isDeletingRole">
                        Cancel
                    </button>
                    <button type="button" class="admin-btn admin-btn-danger" @onclick="HandleDeleteRole" disabled="@isDeletingRole">
                        @if (isDeletingRole)
                        {
                            <span class="admin-btn-spinner"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                            <span>Delete Role</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}
