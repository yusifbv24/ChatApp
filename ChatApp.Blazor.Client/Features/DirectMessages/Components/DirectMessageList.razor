@inject IDirectMessageService MessageService
@inject DirectMessageState DirectMessageState

<div class="dm-list" @ref="_messageListRef">
    @if (_isLoading && !_messages.Any())
    {
        <div class="d-flex justify-center align-center pa-8">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }
    else if (!_messages.Any())
    {
        <div class="d-flex flex-column justify-center align-center pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Outlined.ChatBubbleOutline"
                     Size="Size.Large"
                     Color="Color.Secondary"
                     Class="mb-4" />
            <MudText Typo="Typo.H6" Color="Color.Secondary">
                No messages yet
            </MudText>
            <MudText Typo="Typo.Body2" Color="Color.Secondary">
                Be the first to send a message!
            </MudText>
        </div>
    }
    else
    {
        <div class="messages-container">
            @if (_hasMoreMessages)
            {
                <div class="text-center pa-2">
                    <MudButton Variant="Variant.Text"
                               OnClick="LoadMoreMessages"
                               Disabled="@_isLoadingMore">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        }
                        else
                        {
                            <span>Load More Messages</span>
                        }
                    </MudButton>
                </div>
            }

            @{
                DateTime? lastDate = null;
            }

            @foreach (var message in _messages.OrderBy(m => m.CreatedAtUtc))
            {
                var messageDate = message.CreatedAtUtc.ToLocalTime().Date;

                @if (lastDate == null || lastDate.Value.Date != messageDate)
                {
                    <div class="date-separator">
                        <MudDivider />
                        <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                            @GetDateLabel(messageDate)
                        </MudChip>
                        <MudDivider />
                    </div>
                    lastDate = messageDate;
                }

                <DirectMessageItem Message="@message"
                                  ConversationId="@ConversationId"
                                  OnMessageChanged="OnMessageChanged" />
            }
        </div>

        <div @ref="_scrollAnchorRef" style="height: 1px;"></div>
    }
</div>

<style>
    .dm-list {
        height: 100%;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    .messages-container {
        flex: 1;
    }

    .date-separator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 16px 0;
    }

    .date-separator .mud-divider {
        flex: 1;
    }
</style>

@code {
    [Parameter] public Guid ConversationId { get; set; }

    private List<DirectMessageDto> _messages = new();
    private bool _isLoading = false;
    private bool _isLoadingMore = false;
    private bool _hasMoreMessages = true;
    private ElementReference _messageListRef;
    private ElementReference _scrollAnchorRef;
    private bool _shouldScrollToBottom = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadMessages();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_messages.Any() && _messages[0].ConversationId != ConversationId)
        {
            await LoadMessages();
        }
    }

    private async Task LoadMessages()
    {
        _isLoading = true;

        var result = await MessageService.GetMessagesAsync(ConversationId, pageSize: 50);

        _isLoading = false;

        if (result.IsSuccess)
        {
            _messages = result.Data ?? new();
            _hasMoreMessages = _messages.Count >= 50;
            _shouldScrollToBottom = true;
            DirectMessageState.SetCurrentMessages(_messages);
        }
    }

    private async Task LoadMoreMessages()
    {
        if (!_messages.Any()) return;

        _isLoadingMore = true;

        var oldestMessage = _messages.OrderBy(m => m.CreatedAtUtc).First();
        var result = await MessageService.GetMessagesAsync(ConversationId, pageSize: 50, beforeUtc: oldestMessage.CreatedAtUtc);

        _isLoadingMore = false;

        if (result.IsSuccess && result.Data != null)
        {
            _messages.InsertRange(0, result.Data);
            _hasMoreMessages = result.Data.Count >= 50;
        }
    }

    private async Task OnMessageChanged()
    {
        await LoadMessages();
        StateHasChanged();
    }

    private string GetDateLabel(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date == today)
            return "Today";
        else if (date == yesterday)
            return "Yesterday";
        else if (date.Year == today.Year)
            return date.ToString("MMMM dd");
        else
            return date.ToString("MMMM dd, yyyy");
    }

    public async Task RefreshMessages()
    {
        await LoadMessages();
        _shouldScrollToBottom = true;
        StateHasChanged();
    }
}
