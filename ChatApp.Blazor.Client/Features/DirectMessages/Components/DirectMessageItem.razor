@inject IDirectMessageService MessageService
@inject ISnackbar Snackbar
@inject UserState UserState

<div class="dm-item @(_isOwnMessage ? "own-message" : "other-message")"
     style="animation: fadeIn 0.3s ease-out;">

    <div class="message-header d-flex align-items-center gap-2 mb-1">
        @if (!_isOwnMessage)
        {
            <MudAvatar Color="Color.Primary" Size="Size.Small">
                @_message.SenderDisplayName.Substring(0, 1).ToUpper()
            </MudAvatar>

            <MudText Typo="Typo.Subtitle2" Class="font-weight-bold">
                @_message.SenderDisplayName
            </MudText>
        }

        <MudText Typo="Typo.Caption" Color="Color.Secondary">
            @_message.CreatedAtUtc.ToLocalTime().ToString("HH:mm")
            @if (_message.IsEdited)
            {
                <span class="ml-1">(edited)</span>
            }
        </MudText>

        @if (_message.IsRead && _isOwnMessage)
        {
            <MudIcon Icon="@Icons.Material.Filled.DoneAll"
                     Size="Size.Small"
                     Color="Color.Primary"
                     Title="@($"Read at {_message.ReadAtUtc?.ToLocalTime():HH:mm}")" />
        }
        else if (_isOwnMessage)
        {
            <MudIcon Icon="@Icons.Material.Filled.Done"
                     Size="Size.Small"
                     Color="Color.Secondary"
                     Title="Sent" />
        }

        <MudSpacer />

        @if (_isOwnMessage)
        {
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="StartEdit">Edit</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                             OnClick="DeleteMessage"
                             Class="text-error">
                    Delete
                </MudMenuItem>
            </MudMenu>
        }
    </div>

    <div class="message-content">
        @if (_isEditing)
        {
            <div class="edit-box">
                <MudTextField @bind-Value="_editContent"
                              Lines="3"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Class="mb-2" />
                <div class="d-flex gap-2">
                    <MudButton Size="Size.Small"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveEdit"
                               Disabled="@_isUpdating">
                        Save
                    </MudButton>
                    <MudButton Size="Size.Small"
                               Variant="Variant.Text"
                               OnClick="CancelEdit">
                        Cancel
                    </MudButton>
                </div>
            </div>
        }
        else
        {
            <MudText Typo="Typo.Body2" Style="white-space: pre-wrap;">
                @_message.Content
            </MudText>
        }
    </div>

    @if (_message.ReactionCount > 0)
    {
        <div class="reactions mt-2">
            <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                üëç @_message.ReactionCount
            </MudChip>
        </div>
    }

    <div class="mt-1">
        <MudButton StartIcon="@Icons.Material.Outlined.AddReaction"
                   Size="Size.Small"
                   Variant="Variant.Text"
                   OnClick="AddReaction">
            React
        </MudButton>
    </div>
</div>

<style>
    .dm-item {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: background-color 0.2s;
    }

    .dm-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .own-message {
        background-color: rgba(var(--mud-palette-primary-rgb), 0.05);
        margin-left: auto;
        max-width: 80%;
    }

    .other-message {
        background-color: rgba(0, 0, 0, 0.02);
        margin-right: auto;
        max-width: 80%;
    }
</style>

@code {
    [Parameter] public DirectMessageDto Message { get; set; } = null!;
    [Parameter] public Guid ConversationId { get; set; }
    [Parameter] public EventCallback OnMessageChanged { get; set; }

    private DirectMessageDto _message = null!;
    private bool _isOwnMessage = false;
    private bool _isEditing = false;
    private bool _isUpdating = false;
    private string _editContent = string.Empty;

    protected override void OnParametersSet()
    {
        _message = Message;
        _isOwnMessage = _message.SenderId == UserState.CurrentUser?.Id;
    }

    private void StartEdit()
    {
        _editContent = _message.Content;
        _isEditing = true;
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _editContent = string.Empty;
    }

    private async Task SaveEdit()
    {
        if (string.IsNullOrWhiteSpace(_editContent)) return;

        _isUpdating = true;

        var request = new EditMessageRequest { NewContent = _editContent.Trim() };
        var result = await MessageService.EditMessageAsync(ConversationId, _message.Id, request);

        _isUpdating = false;

        if (result.IsSuccess)
        {
            _isEditing = false;
            Snackbar.Add("Message updated", Severity.Success);
            await OnMessageChanged.InvokeAsync();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to update message", Severity.Error);
        }
    }

    private async Task DeleteMessage()
    {
        var result = await MessageService.DeleteMessageAsync(ConversationId, _message.Id);

        if (result.IsSuccess)
        {
            Snackbar.Add("Message deleted", Severity.Success);
            await OnMessageChanged.InvokeAsync();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to delete message", Severity.Error);
        }
    }

    private async Task AddReaction()
    {
        var request = new AddReactionRequest { Reaction = "üëç" };
        var result = await MessageService.AddReactionAsync(ConversationId, _message.Id, request);

        if (result.IsSuccess)
        {
            await OnMessageChanged.InvokeAsync();
        }
        else
        {
            Snackbar.Add(result.Error ?? "Failed to add reaction", Severity.Error);
        }
    }
}
