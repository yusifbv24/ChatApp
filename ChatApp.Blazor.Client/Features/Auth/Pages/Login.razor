@page "/login"
@layout LoginLayout
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Login - ChatApp</PageTitle>

<MudPaper Elevation="0" Class="login-card">
    <MudStack Spacing="4" AlignItems="AlignItems.Center">
        <!-- Logo -->
        <div class="logo-wrapper">
            <img src="icon-512.png" alt="ChatApp Logo" class="app-logo" />
        </div>

        <!-- Title -->
        <MudStack AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h4" Class="login-title">
                Welcome back
            </MudText>
            <MudText Typo="Typo.body2" Class="login-subtitle">
                Sign in to continue
            </MudText>
        </MudStack>

        <!-- Login Form -->
        <EditForm Model="@_model" OnValidSubmit="HandleLogin" style="width: 100%;">
            <DataAnnotationsValidator />

            <MudStack Spacing="4">
                <div class="input-wrapper">
                    <MudTextField @bind-Value="_model.Username"
                                  Label="Username"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  Required="false"
                                  For="@(() => _model.Username)"
                                  Disabled="@_isLoading"
                                  Class="custom-input"
                                  Placeholder="Enter your username" />
                </div>

                <div class="input-wrapper">
                    <MudTextField @bind-Value="_model.Password"
                                  Label="Password"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  InputType="@_passwordInputType"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@_passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  Required="false"
                                  For="@(() => _model.Password)"
                                  Disabled="@_isLoading"
                                  Class="custom-input"
                                  Placeholder="Enter your password" />
                </div>

                <MudCheckBox @bind-Value="_model.RememberMe"
                             Label="Remember me"
                             Disabled="@_isLoading"
                             Class="custom-checkbox"
                             Color="Color.Default" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true" Class="error-alert">@_errorMessage</MudAlert>
                }

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@_isLoading"
                           Class="login-button">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudStack>
</MudPaper>

<style>
    .login-card {
        width: 100%;
        max-width: 440px;
        padding: 56px 48px;
        border-radius: 16px;
        background: #FFFFFF;
        box-shadow: 0 10px 40px rgba(43, 169, 225, 0.12);
        border: 1px solid rgba(43, 169, 225, 0.08);
    }

    .logo-wrapper {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        animation: fadeInDown 0.6s ease-out;
    }

    .app-logo {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 4px 12px rgba(43, 169, 225, 0.2));
    }

    .login-title {
        font-weight: 700;
        color: #1a1a1a;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .login-subtitle {
        color: #6b7280;
        font-size: 15px;
    }

    .input-wrapper {
        width: 100%;
    }

    .custom-input {
        width: 100%;
    }

    .custom-input .mud-input-root {
        border-radius: 10px;
        overflow: hidden;
    }

    .custom-input .mud-input-filled {
        background-color: #f8f9fc !important;
        border: 2px solid #e1e8f0;
        border-radius: 10px;
        padding: 4px 12px;
        transition: all 0.3s ease;
    }

    .custom-input .mud-input-filled:hover {
        border-color: #2BA9E1;
        background-color: #ffffff !important;
    }

    .custom-input .mud-input-filled.mud-input-filled-focused {
        border-color: #2BA9E1;
        background-color: #ffffff !important;
        box-shadow: 0 0 0 3px rgba(43, 169, 225, 0.1);
    }

    .custom-input .mud-input-slot {
        padding: 12px 0;
    }

    .custom-input input {
        color: #1a1a1a !important;
        font-size: 15px;
        font-weight: 500;
        padding: 0;
    }

    .custom-input input::placeholder {
        color: #9ca3af !important;
        font-weight: 400;
    }

    .custom-input .mud-input-label {
        color: #6b7280 !important;
        font-size: 14px;
        font-weight: 500;
        transform: translateY(-8px);
    }

    .custom-input .mud-input-label-filled {
        color: #2BA9E1 !important;
        font-size: 13px;
        font-weight: 600;
    }

    .custom-input .mud-input-adornment {
        color: #6b7280 !important;
    }

    .custom-input .mud-input-adornment button {
        color: #6b7280 !important;
        transition: all 0.2s ease;
    }

    .custom-input .mud-input-adornment button:hover {
        color: #2BA9E1 !important;
        background-color: rgba(43, 169, 225, 0.1);
    }

    .custom-input input:-webkit-autofill,
    .custom-input input:-webkit-autofill:hover,
    .custom-input input:-webkit-autofill:focus {
        -webkit-text-fill-color: #1a1a1a !important;
        -webkit-box-shadow: 0 0 0px 1000px #ffffff inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    .custom-checkbox {
        margin-top: 0;
    }

    .custom-checkbox label {
        color: #4b5563;
        font-size: 14px;
        font-weight: 500;
    }

    .custom-checkbox .mud-checkbox-root {
        color: #cbd5e1;
    }

    .custom-checkbox .mud-checkbox-root:hover {
        background-color: rgba(43, 169, 225, 0.08);
    }

    .custom-checkbox.mud-checkbox-checked .mud-checkbox-root {
        color: #2BA9E1 !important;
    }

    .custom-checkbox .mud-ripple {
        color: #2BA9E1 !important;
    }

    .error-alert {
        border-radius: 8px;
    }

    .login-button {
        margin-top: 16px;
        height: 50px;
        font-weight: 600;
        text-transform: none;
        font-size: 16px;
        letter-spacing: 0.3px;
        border-radius: 8px;
        background: linear-gradient(135deg, #2BA9E1 0%, #6DBCE8 100%);
        box-shadow: 0 4px 12px rgba(43, 169, 225, 0.3);
        transition: all 0.3s ease;
    }

    .login-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #2598cb 0%, #5dadd8 100%);
        box-shadow: 0 6px 16px rgba(43, 169, 225, 0.4);
        transform: translateY(-1px);
    }

    .login-button:active:not(:disabled) {
        transform: translateY(0);
    }

    .login-button:disabled {
        background: linear-gradient(135deg, #2BA9E1 0%, #6DBCE8 100%);
        opacity: 0.6;
    }

    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 768px) {
        .login-card {
            padding: 40px 32px;
            max-width: 100%;
            border-radius: 12px;
        }

        .logo-wrapper {
            width: 80px;
            height: 80px;
        }

        .login-title {
            font-size: 1.75rem;
        }
    }
</style>

@code {
    private LoginRequest _model = new();
    private bool _isLoading;
    private string? _errorMessage;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private void TogglePasswordVisibility()
    {
        if (_passwordInputType == InputType.Password)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await AuthService.LoginAsync(_model);

            if (result.IsSuccess)
            {
                Snackbar.Add("Login successful! Welcome back.", Severity.Success);

                // Navigate to return URL or dashboard
                var url = string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl;
                Navigation.NavigateTo(url, forceLoad: true);
            }
            else
            {
                _errorMessage = result.Error ?? "Invalid username or password";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception)
        {
            _errorMessage = "An error occurred during login. Please try again.";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}