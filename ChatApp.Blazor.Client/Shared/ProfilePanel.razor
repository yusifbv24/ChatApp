@inject UserState UserState
@inject AppState AppState
@inject IUserService UserService
@inject IFileService FileService
@inject IPositionService PositionService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="profile-panel-overlay @(IsOpen ? "active" : "")" @onclick="Close">
    <div class="pp-side-actions @(IsOpen ? "visible" : "")">
        <button class="pp-side-btn" @onclick="Close" @onclick:stopPropagation="true" title="Close">
            <MudIcon Icon="@Icons.Material.Filled.Close" />
        </button>
        @if (profileUser != null && !isOwnProfile)
        {
            <button class="pp-side-btn chat" @onclick="HandleStartChat" @onclick:stopPropagation="true" title="Chat">
                <MudIcon Icon="@Icons.Material.Filled.Chat" />
            </button>
        }
    </div>
    <div class="profile-panel @(IsOpen ? "open" : "")" @onclick:stopPropagation="true">

        @if (profileUser != null)
        {
            <!-- Header -->
            <div class="pp-header">
                <div class="pp-header-info">
                    <h2 class="pp-header-name">@profileUser.FullName</h2>
                </div>
            </div>

            <!-- Tabs -->
            <div class="pp-tabs">
                <button class="pp-tab @(activeTab == "general" ? "active" : "")" @onclick='() => activeTab = "general"'>
                    General
                </button>
                @if (isOwnProfile)
                {
                    <button class="pp-tab @(activeTab == "security" ? "active" : "")" @onclick='() => activeTab = "security"'>
                        Security
                    </button>
                }
            </div>

            <!-- Content -->
            <div class="pp-content">

                @* ===== GENERAL TAB ===== *@
                @if (activeTab == "general")
                {
                    <div class="pp-general-layout">

                        <!-- Sol Kolon: Avatar Card + About Me -->
                        <div class="pp-left-col">

                            <!-- Avatar Card -->
                            <div class="pp-avatar-card">
                                <div class="pp-avatar-card-badges">
                                    <span class="pp-role-badge @(profileUser.IsAdmin ? "admin" : "user")">
                                        <MudIcon Icon="@(profileUser.IsAdmin ? Icons.Material.Filled.Shield : Icons.Material.Filled.Person)" Style="font-size: 0.75rem;" />
                                        @(profileUser.IsAdmin ? "Administrator" : "User")
                                    </span>
                                    @if (isOwnProfile || AppState.IsUserOnline(profileUser.Id))
                                    {
                                        <span class="pp-online-badge">
                                            <span class="pp-status-dot online"></span>
                                            Online
                                        </span>
                                    }
                                    else
                                    {
                                        <div class="pp-status-group">
                                            <span class="pp-offline-badge">
                                                <span class="pp-status-dot offline"></span>
                                                Offline
                                            </span>
                                            @if (profileUser.LastVisit.HasValue)
                                            {
                                                <span class="pp-last-seen">last seen @FormatLastSeen(profileUser.LastVisit.Value)</span>
                                            }
                                        </div>
                                    }
                                </div>

                                <div class="pp-avatar-wrapper" @onclick="TriggerAvatarUpload">
                                    @if (!string.IsNullOrEmpty(profileUser.AvatarUrl))
                                    {
                                        <img src="@profileUser.AvatarUrl" alt="@profileUser.FullName" class="pp-avatar-img" />
                                    }
                                    else
                                    {
                                        <div class="pp-avatar-empty">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Style="font-size: 7rem; color: rgba(255,255,255,0.7);" />
                                        </div>
                                    }
                                    @if (isOwnProfile)
                                    {
                                        <div class="pp-avatar-overlay">
                                            <div class="pp-avatar-overlay-actions">
                                                <div class="pp-avatar-overlay-btn" @onclick="TriggerAvatarUpload" @onclick:stopPropagation="true">
                                                    <MudIcon Icon="@Icons.Material.Filled.CameraAlt" Style="font-size: 1.25rem;" />
                                                    <span>Upload a photo</span>
                                                </div>
                                                @if (!string.IsNullOrEmpty(profileUser.AvatarUrl))
                                                {
                                                    <div class="pp-avatar-overlay-btn remove" @onclick="HandleAvatarRemove" @onclick:stopPropagation="true">
                                                        <MudIcon Icon="@Icons.Material.Filled.Close" Style="font-size: 1.25rem;" />
                                                        <span>Remove</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>

                                @if (isOwnProfile)
                                {
                                    <InputFile @ref="avatarFileInput" OnChange="HandleAvatarUpload" accept="image/*" style="display: none;" />
                                }

                                @if (!string.IsNullOrEmpty(avatarMessage))
                                {
                                    <div class="pp-field-message @(avatarSuccess ? "success" : "error")">@avatarMessage</div>
                                }

                            </div>

                            <!-- About Me -->
                            @if (isOwnProfile || !string.IsNullOrEmpty(profileUser.AboutMe))
                            {
                            <div class="pp-card">
                                <div class="pp-card-header">
                                    <h3>About me</h3>
                                    @if (isOwnProfile)
                                    {
                                        @if (editingField == "aboutMe")
                                        {
                                            <button class="pp-edit-link" @onclick="CancelEditing">cancel</button>
                                        }
                                        else
                                        {
                                            <button class="pp-edit-link" @onclick='() => StartEditing("aboutMe")'>edit</button>
                                        }
                                    }
                                </div>
                                <div class="pp-card-body">
                                    @if (editingField == "aboutMe")
                                    {
                                        <textarea class="pp-inline-input pp-textarea" @bind="editValues.AboutMe"
                                                  @bind:event="oninput"
                                                  @onkeydown="HandleAboutMeKeyDown"
                                                  maxlength="2000"
                                                  rows="4" placeholder="Tell about yourself..."></textarea>
                                        <div class="pp-about-footer">
                                            <span class="pp-char-counter @((editValues.AboutMe?.Length ?? 0) >= 2000 ? "limit" : "")">
                                                @(editValues.AboutMe?.Length ?? 0) / 2000
                                            </span>
                                            <div class="pp-inline-actions">
                                                <button class="pp-inline-save" @onclick='() => SaveFieldAsync("aboutMe")'
                                                        disabled="@((editValues.AboutMe?.Length ?? 0) > 2000)">SAVE</button>
                                                <button class="pp-inline-cancel" @onclick="CancelEditing">CANCEL</button>
                                            </div>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(profileUser.AboutMe))
                                    {
                                        <p class="pp-about-text">@profileUser.AboutMe</p>
                                    }
                                    else if (isOwnProfile)
                                    {
                                        <div class="pp-about-empty-state">
                                            <div class="pp-about-empty-icon">
                                                <MudIcon Icon="@Icons.Material.Filled.ContactPage" Style="font-size: 2.5rem; color: #90caf9;" />
                                            </div>
                                            <p class="pp-about-empty-text">
                                                Share interesting life stories or tell other users about yourself, upload photos of memorable moments.
                                            </p>
                                            <button class="pp-about-tell-btn" @onclick='() => StartEditing("aboutMe")'>TELL ABOUT YOURSELF</button>
                                        </div>
                                    }
                                </div>
                            </div>
                            }
                        </div>

                        <!-- Sağ Kolon: Contact Info + Additional Info -->
                        <div class="pp-right-col">

                            <!-- Contact Information -->
                            <div class="pp-card">
                                <div class="pp-card-header">
                                    <h3>Contact information</h3>
                                    @if (isOwnProfile)
                                    {
                                        @if (isEditingContact)
                                        {
                                            <button class="pp-edit-link" @onclick="CancelContactEditing">cancel</button>
                                        }
                                        else
                                        {
                                            <button class="pp-edit-link" @onclick="StartContactEditing">edit</button>
                                        }
                                    }
                                </div>
                                <div class="pp-card-body pp-info-list">
                                    @if (isEditingContact)
                                    {
                                        <!-- Edit Mode -->
                                        <div class="pp-info-field">
                                            <label>First name</label>
                                            <input class="pp-inline-input" @bind="editValues.FirstName" placeholder="First name" />
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Last name</label>
                                            <input class="pp-inline-input" @bind="editValues.LastName" placeholder="Last name" />
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Date of birth</label>
                                            <input type="date" class="pp-inline-input" @bind="editValues.DateOfBirth" />
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Position</label>
                                            <select class="pp-inline-input" @bind="selectedPositionIdStr">
                                                <option value="">Select position</option>
                                                @foreach (var pos in departmentPositions)
                                                {
                                                    <option value="@pos.Id.ToString()">@pos.Name</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Email</label>
                                            <input class="pp-inline-input" @bind="editValues.Email" placeholder="Email" />
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Work phone</label>
                                            <div class="pp-input-with-icon">
                                                <input class="pp-inline-input" @bind="editValues.WorkPhone" placeholder="+994XXXXXXXXX" />
                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Style="font-size: 0.875rem; color: #9ca3af;" class="pp-input-icon" />
                                            </div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Hiring date</label>
                                            <input type="date" class="pp-inline-input" @bind="editValues.HiringDate" />
                                        </div>

                                        @if (!string.IsNullOrEmpty(contactMessage))
                                        {
                                            <div class="pp-field-message @(contactSuccess ? "success" : "error")">@contactMessage</div>
                                        }

                                        <div class="pp-inline-actions">
                                            <button class="pp-inline-save" @onclick="SaveContactAsync" disabled="@isSavingContact">
                                                @(isSavingContact ? "Saving..." : "SAVE")
                                            </button>
                                            <button class="pp-inline-cancel" @onclick="CancelContactEditing">CANCEL</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <!-- Read Mode -->
                                        <div class="pp-info-field">
                                            <label>First name</label>
                                            <div class="pp-info-value">@profileUser.FirstName</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Last name</label>
                                            <div class="pp-info-value">@profileUser.LastName</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Date of birth</label>
                                            <div class="pp-info-value">@(profileUser.DateOfBirth?.ToString("MMMM dd, yyyy") ?? "field is empty")</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Position</label>
                                            <div class="pp-info-value">@(profileUser.Position ?? "field is empty")</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Department</label>
                                            <div class="pp-info-value">@(profileUser.DepartmentName ?? "field is empty")</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Email</label>
                                            <div class="pp-info-value email">@profileUser.Email</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Work phone</label>
                                            <div class="pp-info-value">
                                                @(profileUser.WorkPhone ?? "field is empty")
                                                @if (!string.IsNullOrEmpty(profileUser.WorkPhone))
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Phone" Style="font-size: 0.875rem; color: #9ca3af; margin-left: 6px; vertical-align: middle;" />
                                                }
                                            </div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Hiring date</label>
                                            <div class="pp-info-value">@(profileUser.HiringDate?.ToString("MMMM dd, yyyy") ?? "field is empty")</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Member since</label>
                                            <div class="pp-info-value">@profileUser.CreatedAtUtc.ToString("MMMM dd, yyyy")</div>
                                        </div>
                                        <div class="pp-info-field">
                                            <label>Last visit</label>
                                            <div class="pp-info-value">@(profileUser.LastVisit?.ToLocalTime().ToString("MMMM dd, yyyy HH:mm") ?? "Never")</div>
                                        </div>
                                        @if (!profileUser.IsHeadOfDepartment && !string.IsNullOrEmpty(profileUser.SupervisorName))
                                        {
                                            <div class="pp-info-field">
                                                <label>Head of department</label>
                                                <div class="pp-info-value">@profileUser.SupervisorName</div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Additional Information -->
                            @if (profileUser.SupervisorName != null || (profileUser.Subordinates != null && profileUser.Subordinates.Any()))
                            {
                                <div class="pp-card">
                                    <div class="pp-card-header">
                                        <h3>Additional information</h3>
                                    </div>
                                    <div class="pp-card-body">
                                        @if (profileUser.SupervisorName != null && profileUser.SupervisorId.HasValue)
                                        {
                                            <div class="pp-relation-section">
                                                <label class="pp-relation-label">Supervisor</label>
                                                <div class="pp-relation-item pp-clickable" @onclick="() => OpenUserProfile(profileUser.SupervisorId!.Value)">
                                                    <div class="pp-relation-avatar">
                                                        @if (!string.IsNullOrEmpty(profileUser.SupervisorAvatarUrl))
                                                        {
                                                            <img src="@profileUser.SupervisorAvatarUrl" alt="@profileUser.SupervisorName" />
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Person" Style="font-size: 1rem; color: #9ca3af;" />
                                                        }
                                                    </div>
                                                    <div class="pp-relation-info">
                                                        <span class="pp-relation-name">@profileUser.SupervisorName</span>
                                                        @if (!string.IsNullOrEmpty(profileUser.SupervisorPosition))
                                                        {
                                                            <span class="pp-relation-position">@profileUser.SupervisorPosition</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }

                                        @if (profileUser.Subordinates != null && profileUser.Subordinates.Any())
                                        {
                                            <div class="pp-relation-section">
                                                <label class="pp-relation-label">Subordinates</label>
                                                <div class="pp-subordinates-grid">
                                                    @foreach (var sub in profileUser.Subordinates.Take(subordinatesVisible))
                                                    {
                                                        <div class="pp-relation-item pp-clickable" @onclick="() => OpenUserProfile(sub.Id)">
                                                            <div class="pp-relation-avatar">
                                                                @if (!string.IsNullOrEmpty(sub.AvatarUrl))
                                                                {
                                                                    <img src="@sub.AvatarUrl" alt="@sub.FullName" />
                                                                }
                                                                else
                                                                {
                                                                    <MudIcon Icon="@Icons.Material.Filled.Person" Style="font-size: 1rem; color: #9ca3af;" />
                                                                }
                                                            </div>
                                                            <div class="pp-relation-info">
                                                                <span class="pp-relation-name">@sub.FullName</span>
                                                                @if (!string.IsNullOrEmpty(sub.Position))
                                                                {
                                                                    <span class="pp-relation-position">@sub.Position</span>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                                @if (profileUser.Subordinates.Count > subordinatesVisible)
                                                {
                                                    <button class="pp-show-more-link" @onclick="ShowMoreSubordinates">
                                                        Show more (@(profileUser.Subordinates.Count - subordinatesVisible))
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @* ===== SECURITY TAB ===== *@
                @if (activeTab == "security" && isOwnProfile)
                {
                    <div class="pp-security-layout">
                        <div class="pp-card">
                            <div class="pp-card-header">
                                <h3>Change Password</h3>
                                <p class="pp-card-desc">Update your account password</p>
                            </div>
                            <div class="pp-card-body">
                                <EditForm Model="@passwordModel" OnValidSubmit="HandleChangePassword">
                                    <DataAnnotationsValidator />

                                    <div class="pp-form-group">
                                        <label>Current Password</label>
                                        <div class="pp-password-wrapper">
                                            <InputText @bind-Value="passwordModel.CurrentPassword"
                                                       type="@(showCurrentPassword ? "text" : "password")"
                                                       class="pp-inline-input" placeholder="Enter current password" />
                                            <button type="button" class="pp-password-toggle" @onclick="() => showCurrentPassword = !showCurrentPassword">
                                                <MudIcon Icon="@(showCurrentPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" Style="font-size: 1.125rem;" />
                                            </button>
                                        </div>
                                        <ValidationMessage For="@(() => passwordModel.CurrentPassword)" class="pp-validation" />
                                    </div>

                                    <div class="pp-form-group">
                                        <label>New Password</label>
                                        <div class="pp-password-wrapper">
                                            <InputText @bind-Value="passwordModel.NewPassword"
                                                       type="@(showNewPassword ? "text" : "password")"
                                                       class="pp-inline-input" placeholder="Enter new password" />
                                            <button type="button" class="pp-password-toggle" @onclick="() => showNewPassword = !showNewPassword">
                                                <MudIcon Icon="@(showNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" Style="font-size: 1.125rem;" />
                                            </button>
                                        </div>
                                        <ValidationMessage For="@(() => passwordModel.NewPassword)" class="pp-validation" />
                                    </div>

                                    <div class="pp-form-group">
                                        <label>Confirm New Password</label>
                                        <div class="pp-password-wrapper">
                                            <InputText @bind-Value="passwordModel.ConfirmNewPassword"
                                                       type="@(showConfirmPassword ? "text" : "password")"
                                                       class="pp-inline-input" placeholder="Confirm new password" />
                                            <button type="button" class="pp-password-toggle" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                                <MudIcon Icon="@(showConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" Style="font-size: 1.125rem;" />
                                            </button>
                                        </div>
                                        <ValidationMessage For="@(() => passwordModel.ConfirmNewPassword)" class="pp-validation" />
                                    </div>

                                    @if (!string.IsNullOrEmpty(passwordMessage))
                                    {
                                        <div class="pp-field-message @(passwordSuccess ? "success" : "error")">@passwordMessage</div>
                                    }

                                    <button type="submit" class="pp-save-btn" disabled="@isChangingPassword">
                                        @if (isChangingPassword)
                                        {
                                            <span class="pp-spinner"></span>
                                            <span>Changing...</span>
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.VpnKey" Style="font-size: 1rem;" />
                                            <span>Change Password</span>
                                        }
                                    </button>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (isLoading)
        {
            <div class="pp-loading">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" Color="Color.Primary" />
                <p>Loading profile...</p>
            </div>
        }
    </div>
</div>

@if (isNestedPanelOpen)
{
    <ProfilePanel @bind-IsOpen="isNestedPanelOpen" UserId="@nestedProfileUserId" />
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public Guid? UserId { get; set; }

    private UserDetailDto? profileUser;
    private bool isOwnProfile;
    private string activeTab = "general";
    private bool isLoading;
    private bool _previousIsOpen;

    // Avatar
    private InputFile? avatarFileInput;
    private bool isUploadingAvatar;
    private string? avatarMessage;
    private bool avatarSuccess;

    // Inline edit
    private string? editingField;
    private EditFieldValues editValues = new();

    // Subordinates pagination
    private int subordinatesVisible = 4;

    // Nested profile panel
    private bool isNestedPanelOpen;
    private Guid? nestedProfileUserId;

    // Contact edit
    private bool isEditingContact;
    private bool isSavingContact;
    private string? contactMessage;
    private bool contactSuccess;

    // Position dropdown
    private List<PositionDto> departmentPositions = new();
    private string selectedPositionIdStr = "";
    private Guid? selectedPositionId => Guid.TryParse(selectedPositionIdStr, out var id) ? id : null;

    // Password
    private ChangePasswordRequest passwordModel = new();
    private bool isChangingPassword;
    private string? passwordMessage;
    private bool passwordSuccess;
    private bool showCurrentPassword;
    private bool showNewPassword;
    private bool showConfirmPassword;

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && !_previousIsOpen)
        {
            await LoadProfileAsync();
            activeTab = "general";
            ClearMessages();
        }
        _previousIsOpen = IsOpen;
    }

    private async Task LoadProfileAsync()
    {
        isLoading = true;
        profileUser = null;
        editingField = null;
        isEditingContact = false;
        subordinatesVisible = 4;
        StateHasChanged();

        try
        {
            isOwnProfile = UserId == null || UserId == UserState.CurrentUser?.Id;

            if (isOwnProfile)
            {
                var result = await UserService.GetCurrentUserAsync();
                if (result.IsSuccess && result.Value != null)
                {
                    profileUser = result.Value;
                    UserState.CurrentUser = result.Value;
                }
            }
            else
            {
                var result = await UserService.GetUserByIdAsync(UserId!.Value);
                if (result.IsSuccess && result.Value != null)
                    profileUser = result.Value;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ProfilePanel] Error loading profile: {ex.Message}");
        }

        isLoading = false;
    }

    private async Task RefreshProfileAsync()
    {
        try
        {
            var currentUserId = UserState.CurrentUser?.Id;
            var isOwn = UserId == null || UserId == currentUserId;

            if (isOwn)
            {
                var result = await UserService.GetCurrentUserAsync();
                if (result.IsSuccess && result.Value != null)
                {
                    profileUser = result.Value;
                    UserState.CurrentUser = result.Value;
                }
            }
            else
            {
                var result = await UserService.GetUserByIdAsync(UserId!.Value);
                if (result.IsSuccess && result.Value != null)
                    profileUser = result.Value;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ProfilePanel] Error refreshing profile: {ex.Message}");
        }
    }

    private async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
    }

    private async Task HandleStartChat()
    {
        if (profileUser == null) return;

        // Conversation yaratmırıq - yalnız userId-ni AppState-ə yazırıq.
        // Messages səhifəsi açıldıqda mövcud conversation-ı tapacaq,
        // yoxdursa pending mode-da açacaq (ilk mesajda yaradılacaq).
        AppState.PendingChatUserId = profileUser.Id;
        await Close();
        Navigation.NavigateTo("/messages", forceLoad: false);
    }

    // ===== AVATAR =====

    private async Task TriggerAvatarUpload()
    {
        if (!isOwnProfile || isUploadingAvatar) return;
        try
        {
            if (avatarFileInput?.Element != null)
                await JS.InvokeVoidAsync("chatAppUtils.clickFileInput", avatarFileInput.Element);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ProfilePanel] Error triggering file input: {ex.Message}");
        }
    }

    private async Task HandleAvatarUpload(InputFileChangeEventArgs e)
    {
        if (!isOwnProfile) return;

        isUploadingAvatar = true;
        avatarMessage = null;
        StateHasChanged();

        try
        {
            var file = e.File;
            if (file.Size > 10 * 1024 * 1024)
            {
                avatarMessage = "File size must be less than 10MB";
                avatarSuccess = false;
                return;
            }

            var uploadResult = await FileService.UploadProfilePictureAsync(file);
            if (uploadResult.IsSuccess && uploadResult.Value != null)
            {
                var updateReq = new UpdateUserRequest { AvatarUrl = uploadResult.Value.DownloadUrl };
                var updateResult = await UserService.UpdateCurrentUserAsync(updateReq);

                if (updateResult.IsSuccess)
                {
                    await RefreshProfileAsync();
                    avatarMessage = "Photo updated successfully";
                    avatarSuccess = true;
                }
                else
                {
                    avatarMessage = "Failed to update profile photo";
                    avatarSuccess = false;
                }
            }
            else
            {
                avatarMessage = "Failed to upload photo";
                avatarSuccess = false;
            }
        }
        catch (Exception)
        {
            avatarMessage = "Error uploading photo";
            avatarSuccess = false;
        }
        finally
        {
            isUploadingAvatar = false;
            StateHasChanged();
        }
    }

    private async Task HandleAvatarRemove()
    {
        if (!isOwnProfile) return;

        isUploadingAvatar = true;
        StateHasChanged();

        try
        {
            var updateReq = new UpdateUserRequest { AvatarUrl = "" };
            var result = await UserService.UpdateCurrentUserAsync(updateReq);

            if (result.IsSuccess)
            {
                await RefreshProfileAsync();
                avatarMessage = "Photo removed";
                avatarSuccess = true;
            }
            else
            {
                avatarMessage = "Failed to remove photo";
                avatarSuccess = false;
            }
        }
        catch (Exception)
        {
            avatarMessage = "Error removing photo";
            avatarSuccess = false;
        }
        finally
        {
            isUploadingAvatar = false;
            StateHasChanged();
        }
    }

    // ===== CONTACT EDIT =====

    private async Task StartContactEditing()
    {
        editValues = new EditFieldValues
        {
            FirstName = profileUser?.FirstName ?? "",
            LastName = profileUser?.LastName ?? "",
            Email = profileUser?.Email ?? "",
            DateOfBirth = profileUser?.DateOfBirth,
            WorkPhone = profileUser?.WorkPhone ?? "",
            HiringDate = profileUser?.HiringDate
        };
        selectedPositionIdStr = profileUser?.PositionId?.ToString() ?? "";
        departmentPositions = new();

        if (profileUser?.DepartmentId != null)
        {
            try
            {
                var result = await PositionService.GetPositionsByDepartmentAsync(profileUser.DepartmentId.Value);
                if (result.IsSuccess && result.Value != null)
                    departmentPositions = result.Value;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ProfilePanel] Error loading positions: {ex.Message}");
            }
        }

        isEditingContact = true;
        contactMessage = null;
    }

    private void CancelContactEditing()
    {
        isEditingContact = false;
        contactMessage = null;
    }

    private async Task SaveContactAsync()
    {
        isSavingContact = true;
        contactMessage = null;
        StateHasChanged();

        try
        {
            var req = new UpdateUserRequest
            {
                FirstName = editValues.FirstName,
                LastName = editValues.LastName,
                Email = editValues.Email,
                PositionId = selectedPositionId,
                DateOfBirth = editValues.DateOfBirth,
                WorkPhone = string.IsNullOrWhiteSpace(editValues.WorkPhone) ? null : editValues.WorkPhone,
                HiringDate = editValues.HiringDate
            };

            var result = await UserService.UpdateCurrentUserAsync(req);
            if (result.IsSuccess)
            {
                await RefreshProfileAsync();
                isEditingContact = false;
                contactMessage = "Contact information updated";
                contactSuccess = true;
            }
            else
            {
                contactMessage = result.Error ?? "Failed to update";
                contactSuccess = false;
            }
        }
        catch (Exception)
        {
            contactMessage = "Error saving changes";
            contactSuccess = false;
        }
        finally
        {
            isSavingContact = false;
            StateHasChanged();
        }
    }

    // ===== ABOUT ME EDIT =====

    private void StartEditing(string field)
    {
        editValues.AboutMe = profileUser?.AboutMe ?? "";
        editingField = field;
    }

    private void CancelEditing()
    {
        editingField = null;
    }

    private async Task SaveFieldAsync(string field)
    {
        if (editingField != field) return;

        try
        {
            var req = new UpdateUserRequest { AboutMe = editValues.AboutMe };
            var result = await UserService.UpdateCurrentUserAsync(req);
            if (result.IsSuccess)
            {
                await RefreshProfileAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ProfilePanel] Error saving field: {ex.Message}");
        }

        editingField = null;
        StateHasChanged();
    }

    private async Task HandleAboutMeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
            CancelEditing();
    }

    // ===== PASSWORD =====

    private async Task HandleChangePassword()
    {
        isChangingPassword = true;
        passwordMessage = null;
        StateHasChanged();

        try
        {
            if (profileUser == null) return;

            passwordModel.UserId = profileUser.Id;
            var result = await UserService.ChangePasswordAsync(passwordModel);

            if (result.IsSuccess)
            {
                passwordSuccess = true;
                passwordMessage = "Password changed successfully!";
                passwordModel = new();
                showCurrentPassword = false;
                showNewPassword = false;
                showConfirmPassword = false;
            }
            else
            {
                passwordSuccess = false;
                passwordMessage = result.Error ?? "Failed to change password";
            }
        }
        catch (Exception)
        {
            passwordSuccess = false;
            passwordMessage = "Error changing password";
        }
        finally
        {
            isChangingPassword = false;
            StateHasChanged();
        }
    }

    private void ClearMessages()
    {
        avatarMessage = null;
        contactMessage = null;
        passwordMessage = null;
        passwordModel = new();
        showCurrentPassword = false;
        showNewPassword = false;
        showConfirmPassword = false;
    }

    private void ShowMoreSubordinates()
    {
        subordinatesVisible += 4;
    }

    private void OpenUserProfile(Guid userId)
    {
        nestedProfileUserId = userId;
        isNestedPanelOpen = true;
    }

    private string FormatLastSeen(DateTime lastVisit)
    {
        var local = lastVisit.ToLocalTime();
        var now = DateTime.Now;
        var diff = now - local;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes} minutes ago";
        if (diff.TotalHours < 24) return $"today at {local:HH:mm}";
        if (diff.TotalHours < 48) return $"yesterday at {local:HH:mm}";
        return local.ToString("MMMM dd 'at' HH:mm");
    }

    private class EditFieldValues
    {
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        public DateTime? DateOfBirth { get; set; }
        public string WorkPhone { get; set; } = "";
        public DateTime? HiringDate { get; set; }
        public string AboutMe { get; set; } = "";
    }
}