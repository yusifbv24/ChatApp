@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject UserState UserState
@inject AppState AppState
@implements IDisposable

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <div class="app-container">
        <MudPaper Class="@($"sidebar {(_sidebarExpanded ? "expanded" : "")}")" Elevation="0" Square="true">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <MudIconButton Icon="@Icons.Material.Filled.Menu"
                                   Color="Color.Default"
                                   Size="Size.Medium"
                                   Class="menu-toggle"
                                   OnClick="ToggleSidebar" />
                    @if (_sidebarExpanded)
                    {
                        <MudText Typo="Typo.h6" Class="app-logo">ChatApp</MudText>
                    }
                </div>

                <MudStack Class="sidebar-nav" Spacing="0">
                    @if (UserState.IsAdmin)
                    {
                        <MudTooltip Text="Dashboard" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                            <MudButton Href="/"
                                       Variant="Variant.Text"
                                       Color="Color.Default"
                                       Class="@($"nav-item {(IsActive("/") ? "active" : "")}")"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Dashboard">
                                @if (_sidebarExpanded)
                                {
                                    <span class="nav-text">Dashboard</span>
                                }
                            </MudButton>
                        </MudTooltip>
                    }

                    <MudTooltip Text="Direct Messages" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                        <MudButton Href="/messages"
                                   Variant="Variant.Text"
                                   Color="Color.Default"
                                   Class="@($"nav-item {(IsActive("/messages") ? "active" : "")}")"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.ChatBubble">
                            @if (_sidebarExpanded)
                            {
                                <span class="nav-text">Direct Messages</span>
                            }
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Channels" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                        <MudButton Href="/channels"
                                   Variant="Variant.Text"
                                   Color="Color.Default"
                                   Class="@($"nav-item {(IsActive("/channels") ? "active" : "")}")"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Tag">
                            @if (_sidebarExpanded)
                            {
                                <span class="nav-text">Channels</span>
                            }
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Search" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                        <MudButton Href="/search"
                                   Variant="Variant.Text"
                                   Color="Color.Default"
                                   Class="@($"nav-item {(IsActive("/search") ? "active" : "")}")"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Search">
                            @if (_sidebarExpanded)
                            {
                                <span class="nav-text">Search</span>
                            }
                        </MudButton>
                    </MudTooltip>
                </MudStack>

                <div class="sidebar-footer">
                    <MudStack Spacing="0">
                        <MudTooltip Text="Notifications" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                            <MudBadge Content="@AppState.UnreadNotificationCount"
                                      Color="Color.Error"
                                      Overlap="true"
                                      Visible="@(AppState.UnreadNotificationCount > 0)"
                                      Bordered="true"
                                      Class="notification-badge">
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Default"
                                           Class="nav-item footer-item"
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Notifications"
                                           OnClick="@(() => Navigation.NavigateTo("/notifications"))">
                                    @if (_sidebarExpanded)
                                    {
                                        <span class="nav-text">Notifications</span>
                                    }
                                </MudButton>
                            </MudBadge>
                        </MudTooltip>

                        <MudTooltip Text="Settings" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                            <MudButton Href="/settings"
                                       Variant="Variant.Text"
                                       Color="Color.Default"
                                       Class="@($"nav-item footer-item {(IsActive("/settings") ? "active" : "")}")"
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Settings">
                                @if (_sidebarExpanded)
                                {
                                    <span class="nav-text">Settings</span>
                                }
                            </MudButton>
                        </MudTooltip>

                        @if (UserState.IsAdmin)
                        {
                            <MudTooltip Text="Admin Panel" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                                <MudButton Href="/admin/users"
                                           Variant="Variant.Text"
                                           Color="Color.Default"
                                           Class="@($"nav-item footer-item {(IsActive("/admin") ? "active" : "")}")"
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.AdminPanelSettings">
                                    @if (_sidebarExpanded)
                                    {
                                        <span class="nav-text">Admin</span>
                                    }
                                </MudButton>
                            </MudTooltip>
                        }

                        <MudTooltip Text="@(_isDarkMode ? "Light Mode" : "Dark Mode")" Placement="Placement.Right" Delay="300" Disabled="@_sidebarExpanded">
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Default"
                                       Class="nav-item footer-item"
                                       FullWidth="true"
                                       StartIcon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                                       OnClick="ToggleDarkMode">
                                @if (_sidebarExpanded)
                                {
                                    <span class="nav-text">@(_isDarkMode ? "Light Mode" : "Dark Mode")</span>
                                }
                            </MudButton>
                        </MudTooltip>

                        <MudDivider Class="my-2" />

                        <MudMenu AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter" FullWidth="@_sidebarExpanded">
                            <ActivatorContent>
                                <div class="user-profile-card">
                                    @if (!string.IsNullOrEmpty(UserState.AvatarUrl))
                                    {
                                        <MudAvatar Image="@UserState.AvatarUrl" Size="Size.Medium" Class="user-avatar" />
                                    }
                                    else
                                    {
                                        <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="user-avatar">
                                            @GetInitials(UserState.DisplayName)
                                        </MudAvatar>
                                    }
                                    @if (_sidebarExpanded)
                                    {
                                        <MudStack Spacing="0" Class="user-info">
                                            <MudText Typo="Typo.body2" Class="user-name">@UserState.DisplayName</MudText>
                                            <MudText Typo="Typo.caption" Class="user-username">@UserState.Username</MudText>
                                        </MudStack>
                                        <MudIcon Icon="@Icons.Material.Filled.ExpandLess" Size="Size.Small" Class="expand-icon" />
                                    }
                                </div>
                            </ActivatorContent>
                            <ChildContent>
                                <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/profile"))">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                        <MudText>Profile</MudText>
                                    </MudStack>
                                </MudMenuItem>
                                <MudDivider Class="my-1" />
                                <MudMenuItem OnClick="HandleLogout">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Error" />
                                        <MudText Color="Color.Error">Logout</MudText>
                                    </MudStack>
                                </MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </MudStack>
                </div>
            </div>
        </MudPaper>

        <div class="main-content-wrapper">
            <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="main-container">
                @Body
            </MudContainer>
        </div>
    </div>
</MudLayout>

<style>
    .app-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    .sidebar {
        width: 64px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface) !important;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .sidebar.expanded {
        width: 240px;
    }

    .sidebar-content {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 240px;
    }

    .sidebar-header {
        padding: 14px 12px;
        border-bottom: 1px solid var(--mud-palette-divider);
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 64px;
    }

    .menu-toggle {
        flex-shrink: 0;
    }

    .app-logo {
        font-weight: 600;
        font-size: 1.1rem;
        background: linear-gradient(135deg, var(--mud-palette-primary), var(--mud-palette-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        white-space: nowrap;
    }

    .sidebar-nav {
        flex: 1;
        padding: 8px 8px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .sidebar-nav::-webkit-scrollbar {
        width: 4px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
        background: var(--mud-palette-divider);
        border-radius: 2px;
    }

    .nav-item {
        justify-content: flex-start;
        text-transform: none;
        font-weight: 500;
        padding: 10px 12px;
        border-radius: 10px;
        margin-bottom: 2px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 44px;
        position: relative;
    }

    .nav-item:hover {
        background-color: var(--mud-palette-action-default-hover) !important;
    }

    .nav-item.active {
        background-color: var(--mud-palette-primary-lighten) !important;
        color: var(--mud-palette-primary) !important;
    }

    .nav-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 24px;
        background-color: var(--mud-palette-primary);
        border-radius: 0 2px 2px 0;
    }

    .nav-text {
        margin-left: 12px;
        white-space: nowrap;
    }

    .sidebar-footer {
        padding: 8px;
        border-top: 1px solid var(--mud-palette-divider);
    }

    .footer-item {
        margin-bottom: 2px;
    }

    .notification-badge {
        width: 100%;
    }

    .user-profile-card {
        cursor: pointer;
        padding: 10px 8px;
        border-radius: 10px;
        transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 10px;
        min-height: 48px;
    }

    .user-profile-card:hover {
        background-color: var(--mud-palette-action-default-hover);
    }

    .user-avatar {
        flex-shrink: 0;
    }

    .user-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }

    .user-name {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-username {
        color: var(--mud-palette-text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .expand-icon {
        flex-shrink: 0;
    }

    .main-content-wrapper {
        flex: 1;
        overflow-y: auto;
        background: var(--mud-palette-background);
    }

    .main-container {
        padding: 24px;
        max-width: 100% !important;
    }

    @@media (max-width: 768px) {
        .sidebar {
            width: 64px;
        }

        .sidebar.expanded {
            width: 100%;
            max-width: 280px;
            position: absolute;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }
    }
</style>

@code {
    private MudThemeProvider? _mudThemeProvider;
    private bool _isDarkMode;
    private bool _sidebarExpanded = false;

    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2FC7F7",
            PrimaryLighten = "rgba(47, 199, 247, 0.12)",
            Secondary = "#00A1E0",
            Success = "#55D66B",
            Warning = "#FFA900",
            Error = "#FF5752",
            Info = "#2FC7F7",
            Background = "#F4F6F9",
            Surface = "#FFFFFF",
            AppbarBackground = "#FFFFFF",
            DrawerBackground = "#FFFFFF",
            Divider = "rgba(0, 0, 0, 0.08)",
            DividerLight = "rgba(0, 0, 0, 0.05)",
            TextPrimary = "rgba(0, 0, 0, 0.87)",
            TextSecondary = "rgba(0, 0, 0, 0.54)",
            ActionDefault = "rgba(0, 0, 0, 0.54)",
            ActionDisabled = "rgba(0, 0, 0, 0.26)",
            ActionDisabledBackground = "rgba(0, 0, 0, 0.12)",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#2FC7F7",
            PrimaryLighten = "rgba(47, 199, 247, 0.16)",
            Secondary = "#00A1E0",
            Success = "#55D66B",
            Warning = "#FFA900",
            Error = "#FF5752",
            Info = "#2FC7F7",
            Background = "#1A1D24",
            Surface = "#24272E",
            AppbarBackground = "#24272E",
            DrawerBackground = "#24272E",
            Divider = "rgba(255, 255, 255, 0.08)",
            DividerLight = "rgba(255, 255, 255, 0.05)",
            TextPrimary = "rgba(255, 255, 255, 0.92)",
            TextSecondary = "rgba(255, 255, 255, 0.60)",
            ActionDefault = "rgba(255, 255, 255, 0.60)",
            ActionDisabled = "rgba(255, 255, 255, 0.26)",
            ActionDisabledBackground = "rgba(255, 255, 255, 0.12)",
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "10px"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        UserState.OnChange += StateHasChanged;
        AppState.OnChange += StateHasChanged;

        // Load current user if not already loaded
        if (UserState.CurrentUser == null)
        {
            var user = await AuthService.GetCurrentUserAsync();
            UserState.CurrentUser = user;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider != null)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemPreference();
            AppState.IsDarkMode = _isDarkMode;
            StateHasChanged();
        }
    }

    private void ToggleSidebar()
    {
        _sidebarExpanded = !_sidebarExpanded;
    }

    private bool IsActive(string path)
    {
        var currentPath = Navigation.Uri.Replace(Navigation.BaseUri, "/");
        if (currentPath.EndsWith("/"))
            currentPath = currentPath.TrimEnd('/');

        if (path == "/")
            return currentPath == "" || currentPath == "/";

        return currentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase);
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        AppState.IsDarkMode = _isDarkMode;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "U";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return name[0].ToString().ToUpper();
    }

    public void Dispose()
    {
        UserState.OnChange -= StateHasChanged;
        AppState.OnChange -= StateHasChanged;
    }
}
