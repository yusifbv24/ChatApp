@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject UserState UserState
@inject AppState AppState
@implements IDisposable

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar Elevation="1" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit"
                Edge="Edge.Start" OnClick="@ToggleDrawer" />
            <MudText Typo="Typo.h6" Class="ml-3">ChatApp</MudText>
            <MudSpacer/>

            <MudIconButton Icon="@Icons.Material.Filled.Search" Color="Color.Inherit" />
            <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit"
                OnClick="@(()=>Navigation.NavigateTo("/notifications"))">
                @if(AppState.UnreadNotificationCount > 0)
                {
                    <MudBadge Content="@AppState.UnreadNotificationCount" Color="Color.Error" 
                       Overlap="true" Class="mx-6 my-4">
                    </MudBadge>
                }
            </MudIconButton>

            <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" 
                AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <MudMenuItem OnClick="@(()=>Navigation.NavigateTo("/profile"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                            <MudText>Profile</MudText>
                    </MudStack>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/settings"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" />
                            <MudText>Settings</MudText>
                    </MudStack>
                </MudMenuItem>
                @if(UserState.IsAdmin)
                {
                    <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/admin/users"))">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Small" />
                                <MudText>Admin Panel</MudText>
                        </MudStack>
                    </MudMenuItem>
                }
                <MudDivider />
                <MudMenuItem OnClick="HandleLogout">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Error" />
                            <MudText>Logout</MudText>
                    </MudStack>
                </MudMenuItem>
            </MudMenu>

            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode :Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit" OnClick="ToggleDarkMode" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" ClipMode="DrawerClipMode.Always">
        <MudDrawerHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                @if(!string.IsNullOrEmpty(UserState.AvatarUrl))
                {
                    <MudAvatar Size="Size.Medium" Image="@UserState.AvatarUrl" />
                }
                else
                {
                    <MudAvatar Color="Color.Primary" Size="Size.Medium" >
                        @GetInitials(UserState.DisplayName)
                    </MudAvatar>
                }
                <MudStack Spacing="0">
                    <MudText Typo="Typo.subtitle1">@UserState.DisplayName</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@UserState.UserName</MudText>
                </MudStack>
            </MudStack>
        </MudDrawerHeader>
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 mb-4">
            <div class="animate-fade-in">
                @Body
            </div>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code{
    private MudThemeProvider? _mudThemeProvider;
    private bool _isDarkMode;
    private bool _drawerOpen = true;

    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2563EB",
            Secondary = "#64748B",
            Success = "#059669",
            Warning = "#D97706",
            Error = "#DC2626",
            Info = "#0284C7",
            AppbarBackground = "#FFFFFF",
            AppbarText = "#1E293B",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#3B82F6",
            Secondary = "#94A3B8",
            Success = "#10B981",
            Warning = "#F59E0B",
            Error = "#EF4444",
            Info = "#06B6D4",
            Surface = "#1E293B",
        }
    };

    protected override async Task OnInitializedAsync()
    {
        UserState.OnChange += StateHasChanged;
        AppState.OnChange += StateHasChanged;

        // Load current user if not already loaded
        if (UserState.CurrentUser == null)
        {
            var user = await AuthService.GetCurrentUserAsync();
            UserState.CurrentUser = user;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender && _mudThemeProvider != null)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
            AppState.IsDarkMode = _isDarkMode;
            StateHasChanged();
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        AppState.IsDarkMode = _isDarkMode;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        UserState.CurrentUser = null;
        Navigation.NavigateTo("/login", true);
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "U";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return name[0].ToString().ToUpper();
    }

    public void Dispose()
    {
        UserState.OnChange -= StateHasChanged;
        AppState.OnChange -= StateHasChanged;
    }
}