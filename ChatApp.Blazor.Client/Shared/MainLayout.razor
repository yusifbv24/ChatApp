@inherits LayoutComponentBase
@inject UserState UserState
@inject AppState AppState
@inject IAuthService AuthService
@inject IUserService UserService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISignalRService SignalRService
@implements IDisposable

<div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar @(isSidebarOpen ? "sidebar-expanded" : "")">
        <nav class="sidebar-nav">
            <!-- Toggle + Brand -->
            <div class="sidebar-header-row">
                <button class="nav-item sidebar-toggle-btn" @onclick="ToggleSidebar" title="@(isSidebarOpen ? "Collapse" : "Expand")">
                    <MudIcon Icon="@(isSidebarOpen ? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)" />
                </button>
                @if (isSidebarOpen) { <a href="/" class="nav-brand">ChatApp</a> }
            </div>
            <div class="nav-divider"></div>

            <a href="/" class="nav-item @(IsActive("/", true))" title="Feed">
                <MudIcon Icon="@Icons.Material.Filled.DynamicFeed" />
                @if (isSidebarOpen) { <span class="nav-label">Feed</span> }
            </a>
            <a href="/messages" class="nav-item @(IsActive("/messages"))" title="Messages">
                <MudBadge Content="@AppState.UnreadMessageCount" Color="Color.Error" Overlap="true" Visible="@(AppState.UnreadMessageCount > 0)">
                    <MudIcon Icon="@Icons.Material.Filled.Chat" />
                </MudBadge>
                @if (isSidebarOpen) { <span class="nav-label">Messages</span> }
            </a>
            <button class="nav-item" @onclick="OpenProfilePanel" title="Profile">
                <MudIcon Icon="@Icons.Material.Filled.Person" />
                @if (isSidebarOpen) { <span class="nav-label">Profile</span> }
            </button>
            <a href="/settings" class="nav-item @(IsActive("/settings"))" title="Settings">
                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                @if (isSidebarOpen) { <span class="nav-label">Settings</span> }
            </a>

            @if (UserState.IsAdmin)
            {
                <div class="nav-divider"></div>
                <a href="/admin/organization" class="nav-item @(IsActive("/admin/organization"))" title="Organization">
                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" />
                    @if (isSidebarOpen) { <span class="nav-label">Organization</span> }
                </a>
            }
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <!-- Left Side -->
            <div class="header-left"></div>

            <!-- Right Side -->
            <div class="header-right">
                <!-- Notification Button -->
                <div class="notification-wrapper">
                    <button class="header-icon-btn" @onclick="ToggleNotifications">
                        <MudIcon Icon="@Icons.Material.Filled.Notifications" />
                        @if (AppState.UnreadNotificationCount > 0)
                        {
                            <span class="notification-badge">@(AppState.UnreadNotificationCount > 99 ? "99+" : AppState.UnreadNotificationCount.ToString())</span>
                        }
                    </button>

                    @if (isNotificationPanelOpen)
                    {
                        <div class="notification-panel" @onclick:stopPropagation="true">
                            <div class="notification-panel-header">
                                <span class="notification-panel-title">Notifications</span>
                                <button class="notification-panel-action" @onclick="ToggleNotifications">
                                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                                </button>
                            </div>
                            <div class="notification-panel-body">
                                <div class="notification-empty">
                                    <MudIcon Icon="@Icons.Material.Outlined.NotificationsNone" Style="font-size: 48px; color: rgba(0,0,0,0.15);" />
                                    <span>No new notifications</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="header-clock">
                    @currentTime.ToString("HH:mm")
                </div>

                <!-- User Menu -->
                <div class="user-menu-wrapper">
                    <button class="user-menu-trigger" @onclick="ToggleUserMenu">
                        @if (UserState.CurrentUser != null)
                        {
                            @if (!string.IsNullOrEmpty(UserState.CurrentUser.AvatarUrl))
                            {
                                <img src="@UserState.CurrentUser.AvatarUrl" alt="@UserState.CurrentUser.FullName" class="user-menu-avatar" />
                            }
                            else
                            {
                                <div class="user-menu-avatar-placeholder" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(UserState.CurrentUser.Id);">
                                    @StringHelper.GetInitials(UserState.CurrentUser.FullName)
                                </div>
                            }
                        }
                        <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                    </button>

                    @if (isUserMenuOpen)
                    {
                        <div class="user-menu-dropdown" @onclick:stopPropagation="true">
                            <div class="user-menu-header">
                                <div class="user-menu-avatar-lg">
                                    @if (UserState.CurrentUser != null)
                                    {
                                        @if (!string.IsNullOrEmpty(UserState.CurrentUser.AvatarUrl))
                                        {
                                            <img src="@UserState.CurrentUser.AvatarUrl" alt="@UserState.CurrentUser.FullName" />
                                        }
                                        else
                                        {
                                            <div class="avatar-placeholder-lg" style="background-color: @AvatarHelper.GetAvatarBackgroundColor(UserState.CurrentUser.Id);">
                                                @StringHelper.GetInitials(UserState.CurrentUser.FullName)
                                            </div>
                                        }
                                    }
                                    <span class="user-status-dot"></span>
                                </div>
                                <div class="user-menu-info">
                                    <div class="user-menu-name">@UserState.CurrentUser?.FullName</div>
                                    <div class="user-menu-email">@UserState.CurrentUser?.Email</div>
                                </div>
                            </div>
                            <div class="user-menu-body">
                                <button class="user-menu-item" @onclick="OpenProfilePanelFromMenu">
                                    <div class="user-menu-item-icon">
                                        <MudIcon Icon="@Icons.Material.Outlined.Person" Size="Size.Small" />
                                    </div>
                                    <span>Profile</span>
                                    <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Class="user-menu-item-arrow" />
                                </button>
                                <a href="/settings" class="user-menu-item" @onclick="CloseUserMenu">
                                    <div class="user-menu-item-icon">
                                        <MudIcon Icon="@Icons.Material.Outlined.Settings" Size="Size.Small" />
                                    </div>
                                    <span>Settings</span>
                                    <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Class="user-menu-item-arrow" />
                                </a>
                            </div>
                            <div class="user-menu-footer">
                                <button class="user-menu-item user-menu-logout" @onclick="HandleLogout">
                                    <div class="user-menu-item-icon logout-icon">
                                        <MudIcon Icon="@Icons.Material.Outlined.Logout" Size="Size.Small" />
                                    </div>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </header>

        <!-- Network Status -->
        <NetworkStatusBanner />

        <!-- Page Content -->
        <main class="page-content">
            @Body
        </main>
    </div>

    <!-- Profile Panel -->
    <ProfilePanel @bind-IsOpen="isProfilePanelOpen" UserId="@profileUserId" />
</div>

@code {
    private bool isSidebarOpen = false;
    private bool isUserMenuOpen = false;
    private bool isNotificationPanelOpen = false;
    private bool isProfilePanelOpen = false;
    private Guid? profileUserId;
    private DateTime currentTime = DateTime.Now;
    private System.Threading.Timer? timer;
    private bool signalRInitialized = false;
    private DotNetObjectReference<MainLayout>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        if (UserState.CurrentUser != null && !signalRInitialized)
        {
            try
            {
                Console.WriteLine("[MainLayout] Initializing SignalR connection...");
                await SignalRService.InitializeAsync();
                signalRInitialized = true;
                Console.WriteLine("[MainLayout] SignalR connection initialized successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[MainLayout] SignalR initialization error: {ex.Message}");
                _ = Task.Run(async () =>
                {
                    await Task.Delay(5000);
                    try
                    {
                        await SignalRService.InitializeAsync();
                        signalRInitialized = true;
                        Console.WriteLine("[MainLayout] SignalR retry successful");
                    }
                    catch (Exception retryEx)
                    {
                        Console.WriteLine($"[MainLayout] SignalR retry failed: {retryEx.Message}");
                    }
                });
            }
        }

        UserState.OnChange += HandleUserStateChanged;
        AppState.OnChange += StateHasChanged;

        timer = new System.Threading.Timer(async _ =>
        {
            currentTime = DateTime.Now;
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("chatAppUtils.subscribeToOutsideClick", _dotNetRef);
        }
    }

    /// <summary>
    /// UserState dəyişdikdə çağrılır.
    /// Browser refresh zamanı App.razor ilə MainLayout arasında race condition olur:
    /// MainLayout.OnInitializedAsync çağrılanda UserState.CurrentUser hələ null olur.
    /// Bu handler App.razor UserState-i doldurduqdan sonra SignalR-ı initialize edir.
    /// </summary>
    private async void HandleUserStateChanged()
    {
        if (UserState.CurrentUser != null && !signalRInitialized)
        {
            try
            {
                await SignalRService.InitializeAsync();
                signalRInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[MainLayout] SignalR init error: {ex.Message}");
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void CloseUserMenuFromJS()
    {
        if (isUserMenuOpen || isNotificationPanelOpen)
        {
            isUserMenuOpen = false;
            isNotificationPanelOpen = false;
            StateHasChanged();
        }
    }

    private void ToggleSidebar()
    {
        isSidebarOpen = !isSidebarOpen;
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
        if (isUserMenuOpen)
            isNotificationPanelOpen = false;
    }

    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
    }

    private void ToggleNotifications()
    {
        isNotificationPanelOpen = !isNotificationPanelOpen;
        if (isNotificationPanelOpen)
            isUserMenuOpen = false;
    }

    private void OpenProfilePanel()
    {
        profileUserId = null;
        isProfilePanelOpen = true;
    }

    private void OpenProfilePanelFromMenu()
    {
        CloseUserMenu();
        profileUserId = null;
        isProfilePanelOpen = true;
    }

    private async Task HandleLogout()
    {
        CloseUserMenu();

        if (signalRInitialized)
        {
            try
            {
                await SignalRService.DisconnectAsync();
                signalRInitialized = false;
            }
            catch { }
        }

        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private string IsActive(string path, bool exact = false)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        if (exact)
            return currentPath == path ? "active" : "";
        return currentPath == path || currentPath.StartsWith(path + "/") ? "active" : "";
    }

    public void Dispose()
    {
        timer?.Dispose();
        _dotNetRef?.Dispose();
        UserState.OnChange -= HandleUserStateChanged;
        AppState.OnChange -= StateHasChanged;

        if (signalRInitialized)
        {
            try
            {
                _ = SignalRService.DisconnectAsync();
            }
            catch { }
        }
    }
}
