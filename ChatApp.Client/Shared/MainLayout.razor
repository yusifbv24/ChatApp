@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@inject AppState AppState
@inject ISignalRService SignalR
@inject PresenceState PresenceState
@inject ConnectionState ConnectionState
@implements IAsyncDisposable

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<!--
    MUDBLAZOR LAYOUT COMPONENT
    =========================
    MudLayout provides responsive drawer (sidebar) and app bar (top bar) structure.
    This is MudBlazor's pre-built responsive layout that handles mobile/desktop automatically.
-->
<MudLayout>
    <!--
        APP BAR (Top Navigation)
        =======================
        MudAppBar is the top bar that stays fixed while scrolling.
    -->
    <MudAppBar Elevation="1">
        <!--
            DRAWER TOGGLE BUTTON
            ===================
            On mobile, the drawer is hidden by default. This button toggles it.
            @onclick="@(() => DrawerToggle())" is Razor syntax for inline event handler.
        -->
        <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                       Color="Color.Inherit" 
                       Edge="Edge.Start" 
                       OnClick="@DrawerToggle" />
        
        <MudText Typo="Typo.h6">ChatApp</MudText>
        
        <!--
            MUDBLAZOR SPACER
            ===============
            MudSpacer pushes everything after it to the right side.
            This is how we create left-aligned and right-aligned sections in the app bar.
        -->
        <MudSpacer />
        <!-- Connection Status Indicator -->
        @if (AppState.CurrentUser != null)
        {
            <MudTooltip Text="@ConnectionState.Status">
                @if (ConnectionState.IsReconnecting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Warning" Class="mr-4" />
                }
                else if (ConnectionState.IsConnected)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" Class="mr-4" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Error" Size="Size.Small" Class="mr-4" />
                }
            </MudTooltip>
        }

        @if (AppState.CurrentUser != null)
        {
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrWhiteSpace(AppState.CurrentUser.AvatarUrl))
                        {
                            <MudAvatar Image="@AppState.CurrentUser.AvatarUrl" Size="Size.Small" />
                        }
                        else
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                @AppState.CurrentUser.Initials
                            </MudAvatar>
                        }
                        <MudText Typo="Typo.body2">@AppState.CurrentUser.DisplayName</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" />
                    </MudStack>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile">My Profile</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout">Logout</MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
    </MudAppBar>

    <!--
        DRAWER (Sidebar Navigation)
        ==========================
        MudDrawer is the sidebar that can be toggled on mobile.
        @bind-Open two-way binds drawer visibility to _drawerOpen variable.
        ClipMode.Always means drawer goes under the app bar (not over it).
    -->
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <!--
            NAVIGATION MENU
            ==============
            We'll create a separate NavMenu component for cleaner code.
            For now, inline navigation links.
        -->
        <MudNavMenu>
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            
            <!--
                AUTHORIZATION IN COMPONENTS
                ==========================
                <AuthorizeView> is Blazor's way to conditionally render based on permissions.
                Only renders content inside if user is authenticated.
            -->
            <AuthorizeView>
                <Authorized>
                    @if (HasPermission(context.User, Permissions.Users.Read))
                    {
                        <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">Users</MudNavLink>
                    }
                    @if (HasPermission(context.User, Permissions.Roles.Read))
                    {
                        <MudNavLink Href="/roles" Icon="@Icons.Material.Filled.Security">Roles</MudNavLink>
                    }
                </Authorized>
            </AuthorizeView>
        </MudNavMenu>
    </MudDrawer>

    <!--
        MAIN CONTENT AREA
        ================
        MudMainContent is where page content renders.
        @Body is replaced with the actual page (Dashboard, Users, etc.)
    -->
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
            <!--
                @Body DIRECTIVE
                ==============
                This is THE key to Blazor layouts!
                Whatever page you navigate to appears here.
                
                Navigate to /users → @Body becomes <Users /> component
                Navigate to / → @Body becomes <Index /> component
            -->
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true; // Drawer starts open on desktop

    protected override async Task OnInitializedAsync()
    {
        // Start SignalR connection when app loads
        if (AppState.CurrentUser != null)
        {
            try
            {
                await SignalR.StartAsync();

                // Subscribe to presence events
                SignalR.OnUserOnline += HandleUserOnline;
                SignalR.OnUserOffline += HandleUserOffline;
                SignalR.OnUserStatusChanged += HandleUserStatusChanged;

                // Subscribe to connection events
                SignalR.OnConnected += HandleConnected;
                SignalR.OnDisconnected += HandleDisconnected;
                SignalR.OnReconnecting += HandleReconnecting;
                SignalR.OnReconnected += HandleReconnected;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to start SignalR: {ex.Message}");
            }
        }
    }

    private void HandleUserOnline(Guid userId)
    {
        PresenceState.SetUserOnline(userId);
        InvokeAsync(StateHasChanged);
    }

    private void HandleUserOffline(Guid userId)
    {
        PresenceState.SetUserOffline(userId);
        InvokeAsync(StateHasChanged);
    }

    private void HandleUserStatusChanged(Guid userId, string status)
    {
        PresenceState.UpdateUserStatus(userId, status);
        InvokeAsync(StateHasChanged);
    }

    private void HandleConnected()
    {
        ConnectionState.IsConnected = true;
        ConnectionState.Status = "Connected";
        InvokeAsync(StateHasChanged);
    }

    private void HandleDisconnected()
    {
        ConnectionState.IsConnected = false;
        ConnectionState.Status = "Disconnected";
        InvokeAsync(StateHasChanged);
    }

    private void HandleReconnecting()
    {
        ConnectionState.IsReconnecting = true;
        ConnectionState.Status = "Reconnecting...";
        InvokeAsync(StateHasChanged);
    }

    private void HandleReconnected()
    {
        ConnectionState.IsConnected = true;
        ConnectionState.IsReconnecting = false;
        ConnectionState.Status = "Connected";
        InvokeAsync(StateHasChanged);
    }


    /// <summary>
    /// Toggles the drawer open/closed
    /// Blazor automatically re-renders when _drawerOpen changes
    /// </summary>
    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    /// <summary>
    /// Helper method to check if user has a specific permission
    /// </summary>
    private bool HasPermission(System.Security.Claims.ClaimsPrincipal user, string permission)
    {
        return user.HasClaim("permissions", permission);
    }

    /// <summary>
    /// Logs out the user and redirects to login
    /// </summary>
    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public async ValueTask DisposeAsync()
    {
        // Cleanup SignalR events and connection
        if (SignalR != null)
        {
            SignalR.OnUserOnline -= HandleUserOnline;
            SignalR.OnUserOffline -= HandleUserOffline;
            SignalR.OnUserStatusChanged -= HandleUserStatusChanged;
            SignalR.OnConnected -= HandleConnected;
            SignalR.OnDisconnected -= HandleDisconnected;
            SignalR.OnReconnecting -= HandleReconnecting;
            SignalR.OnReconnected -= HandleReconnected;

            await SignalR.StopAsync();
            await SignalR.DisposeAsync();
        }
    }
}