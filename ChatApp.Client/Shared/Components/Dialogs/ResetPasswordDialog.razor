@inject IUserService UserService
@inject INotificationService Notification

<!--
    MUDBLAZOR DIALOG COMPONENT
    ==========================
    MudDialog is a built-in MudBlazor component for modal dialogs.
    It provides TitleContent, DialogContent, and DialogActions sections.

    This dialog is shown when admin clicks "Reset Password" button in Edit User page.
    It calls YOUR NEW ENDPOINT: POST /api/users/change-password/{userId}
-->

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Class="mr-2" />
            Reset Password
        </MudText>
    </TitleContent>

    <DialogContent>
        <!-- Warning Alert -->
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <MudText Typo="Typo.body2">
                <strong>Warning:</strong> You are about to reset the password for <strong>@UserDisplayName</strong>.
            </MudText>
            <MudText Typo="Typo.caption" Class="mt-2">
                • This action will be logged for security audit<br />
                • The user will be able to log in with the new password immediately<br />
                • Consider notifying the user of the password change
            </MudText>
        </MudAlert>

        <MudForm @ref="_form" @bind-IsValid="_isFormValid">
            <!-- New Password -->
            <MudTextField @bind-Value="_newPassword"
                          Label="New Password"
                          InputType="@_passwordInput"
                          Required="true"
                          RequiredError="Password is required"
                          Validation="@(new Func<string, string?>(ValidatePassword))"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Adornment="Adornment.End"
                          AdornmentIcon="@_passwordIcon"
                          OnAdornmentClick="TogglePasswordVisibility"
                          HelperText="Min 8 chars, uppercase, lowercase, number, special char"
                          Class="mb-3" />

            <!-- Confirm Password -->
            <MudTextField @bind-Value="_confirmPassword"
                          Label="Confirm New Password"
                          InputType="@_passwordInput"
                          Required="true"
                          RequiredError="Please confirm password"
                          Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          HelperText="Must match the new password" />
        </MudForm>

        <!-- Error Message -->
        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@_errorMessage</MudAlert>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="_isResetting">Cancel</MudButton>
        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   OnClick="ResetPassword"
                   Disabled="@(!_isFormValid || _isResetting)">
            @if (_isResetting)
            {
                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                <MudText>Resetting...</MudText>
            }
            else
            {
                <MudText>Reset Password</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    /// <summary>
    /// MUDBLAZOR DIALOG PARAMETERS
    /// ==========================
    /// [CascadingParameter] MudDialogInstance is automatically provided by MudBlazor
    /// when this component is shown via DialogService.ShowAsync<>()
    ///
    /// It provides:
    /// - Close() method to close the dialog
    /// - Cancel() method to cancel the dialog
    /// - Options for dialog behavior
    /// </summary>
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    /// <summary>
    /// Parameters passed from parent component (EditUser page)
    /// </summary>
    [Parameter]
    public Guid UserId { get; set; }

    [Parameter]
    public string UserDisplayName { get; set; } = string.Empty;

    // Form references
    private MudForm _form = null!;
    private bool _isFormValid;

    // Password fields
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;

    // UI State
    private bool _isResetting = false;
    private string _errorMessage = string.Empty;

    // Password visibility toggle
    private bool _passwordVisible = false;
    private InputType _passwordInput = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    /// <summary>
    /// Toggle password visibility
    /// </summary>
    private void TogglePasswordVisibility()
    {
        if (_passwordVisible)
        {
            _passwordVisible = false;
            _passwordInput = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordVisible = true;
            _passwordInput = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
    }

    /// <summary>
    /// Validate password strength
    /// Must match backend requirements: min 8 chars, uppercase, lowercase, number, special char
    /// </summary>
    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";

        if (password.Length < 8)
            return "Password must be at least 8 characters";

        if (!password.Any(char.IsUpper))
            return "Password must contain at least one uppercase letter";

        if (!password.Any(char.IsLower))
            return "Password must contain at least one lowercase letter";

        if (!password.Any(char.IsDigit))
            return "Password must contain at least one number";

        if (!password.Any(ch => !char.IsLetterOrDigit(ch)))
            return "Password must contain at least one special character";

        return null;
    }

    /// <summary>
    /// Validate confirm password matches
    /// </summary>
    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "Please confirm password";

        if (confirmPassword != _newPassword)
            return "Passwords do not match";

        return null;
    }

    /// <summary>
    /// Reset user's password using admin endpoint
    /// THIS CALLS YOUR NEW ENDPOINT: POST /api/users/change-password/{userId}
    /// </summary>
    private async Task ResetPassword()
    {
        _errorMessage = string.Empty;

        // Validate form
        await _form.Validate();

        if (!_isFormValid)
            return;

        _isResetting = true;

        try
        {
            // Create AdminChangePasswordRequest (YOUR NEW MODEL)
            var request = new AdminChangePasswordRequest
            {
                NewPassword = _newPassword,
                ConfirmNewPassword = _confirmPassword
            };

            // Call AdminChangePasswordAsync which calls YOUR NEW ENDPOINT
            // POST /api/users/change-password/{userId}
            var result = await UserService.AdminChangePasswordAsync(UserId, request);

            if (result.IsSuccess)
            {
                // Success! Close dialog and return success
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                // Show error from backend
                _errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            _isResetting = false;
        }
    }

    /// <summary>
    /// Cancel dialog
    /// </summary>
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}