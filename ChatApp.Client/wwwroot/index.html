@page "/"
@attribute [Authorize]
@inject IUserService UserService
@inject IRoleService RoleService
@inject AppState AppState

<PageTitle>Dashboard - ChatApp</PageTitle>

<div class="fade-in">
    <!-- Hero Section with Gradient -->
    <MudPaper Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px;">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.h3" Style="font-weight: 700; margin-bottom: 8px;">
                    Welcome back, @AppState.CurrentUser?.DisplayName! 👋
                </MudText>
                <MudText Typo="Typo.body1" Style="opacity: 0.9;">
                    Here's what's happening with your team today
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                <div class="avatar-gradient">
                    @if (!string.IsNullOrWhiteSpace(AppState.CurrentUser?.AvatarUrl))
                    {
                        <MudAvatar Image="@AppState.CurrentUser.AvatarUrl" Size="Size.Large" Style="width: 80px; height: 80px;" />
                    }
                    else
                    {
                        <MudAvatar Color="Color.Surface" Size="Size.Large" Style="width: 80px; height: 80px;">
                            <MudText Typo="Typo.h4">@AppState.CurrentUser?.Initials</MudText>
                        </MudAvatar>
                    }
                </div>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Stats Cards Row -->
    <MudGrid Class="mb-4">
        <!-- Total Users Card -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" />
                    <div class="animated-badge">
                        <MudChip Color="Color.Surface" Size="Size.Small">+12%</MudChip>
                    </div>
                </div>
                <div class="metric-value">@_totalUsers</div>
                <div class="metric-label">Total Users</div>
            </div>
        </MudItem>

        <!-- Active Users Card -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card success">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Check Circle" Size="Size.Large" />
                    <MudChip Color="Color.Surface" Size="Size.Small">Active</MudChip>
                </div>
                <div class="metric-value">@_activeUsers</div>
                <div class="metric-label">Active Users</div>
            </div>
        </MudItem>

        <!-- Total Roles Card -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card info">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Large" />
                    <MudChip Color="Color.Surface" Size="Size.Small">Roles</MudChip>
                </div>
                <div class="metric-value">@_totalRoles</div>
                <div class="metric-label">Access Roles</div>
            </div>
        </MudItem>

        <!-- Admin Users Card -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card warning">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Large" />
                    <MudChip Color="Color.Surface" Size="Size.Small">Admins</MudChip>
                </div>
                <div class="metric-value">@_adminUsers</div>
                <div class="metric-label">Administrators</div>
            </div>
        </MudItem>
    </MudGrid>

    <!-- Recent Activity & Quick Actions -->
    <MudGrid>
        <!-- Recent Users -->
        <MudItem xs="12" md="8">
            <div class="gradient-card">
                <div class="gradient-header">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.Group" Class="mr-2" />
                        Recent Users
                    </MudText>
                </div>
                <MudList>
                    @if (_recentUsers.Any())
                    {
                        @foreach (var user in _recentUsers.Take(5))
                        {
                            <MudListItem Class="user-card">
                                <div class="d-flex align-center">
                                    @if (!string.IsNullOrWhiteSpace(user.AvatarUrl))
                                    {
                                        <MudAvatar Image="@user.AvatarUrl" Class="mr-3" />
                                    }
                                    else
                                    {
                                        <MudAvatar Color="Color.Primary" Class="mr-3">@user.Initials</MudAvatar>
                                    }
                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">@user.DisplayName</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@user.Email</MudText>
                                    </div>
                                    <div>
                                        @if (user.IsAdmin)
                                        {
                                            <span class="role-badge admin">Admin</span>
                                        }
                                        else
                                        {
                                            <span class="role-badge">User</span>
                                        }
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    }
                    else
                    {
                        <MudListItem>
                            <MudText Color="Color.Secondary">No users yet</MudText>
                        </MudListItem>
                    }
                </MudList>
                <MudCardActions>
                    <MudButton Href="/users" Variant="Variant.Text" Color="Color.Primary" EndIcon="@Icons.Material.Filled.ArrowForward">
                        View All Users
                    </MudButton>
                </MudCardActions>
            </div>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12" md="4">
            <div class="gradient-card">
                <div class="gradient-header">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.Bolt" Class="mr-2" />
                        Quick Actions
                    </MudText>
                </div>
                <MudStack Class="pa-4" Spacing="3">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              FullWidth="true" 
                              StartIcon="@Icons.Material.Filled.PersonAdd"
                              Href="/users/create"
                              Class="btn-gradient"
                              Style="height: 56px; border-radius: 12px;">
                        Create New User
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              FullWidth="true" 
                              StartIcon="@Icons.Material.Filled.Security"
                              Href="/roles"
                              Style="height: 56px; border-radius: 12px;">
                        Manage Roles
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              FullWidth="true" 
                              StartIcon="@Icons.Material.Filled.Person"
                              Href="/profile"
                              Style="height: 56px; border-radius: 12px;">
                        My Profile
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              FullWidth="true" 
                              StartIcon="@Icons.Material.Filled.Settings"
                              Href="/settings"
                              Style="height: 56px; border-radius: 12px;">
                        Settings
                    </MudButton>
                </MudStack>
            </div>
        </MudItem>
    </MudGrid>
</div>

@code {
    private int _totalUsers = 0;
    private int _activeUsers = 0;
    private int _totalRoles = 0;
    private int _adminUsers = 0;
    private List<UserDto> _recentUsers = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        // Load users
        var usersResult = await UserService.GetUsersAsync(1, 100);
        if (usersResult.IsSuccess && usersResult.Value != null)
        {
            _recentUsers = usersResult.Value;
            _totalUsers = _recentUsers.Count;
            _activeUsers = _recentUsers.Count(u => u.IsActive);
            _adminUsers = _recentUsers.Count(u => u.IsAdmin);
        }

        // Load roles
        var rolesResult = await RoleService.GetAllRolesAsync();
        if (rolesResult.IsSuccess && rolesResult.Value != null)
        {
            _totalRoles = rolesResult.Value.Count;
        }
    }
}
