@page "/roles"
@attribute [Authorize]
@inject IRoleService RoleService
@inject IPermissionService PermissionService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Roles - ChatApp</PageTitle>

<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">🔐 Access Roles</h1>
            <p class="page-subtitle">Define permissions and access levels</p>
        </div>
        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   Class="btn-gradient"
                   OnClick="OpenCreateDialog">
            Create Role
        </MudButton>
    </div>

    @if (_isLoading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else
    {
        <div class="roles-grid">
            @foreach (var role in _roles)
            {
                <div class="role-card">
                    <div class="role-header" style="background: @GetRoleGradient(role.Name)">
                        <div>
                            <h3 class="role-name">@role.Name</h3>
                            <p class="role-description">@role.Description</p>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                       Color="Color.Surface"
                                       OnClick="@(() => OpenRoleMenu(role))" />
                    </div>

                    <div class="role-body">
                        <div class="role-stats">
                            <div class="stat-item">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" />
                                <span>@role.PermissionCount permissions</span>
                            </div>
                            <div class="stat-item">
                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" />
                                <span>@role.UserCount users</span>
                            </div>
                        </div>

                        <MudDivider Class="my-3" />

                        <div class="permissions-preview">
                            <p class="section-label">Permissions:</p>
                            @if (_rolePermissions.ContainsKey(role.Id) && _rolePermissions[role.Id].Any())
                            {
                                <div class="permission-chips">
                                    @foreach (var perm in _rolePermissions[role.Id].Take(4))
                                    {
                                        <div class="permission-chip">
                                            <MudIcon Icon="@GetPermissionIcon(perm.Name)" Size="Size.Small" />
                                            @perm.Name.Split('.').Last()
                                        </div>
                                    }
                                    @if (_rolePermissions[role.Id].Count > 4)
                                    {
                                        <div class="permission-chip more">
                                            +@(_rolePermissions[role.Id].Count - 4) more
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="no-permissions">No permissions assigned</p>
                            }
                        </div>
                    </div>

                    <div class="role-footer">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Settings"
                                   OnClick="@(() => EditRole(role.Id))">
                            Manage
                        </MudButton>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .roles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .role-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

    .role-header {
        padding: 24px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .role-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 4px 0;
    }

    .role-description {
        margin: 0;
        opacity: 0.95;
    }

    .role-body {
        padding: 20px;
    }

    .role-stats {
        display: flex;
        gap: 16px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6c757d;
        font-size: 0.875rem;
    }

    .section-label {
        font-weight: 600;
        color: #1a202c;
        margin: 0 0 12px 0;
    }

    .permissions-preview {
        min-height: 100px;
    }

    .permission-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .permission-chip {
        background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        color: #5b21b6;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .permission-chip.more {
            background: #e5e7eb;
            color: #6c757d;
        }

    .no-permissions {
        color: #9ca3af;
        font-style: italic;
        margin: 0;
    }

    .role-footer {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
    }
</style>

@code {
    private List<RoleDto> _roles = new();
    private Dictionary<Guid, List<PermissionDto>> _rolePermissions = new();
    private List<PermissionDto> _allPermissions = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        _isLoading = true;

        // Load all permissions first
        var permsResult = await PermissionService.GetPermissionsAsync();
        if (permsResult.IsSuccess && permsResult.Value != null)
        {
            _allPermissions = permsResult.Value;
        }

        // Load roles
        var result = await RoleService.GetRolesAsync();
        if (result.IsSuccess && result.Value != null)
        {
            _roles = result.Value;

            // Map permission IDs to PermissionDto for each role
            foreach (var role in _roles)
            {
                if (role.PermissionIds != null)
                {
                    _rolePermissions[role.Id] = _allPermissions
                        .Where(p => role.PermissionIds.Contains(p.Id))
                        .ToList();
                }
            }
        }

        _isLoading = false;
    }

    private string GetRoleGradient(string roleName)
    {
        var lower = roleName.ToLower();
        if (lower == "admin" || lower == "administrator") return "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)";
        if (lower == "moderator") return "linear-gradient(135deg, #fa709a 0%, #fee140 100%)";
        if (lower == "user") return "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
        return "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
    }

    private string GetPermissionIcon(string permissionName)
    {
        var lower = permissionName.ToLower();
        if (lower.Contains("create")) return Icons.Material.Filled.Add;
        if (lower.Contains("read")) return Icons.Material.Filled.Visibility;
        if (lower.Contains("update") || lower.Contains("edit")) return Icons.Material.Filled.Edit;
        if (lower.Contains("delete")) return Icons.Material.Filled.Delete;
        return Icons.Material.Filled.CheckCircle;
    }

    private void EditRole(Guid roleId) => Navigation.NavigateTo($"/roles/{roleId}/edit");
    private void OpenCreateDialog() => Navigation.NavigateTo("/roles/create");
    private void OpenRoleMenu(RoleDto role) { }
}