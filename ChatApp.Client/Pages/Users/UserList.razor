@page "/users"
@attribute [Authorize]
@inject IUserService UserService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Users - ChatApp</PageTitle>

<div class="page-container">
    <!-- Header with gradient -->
    <div class="page-header">
        <div>
            <h1 class="page-title">👥 Team Members</h1>
            <p class="page-subtitle">Manage your team and access control</p>
        </div>
        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   Class="btn-gradient"
                   OnClick="@(() => Navigation.NavigateTo("/users/create"))">
            Add Member
        </MudButton>
    </div>

    <!-- Search and filters -->
    <MudPaper Class="search-bar" Elevation="0">
        <MudTextField @bind-Value="_searchQuery"
                      Placeholder="Search by name, email..."
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      OnInput="OnSearchInput"
                      Class="search-input" />

        <!-- Replace chips section -->
        <MudChipSet T="string" @bind-SelectedChip="_filterChip" Filter="true" Mandatory="false">
            <MudChip T="string" Text="All" Color="Color.Default" Value="@("all")">All (@_allUsers.Count)</MudChip>
            <MudChip T="string" Text="Active" Color="Color.Success" Value="@("active")">Active (@_activeCount)</MudChip>
            <MudChip T="string" Text="Admins" Color="Color.Error" Value="@("admin")">Admins (@_adminCount)</MudChip>
            <MudChip T="string" Text="Inactive" Color="Color.Default" Value="@("inactive")">Inactive (@_inactiveCount)</MudChip>
        </MudChipSet>
    </MudPaper>

    <!-- User cards grid -->
    @if (_isLoading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else
    {
        <div class="users-grid">
            @foreach (var user in _filteredUsers)
            {
                <div class="user-card" @onclick="@(() => ViewUser(user.Id))">
                    <!-- Status indicator -->
                    <div class="status-indicator @(user.IsActive ? "active" : "inactive")"></div>

                    <!-- Avatar -->
                    <div class="user-avatar">
                        @if (!string.IsNullOrWhiteSpace(user.AvatarUrl))
                        {
                            <MudAvatar Image="@user.AvatarUrl" Size="Size.Large" Class="avatar-img" />
                        }
                        else
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Large" Class="avatar-gradient">
                                <span class="avatar-initials">@user.Initials</span>
                            </MudAvatar>
                        }

                        <!-- Admin badge -->
                        @if (user.IsAdmin)
                        {
                            <div class="admin-badge">
                                <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" />
                            </div>
                        }
                    </div>

                    <!-- User info -->
                    <div class="user-info">
                        <h3 class="user-name">@user.DisplayName</h3>
                        <p class="user-username">@("@" + user.Username)</p>
                        <p class="user-email">@user.Email</p>
                    </div>

                    <!-- Tags -->
                    <div class="user-tags">
                        @if (user.IsAdmin)
                        {
                            <span class="tag tag-admin">Administrator</span>
                        }
                        @if (user.IsActive)
                        {
                            <span class="tag tag-active">Active</span>
                        }
                        else
                        {
                            <span class="tag tag-inactive">Inactive</span>
                        }
                    </div>

                    <!-- Actions -->
                    <div class="user-actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditUser(user.Id))"
                                       StopPropagation="true" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteUser(user))"
                                       Disabled="@user.IsAdmin"
                                       StopPropagation="true" />
                    </div>

                    <!-- Member since footer -->
                    <div class="user-footer">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                        <span>Member since @user.CreatedAtUtc.ToString("MMM yyyy")</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .page-container {
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin: 0;
    }

    .page-subtitle {
        color: #6c757d;
        margin: 4px 0 0 0;
    }

    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
        transition: all 0.3s ease !important;
    }

        .btn-gradient:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;
        }

    .search-bar {
        background: white;
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 24px;
        display: flex;
        gap: 16px;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .search-input {
        flex: 1;
        max-width: 400px;
    }

    .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .user-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

        .user-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

    .status-indicator {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

        .status-indicator.active {
            background: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .status-indicator.inactive {
            background: #6c757d;
        }

    .user-avatar {
        display: flex;
        justify-content: center;
        margin-bottom: 16px;
        position: relative;
    }

    .avatar-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .avatar-initials {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .avatar-img {
        border: 4px solid white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .admin-badge {
        position: absolute;
        bottom: 0;
        right: calc(50% - 50px);
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .user-info {
        text-align: center;
        margin-bottom: 16px;
    }

    .user-name {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 4px 0;
        color: #1a202c;
    }

    .user-username {
        color: #667eea;
        font-weight: 600;
        margin: 0 0 4px 0;
    }

    .user-email {
        color: #6c757d;
        font-size: 0.875rem;
        margin: 0;
    }

    .user-tags {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .tag {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .tag-admin {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .tag-active {
        background: #d1fae5;
        color: #065f46;
    }

    .tag-inactive {
        background: #e5e7eb;
        color: #6c757d;
    }

    .user-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
        padding: 12px 0;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }

    .user-footer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
        color: #6c757d;
        font-size: 0.875rem;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        padding: 60px 0;
    }
</style>

@code {
    private List<UserDto> _allUsers = new();
    private List<UserDto> _filteredUsers = new();
    private string _searchQuery = "";
    private bool _isLoading = true;
    private MudChip<string>? _filterChip;

    private int _activeCount => _allUsers.Count(u => u.IsActive);
    private int _inactiveCount => _allUsers.Count(u => !u.IsActive);
    private int _adminCount => _allUsers.Count(u => u.IsAdmin);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        _isLoading = true;
        StateHasChanged(); // Force UI update to show loading

        var result = await UserService.GetUsersAsync(1, 1000);
        if (result.IsSuccess && result.Value != null)
        {
            _allUsers = result.Value;
            FilterUsers();
        }
        _isLoading = false;
        StateHasChanged(); // Force UI update to hide loading
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchQuery = e.Value?.ToString() ?? "";
        FilterUsers();
    }

    private void FilterUsers()
    {
        var query = _allUsers.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            var search = _searchQuery.ToLower();
            query = query.Where(u =>
                u.DisplayName.ToLower().Contains(search) ||
                u.Username.ToLower().Contains(search) ||
                u.Email.ToLower().Contains(search));
        }

        // Filter by chip text
        if (_filterChip?.Text is string filter)
        {
            query = filter switch
            {
                "Active" => query.Where(u => u.IsActive),
                "Inactive" => query.Where(u => !u.IsActive),
                "Admins" => query.Where(u => u.IsAdmin),
                _ => query
            };
        }

        _filteredUsers = query.ToList();
    }

    private void ViewUser(Guid id) => Navigation.NavigateTo($"/users/{id}");
    private void EditUser(Guid id) => Navigation.NavigateTo($"/users/{id}/edit");

    private async Task DeleteUser(UserDto user)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Delete User",
            $"Delete {user.DisplayName}? This cannot be undone.",
            yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await UserService.DeleteUserAsync(user.Id);
            if (result.IsSuccess)
            {
                Snackbar.Add($"{user.DisplayName} deleted", Severity.Success);
                _allUsers.Remove(user);
                FilterUsers();
            }
            else
            {
                Snackbar.Add($"Failed: {result.Error}", Severity.Error);
            }
        }
    }
}