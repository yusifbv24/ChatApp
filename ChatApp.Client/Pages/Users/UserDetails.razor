@page "/users/{UserId:guid}"
@attribute [Authorize]
@inject IUserService UserService
@inject INotificationService Notification
@inject NavigationManager Navigation

<PageTitle>User Details - ChatApp</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_user == null)
    {
        <MudAlert Severity="Severity.Error">User not found</MudAlert>
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/users"))" Class="mt-4">
            Back to Users
        </MudButton>
    }
    else
    {
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">User Details</MudText>
            @if (_canUpdateUsers)
            {
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Edit"
                          OnClick="@(() => Navigation.NavigateTo($"/users/{UserId}/edit"))">
                    Edit User
                </MudButton>
            }
        </MudStack>

        <MudPaper Class="pa-6" Elevation="2">
            <MudGrid>
                <!-- Avatar and Basic Info -->
                <MudItem xs="12" Class="d-flex flex-column align-center mb-4">
                    @if (!string.IsNullOrWhiteSpace(_user.AvatarUrl))
                    {
                        <MudAvatar Image="@_user.AvatarUrl" Size="Size.Large" Style="width: 120px; height: 120px;" Class="mb-3" />
                    }
                    else
                    {
                        <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 120px; height: 120px;" Class="mb-3">
                            <MudText Typo="Typo.h3">@_user.Initials</MudText>
                        </MudAvatar>
                    }
                    <MudText Typo="Typo.h5">@_user.DisplayName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@@@_user.Username</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="mb-4" />
                </MudItem>

                <!-- User Information -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@_user.Email</MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                    <MudStack Row="true" Spacing="2" Class="mb-3">
                        @if (_user.IsActive)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default">Inactive</MudChip>
                        }

                        @if (_user.IsAdmin)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">System Administrator</MudChip>
                        }
                    </MudStack>
                </MudItem>

                @if (!string.IsNullOrWhiteSpace(_user.Notes))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Notes</MudText>
                        <MudText Typo="Typo.body1" Class="mb-3">@_user.Notes</MudText>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudDivider Class="my-4" />
                </MudItem>

                <!-- Metadata -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Member Since</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">
                        @_user.CreatedAtUtc.ToLocalTime().ToString("MMMM dd, yyyy")
                    </MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">User ID</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        @_user.Id
                    </MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Action Buttons -->
        <MudStack Row="true" Spacing="3" Class="mt-4">
            <MudButton Variant="Variant.Text"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.ArrowBack"
                      OnClick="@(() => Navigation.NavigateTo("/users"))">
                Back to Users
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid UserId { get; set; }

    private UserDto? _user;
    private bool _isLoading = true;
    private bool _canUpdateUsers = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserPermissions();
        await LoadUser();
    }

    private async Task LoadUserPermissions()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _canUpdateUsers = authState.User.HasClaim("permissions", Permissions.Users.Update);
    }

    private async Task LoadUser()
    {
        _isLoading = true;

        try
        {
            var result = await UserService.GetUserByIdAsync(UserId);

            if (result.IsSuccess)
            {
                _user = result.Value;
            }
            else
            {
                Notification.ShowError($"Failed to load user: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            Notification.ShowError($"Unexpected error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = null!;
}