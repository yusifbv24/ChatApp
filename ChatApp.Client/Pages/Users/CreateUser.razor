@page "/users/create"
@attribute [Authorize]
@inject IUserService UserService
@inject IRoleService RoleService
@inject INotificationService Notification
@inject NavigationManager Navigation

<PageTitle>Create User - ChatApp</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Create New User</MudText>

    <MudPaper Class="pa-6" Elevation="2">
        <MudForm @ref="_form" @bind-IsValid="_isFormValid">
            <MudGrid>
                <!-- Username -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Username"
                                 Label="Username"
                                 Required="true"
                                 RequiredError="Username is required"
                                 Variant="Variant.Outlined"
                                 HelperText="Unique username for login (cannot be changed later)" />
                </MudItem>

                <!-- Email -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Email"
                                 Label="Email"
                                 Required="true"
                                 RequiredError="Email is required"
                                 Validation="@(new Func<string, string?>(ValidateEmail))"
                                 Variant="Variant.Outlined"
                                 HelperText="Valid email address" />
                </MudItem>

                <!-- Display Name -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DisplayName"
                                 Label="Display Name"
                                 Required="true"
                                 RequiredError="Display name is required"
                                 Variant="Variant.Outlined"
                                 HelperText="Friendly name shown in the UI" />
                </MudItem>

                <!-- Avatar URL -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.AvatarUrl"
                                 Label="Avatar URL"
                                 Variant="Variant.Outlined"
                                 HelperText="URL to profile picture (optional)" />
                </MudItem>

                <!-- Password -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Password"
                                 Label="Password"
                                 InputType="@_passwordInput"
                                 Required="true"
                                 RequiredError="Password is required"
                                 Validation="@(new Func<string, string?>(ValidatePassword))"
                                 Variant="Variant.Outlined"
                                 Adornment="Adornment.End"
                                 AdornmentIcon="@_passwordIcon"
                                 OnAdornmentClick="TogglePasswordVisibility"
                                 HelperText="Min 8 chars, uppercase, lowercase, number, special char" />
                </MudItem>

                <!-- Confirm Password -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_confirmPassword"
                                 Label="Confirm Password"
                                 InputType="@_passwordInput"
                                 Required="true"
                                 RequiredError="Please confirm password"
                                 Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                                 Variant="Variant.Outlined"
                                 HelperText="Must match password" />
                </MudItem>

                <!-- Notes -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Notes"
                                 Label="Notes"
                                 Lines="3"
                                 Variant="Variant.Outlined"
                                 HelperText="Optional notes about the user (max 1000 characters)" />
                </MudItem>

                <!-- Is Admin Checkbox -->
                <MudItem xs="12">
                    <MudCheckBox T="bool" @bind-Checked="_model.IsAdmin"
                                Label="System Administrator"
                                Color="Color.Error">
                        <MudText Typo="Typo.caption" Color="Color.Error">
                            Warning: Admin users have full access to all system features
                        </MudText>
                    </MudCheckBox>
                </MudItem>

                <!-- Error Message -->
                @if (!string.IsNullOrWhiteSpace(_errorMessage))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
                    </MudItem>
                }

                <!-- Action Buttons -->
                <MudItem xs="12">
                    <MudStack Row="true" Spacing="3" Class="mt-4">
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  Disabled="@(!_isFormValid || _isSaving)"
                                  OnClick="HandleSubmit">
                            @if (_isSaving)
                            {
                                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                <MudText>Creating...</MudText>
                            }
                            else
                            {
                                <MudText>Create User</MudText>
                            }
                        </MudButton>

                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Default"
                                  OnClick="Cancel"
                                  Disabled="_isSaving">
                            Cancel
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    // Form references
    private MudForm _form = null!;
    private bool _isFormValid;

    // Model
    private CreateUserRequestModel _model = new();
    private string _confirmPassword = string.Empty;

    // UI State
    private bool _isSaving = false;
    private string _errorMessage = string.Empty;

    // Password visibility toggle
    private bool _passwordVisible = false;
    private InputType _passwordInput = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    /// <summary>
    /// Internal model class that matches CreateUserRequest but allows property assignment
    /// </summary>
    private record CreateUserRequestModel
    {
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? AvatarUrl { get; set; }
        public string? Notes { get; set; }
        public bool IsAdmin { get; set; }
    }

    /// <summary>
    /// Toggle password visibility
    /// </summary>
    private void TogglePasswordVisibility()
    {
        if (_passwordVisible)
        {
            _passwordVisible = false;
            _passwordInput = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordVisible = true;
            _passwordInput = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
    }

    /// <summary>
    /// Validate email format
    /// </summary>
    private string? ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "Email is required";

        // Simple email validation
        if (!email.Contains("@") || !email.Contains("."))
            return "Invalid email format";

        return null;
    }

    /// <summary>
    /// Validate password strength
    /// Must match backend requirements: min 8 chars, uppercase, lowercase, number, special char
    /// </summary>
    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";

        if (password.Length < 8)
            return "Password must be at least 8 characters";

        if (!password.Any(char.IsUpper))
            return "Password must contain at least one uppercase letter";

        if (!password.Any(char.IsLower))
            return "Password must contain at least one lowercase letter";

        if (!password.Any(char.IsDigit))
            return "Password must contain at least one number";

        if (!password.Any(ch => !char.IsLetterOrDigit(ch)))
            return "Password must contain at least one special character";

        return null;
    }

    /// <summary>
    /// Validate confirm password matches
    /// </summary>
    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "Please confirm password";

        if (confirmPassword != _model.Password)
            return "Passwords do not match";

        return null;
    }

    /// <summary>
    /// Handle form submission
    /// </summary>
    private async Task HandleSubmit()
    {
        _errorMessage = string.Empty;

        // Validate form
        await _form.Validate();

        if (!_isFormValid)
            return;

        _isSaving = true;

        try
        {
            // Create request object
            var request = new CreateUserRequest
            {
                Username = _model.Username.Trim(),
                Email = _model.Email.Trim(),
                Password = _model.Password,
                DisplayName = _model.DisplayName.Trim(),
                AvatarUrl = string.IsNullOrWhiteSpace(_model.AvatarUrl) ? null : _model.AvatarUrl.Trim(),
                Notes = string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes.Trim(),
                IsAdmin = _model.IsAdmin
            };

            // Call API
            var result = await UserService.CreateUserAsync(request);

            if (result.IsSuccess)
            {
                Notification.ShowSuccess($"User '{_model.DisplayName}' created successfully");
                
                // Navigate to user list
                Navigation.NavigateTo("/users");
            }
            else
            {
                _errorMessage = result.Error;
                Notification.ShowError($"Failed to create user: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            Notification.ShowError(_errorMessage);
        }
        finally
        {
            _isSaving = false;
        }
    }

    /// <summary>
    /// Cancel and return to user list
    /// </summary>
    private void Cancel()
    {
        Navigation.NavigateTo("/users");
    }
}
