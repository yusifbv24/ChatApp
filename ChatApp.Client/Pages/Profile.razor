@page "/profile"
@attribute [Authorize]
@inject IUserService UserService
@inject INotificationService Notification
@inject AppState AppState

<PageTitle>My Profile - ChatApp</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">My Profile</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_user == null)
    {
        <MudAlert Severity="Severity.Error">Failed to load profile</MudAlert>
    }
    else
    {
        <!--
            MUDBLAZOR TABS
            ==============
            MudTabs creates a tabbed interface.
            Each MudTabPanel represents one tab.
            User can switch between Profile Info and Security (password change)
        -->
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <!-- Profile Information Tab -->
            <MudTabPanel Text="Profile Information" Icon="@Icons.Material.Filled.Person">
                <MudForm @ref="_profileForm" @bind-IsValid="_isProfileFormValid">
                    <MudGrid>
                        <!-- Avatar Preview -->
                        <MudItem xs="12" Class="d-flex justify-center mb-4">
                            @if (!string.IsNullOrWhiteSpace(_profileModel.AvatarUrl))
                            {
                                <MudAvatar Image="@_profileModel.AvatarUrl" Size="Size.Large" Style="width: 120px; height: 120px;" />
                            }
                            else
                            {
                                <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 120px; height: 120px;">
                                    <MudText Typo="Typo.h3">@_user.Initials</MudText>
                                </MudAvatar>
                            }
                        </MudItem>

                        <!-- Username (Read-only) -->
                        <MudItem xs="12" md="6">
                            <MudTextField Value="@_user.Username"
                                          Label="Username"
                                          ReadOnly="true"
                                          Variant="Variant.Outlined"
                                          HelperText="Username cannot be changed" />
                        </MudItem>

                        <!-- Email -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_profileModel.Email"
                                          Label="Email"
                                          Validation="@(new Func<string, string?>(ValidateEmail))"
                                          Variant="Variant.Outlined" />
                        </MudItem>

                        <!-- Display Name -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_profileModel.DisplayName"
                                          Label="Display Name"
                                          Validation="@(new Func<string, string?>(ValidateDisplayName))"
                                          Variant="Variant.Outlined" />
                        </MudItem>

                        <!-- Avatar URL -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_profileModel.AvatarUrl"
                                          Label="Avatar URL"
                                          Variant="Variant.Outlined"
                                          HelperText="URL to your profile picture" />
                        </MudItem>

                        <!-- Notes -->
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_profileModel.Notes"
                                          Label="About Me"
                                          Lines="4"
                                          Variant="Variant.Outlined"
                                          HelperText="Tell others about yourself" />
                        </MudItem>

                        <!-- Profile Error Message -->
                        @if (!string.IsNullOrWhiteSpace(_profileErrorMessage))
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Error">@_profileErrorMessage</MudAlert>
                            </MudItem>
                        }

                        <!-- Profile Action Buttons -->
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(!_isProfileFormValid || _isSavingProfile)"
                                       OnClick="SaveProfile">
                                @if (_isSavingProfile)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                    <MudText>Saving...</MudText>
                                }
                                else
                                {
                                    <MudText>Save Changes</MudText>
                                }
                            </MudButton>
                        </MudItem>

                        <!-- Account Info -->
                        <MudItem xs="12">
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                                Member since: @_user.CreatedAtUtc.ToLocalTime().ToString("MMMM dd, yyyy")
                            </MudText>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudTabPanel>

            <!-- Security Tab (Change Password) -->
            <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Security">
                <MudForm @ref="_passwordForm" @bind-IsValid="_isPasswordFormValid">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-4">Change Password</MudText>
                        </MudItem>

                        <!-- Current Password -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_passwordModel.CurrentPassword"
                                          Label="Current Password"
                                          InputType="@_passwordInput"
                                          Required="true"
                                          RequiredError="Current password is required"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@_passwordIcon"
                                          OnAdornmentClick="TogglePasswordVisibility" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <!-- Spacer for layout -->
                        </MudItem>

                        <!-- New Password -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_passwordModel.NewPassword"
                                          Label="New Password"
                                          InputType="@_passwordInput"
                                          Required="true"
                                          RequiredError="New password is required"
                                          Validation="@(new Func<string, string?>(ValidatePassword))"
                                          Variant="Variant.Outlined"
                                          HelperText="Min 8 chars, uppercase, lowercase, number, special char" />
                        </MudItem>

                        <!-- Confirm New Password -->
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_passwordModel.ConfirmNewPassword"
                                          Label="Confirm New Password"
                                          InputType="@_passwordInput"
                                          Required="true"
                                          RequiredError="Please confirm new password"
                                          Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                                          Variant="Variant.Outlined"
                                          HelperText="Must match new password" />
                        </MudItem>

                        <!-- Password Error Message -->
                        @if (!string.IsNullOrWhiteSpace(_passwordErrorMessage))
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Error">@_passwordErrorMessage</MudAlert>
                            </MudItem>
                        }

                        <!-- Password Action Button -->
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(!_isPasswordFormValid || _isChangingPassword)"
                                       OnClick="ChangePassword">
                                @if (_isChangingPassword)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                    <MudText>Changing Password...</MudText>
                                }
                                else
                                {
                                    <MudText>Change Password</MudText>
                                }
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    // User data
    private UserDto? _user;

    // Profile form
    private MudForm _profileForm = null!;
    private bool _isProfileFormValid;
    private ProfileModel _profileModel = new();
    private bool _isSavingProfile = false;
    private string _profileErrorMessage = string.Empty;

    // Password form
    private MudForm _passwordForm = null!;
    private bool _isPasswordFormValid;
    private PasswordChangeModel _passwordModel = new();
    private bool _isChangingPassword = false;
    private string _passwordErrorMessage = string.Empty;

    // UI State
    private bool _isLoading = true;

    // Password visibility
    private bool _passwordVisible = false;
    private InputType _passwordInput = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private class ProfileModel
    {
        public string? Email { get; set; }
        public string? DisplayName { get; set; }
        public string? AvatarUrl { get; set; }
        public string? Notes { get; set; }
    }

    private class PasswordChangeModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        _isLoading = true;

        try
        {
            var result = await UserService.GetCurrentUserAsync();

            if (result.IsSuccess && result.Value != null)
            {
                _user = result.Value;
                AppState.CurrentUser = _user;

                // Populate form
                _profileModel.Email = _user.Email;
                _profileModel.DisplayName = _user.DisplayName;
                _profileModel.AvatarUrl = _user.AvatarUrl;
                _profileModel.Notes = _user.Notes;
            }
            else
            {
                Notification.ShowError($"Failed to load profile: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            Notification.ShowError($"Unexpected error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        if (_passwordVisible)
        {
            _passwordVisible = false;
            _passwordInput = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
        else
        {
            _passwordVisible = true;
            _passwordInput = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
    }

    private string? ValidateEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return null;

        if (!email.Contains("@") || !email.Contains("."))
            return "Invalid email format";

        return null;
    }

    private string? ValidateDisplayName(string? displayName)
    {
        if (string.IsNullOrWhiteSpace(displayName))
            return null;

        if (displayName.Length < 2)
            return "Display name must be at least 2 characters";

        if (displayName.Length > 100)
            return "Display name must not exceed 100 characters";

        return null;
    }

    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";

        if (password.Length < 8)
            return "Password must be at least 8 characters";

        if (!password.Any(char.IsUpper))
            return "Password must contain at least one uppercase letter";

        if (!password.Any(char.IsLower))
            return "Password must contain at least one lowercase letter";

        if (!password.Any(char.IsDigit))
            return "Password must contain at least one number";

        if (!password.Any(ch => !char.IsLetterOrDigit(ch)))
            return "Password must contain at least one special character";

        return null;
    }

    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "Please confirm password";

        if (confirmPassword != _passwordModel.NewPassword)
            return "Passwords do not match";

        return null;
    }

    private async Task SaveProfile()
    {
        _profileErrorMessage = string.Empty;

        await _profileForm.Validate();

        if (!_isProfileFormValid)
            return;

        _isSavingProfile = true;

        try
        {
            var request = new UpdateUserRequest
            {
                Email = _profileModel.Email != _user!.Email ? _profileModel.Email : null,
                DisplayName = _profileModel.DisplayName != _user.DisplayName ? _profileModel.DisplayName : null,
                AvatarUrl = _profileModel.AvatarUrl != _user.AvatarUrl ? _profileModel.AvatarUrl : null,
                Notes = _profileModel.Notes != _user.Notes ? _profileModel.Notes : null
            };

            var result = await UserService.UpdateCurrentUserAsync(request);

            if (result.IsSuccess)
            {
                Notification.ShowSuccess("Profile updated successfully");
                await LoadProfile();
            }
            else
            {
                _profileErrorMessage = result.Error;
                Notification.ShowError($"Failed to update profile: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            _profileErrorMessage = $"Unexpected error: {ex.Message}";
            Notification.ShowError(_profileErrorMessage);
        }
        finally
        {
            _isSavingProfile = false;
        }
    }

    private async Task ChangePassword()
    {
        _passwordErrorMessage = string.Empty;

        await _passwordForm.Validate();

        if (!_isPasswordFormValid)
            return;

        _isChangingPassword = true;

        try
        {
            var request = new ChangePasswordRequest
            {
                CurrentPassword = _passwordModel.CurrentPassword,
                NewPassword = _passwordModel.NewPassword,
                ConfirmNewPassword = _passwordModel.ConfirmNewPassword
            };

            var result = await UserService.ChangePasswordAsync(request);

            if (result.IsSuccess)
            {
                Notification.ShowSuccess("Password changed successfully");

                // Clear password fields
                _passwordModel = new PasswordChangeModel();
                await _passwordForm.ResetAsync();
            }
            else
            {
                _passwordErrorMessage = result.Error;
                Notification.ShowError($"Failed to change password: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            _passwordErrorMessage = $"Unexpected error: {ex.Message}";
            Notification.ShowError(_passwordErrorMessage);
        }
        finally
        {
            _isChangingPassword = false;
        }
    }
}